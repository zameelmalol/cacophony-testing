Array.prototype.deleteFirst=function(d){for(var e=0;e<this.length;e++){if(this[e]==d){this.splice(e,1);return true}}return false};Array.prototype.stableSort=function(d){for(var e=0;e<this.length;e++){this[e].__arrayPos=e}return this.sort(Array.__stableSorter(d))};Array.__stableSorter=function(b){return(function(g,a){var e=b(g,a);if(!e){return g.__arrayPos-a.__arrayPos}return e})};Array.prototype.equals=function(a){if(!a){return false}if(this.length!=a.length){return false}for(var b=0;b<this.length;b++){var g=this[b];var h=a[b];if(g.equals&&typeof(g.equals)=="function"){if(!g.equals(h)){return false}}else{if(g!=h){return false}}}return true};Array.prototype.rotate=function(b){if(b){this.unshift(this.pop());return this[0]}else{this.push(this.shift());return this[this.length-1]}};Array.prototype.pick=function(){return this[Math.floor(Math.random()*this.length)]};Array.prototype.flatten=function(){var k=[];for(var h=0;h<this.length;h++){var e=this[h];if(e.flatten){var a=e.flatten();for(var j=0;j<a.length;j++){k[k.length]=a[j]}}else{k[k.length]=e}}return k};Array.prototype.take=function(){var a=[];for(var g=0;g<this.length;g++){var e=[];for(var h=0;h<arguments.length;h++){e[h]=this[g][arguments[h]]}a[g]=e}return a};if(!Array.prototype.pluck){Array.prototype.pluck=function(e){var a=[];for(var g=0;g<this.length;g++){a[g]=this[g][e]}return a}}Array.prototype.set=function(d,g){for(var e=0;e<this.length;e++){this[e][d]=g}};Array.prototype.allWith=function(){var a=[];topLoop:for(var g=0;g<this.length;g++){var e=this[g];for(var h=0;h<arguments.length;h++){if(!this[g][arguments[h]]){continue topLoop}}a[a.length]=e}return a};if(!Function.prototype.bind){Function.prototype.bind=function(e){var d=this;return function(){return d.apply(e,arguments)}}}if(!Array.prototype.last){Array.prototype.last=function(){return this[this.length-1]}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(d){for(var e=0;e<this.length;e++){if(d==this[e]){return e}}return -1}}if(!Array.prototype.includes){Array.prototype.includes=function(b){return(this.indexOf(b)>=0)}}Array.prototype.map=function(g){var e=new Array(this.length);if(g){for(var d=0;d<this.length;d++){e[d]=g(this[d],d,this)}}else{for(var d=0;d<this.length;d++){e[d]=this[d]}}return e};Array.prototype.forEach=function(d){for(var e=0;e<this.length;e++){d(this[e],e,this)}};if(!Array.prototype.reduce){Array.prototype.reduce=function(g,d){var e=0;if(arguments.length==1){d=this[0];e++}for(;e<this.length;e++){d=g(d,this[e],e,this)}return d}}if(!Array.prototype.find){Array.prototype.find=function(d){for(var e=0;e<this.length;e++){if(d(this[e],e,this)){return this[e]}}}}if(!String.prototype.capitalize){String.prototype.capitalize=function(){return this.replace(/^./,this.slice(0,1).toUpperCase())}}if(!String.prototype.escape){String.prototype.escape=function(){return'"'+this.replace(/"/g,'\\"')+'"'}}if(!String.prototype.splice){String.prototype.splice=function(g,d,e){return this.slice(0,g)+e+this.slice(g+d)}}if(!String.prototype.strip){String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"")}}if(!window["$A"]){$A=function(e){var a=new Array(e.length);for(var g=0;g<e.length;g++){a[g]=e[g]}return a}}if(!window["$"]){$=function(b){return document.getElementById(b)}}if(!Math.sinh){Math.sinh=function(b){return 0.5*(Math.exp(b)-Math.exp(-b))};Math.asinh=function(b){return Math.log(b+Math.sqrt(b*b+1))}}if(!Math.cosh){Math.cosh=function(b){return 0.5*(Math.exp(b)+Math.exp(-b))};Math.acosh=function(b){return Math.log(b+Math.sqrt(b*b-1))}}E=function(g,j,h){var k=document.createElement(g);if(j){if(typeof(j)=="string"){k.innerHTML=j;j=h}else{if(j.DOCUMENT_NODE){k.appendChild(j);j=h}}if(j){if(j.style){var l=j.style;j=Object.clone(j);delete j.style;Object.forceExtend(k.style,l)}if(j.content){if(typeof(j.content)=="string"){k.appendChild(T(j.content))}else{k.appendChild(j.content)}j=Object.clone(j);delete j.content}Object.forceExtend(k,j)}}return k};E.append=function(d){for(var e=1;e<arguments.length;e++){if(typeof(arguments[e])=="string"){d.appendChild(T(arguments[e]))}else{d.appendChild(arguments[e])}}};E.lastCanvasId=0;E.canvas=function(g,j,e){var h="canvas-uuid-"+E.lastCanvasId;E.lastCanvasId++;if(!e){e={}}return E("canvas",Object.extend(e,{id:h,width:g,height:j}))};T=function(b){return document.createTextNode(b)};Object.forceExtend=function(h,j){for(var g in j){try{h[g]=j[g]}catch(e){}}return h};if(!Object.extend){Object.extend=Object.forceExtend}Object.conditionalExtend=function(g,d){for(var e in d){if(g[e]==null){g[e]=d[e]}}return g};Object.clone=function(src){if(!src||src==true){return src}switch(typeof(src)){case"string":return Object.extend(src+"",src);break;case"number":return src;break;case"function":obj=eval(src.toSource());return Object.extend(obj,src);break;case"object":if(src instanceof Array){return Object.extend([],src)}else{return Object.extend({},src)}break}};Object.loadImage=function(g,d){var e=new Image();if(d){e.onload=d}e.src=g;return e};Object.isImageLoaded=function(b){if(b.tagName=="CANVAS"){return true}if(!b.complete){return false}if(b.naturalWidth==null){return true}return !!b.naturalWidth};Object.sum=function(g,h){if(g instanceof Array){if(h instanceof Array){var a=[];for(var b=0;b<g.length;b++){a[b]=g[b]+h[b]}return a}else{return g.map(function(d){return d+h})}}else{if(h instanceof Array){return h.map(function(d){return d+g})}else{return g+h}}};Object.sub=function(g,h){if(g instanceof Array){if(h instanceof Array){var a=[];for(var b=0;b<g.length;b++){a[b]=g[b]-h[b]}return a}else{return g.map(function(d){return d-h})}}else{if(h instanceof Array){return h.map(function(d){return g-d})}else{return g-h}}};if(!window.Mouse){Mouse={}}Mouse.getRelativeCoords=function(h,m){var k={x:0,y:0};var l=0;var j=0;var g=h;while(g){l+=g.offsetLeft;j+=g.offsetTop;g=g.offsetParent}k.x=m.pageX-l;k.y=m.pageY-j;return k};Browser=(function(){var g=window.navigator.userAgent;var l=g.match(/KHTML/);var j=g.match(/Gecko/);var h=g.match(/WebKit\/\d+/);var k=g.match(/Explorer/);if(l){return"KHTML"}if(j){return"Gecko"}if(h){return"Webkit"}if(k){return"IE"}return"UNKNOWN"})();Mouse.LEFT=0;Mouse.MIDDLE=1;Mouse.RIGHT=2;if(Browser=="IE"){Mouse.LEFT=1;Mouse.MIDDLE=4}Klass=function(){var g=function(){this.initialize.apply(this,arguments)};g.ancestors=$A(arguments);g.prototype={};for(var h=0;h<arguments.length;h++){var a=arguments[h];if(a.prototype){Object.extend(g.prototype,a.prototype)}else{Object.extend(g.prototype,a)}}Object.extend(g,g.prototype);return g};Curves={angularDistance:function(d,h){var b=Math.PI*2;var a=(h-d)%b;if(a>Math.PI){a-=b}if(a<-Math.PI){a+=b}return a},linePoint:function(b,g,a){return[b[0]+(g[0]-b[0])*a,b[1]+(g[1]-b[1])*a]},quadraticPoint:function(p,q,t,n){var a=p[0]+(q[0]-p[0])*n;var u=q[0]+(t[0]-q[0])*n;var o=a+(u-a)*n;var b=p[1]+(q[1]-p[1])*n;var w=q[1]+(t[1]-q[1])*n;var s=b+(w-b)*n;return[o,s]},cubicPoint:function(d,q,s,t,b){var A=d[0]*3;var w=q[0]*3;var u=s[0]*3;var p=d[1]*3;var a=q[1]*3;var z=s[1]*3;return[d[0]+b*(w-A+b*(A-2*w+u+b*(w-d[0]-u+t[0]))),d[1]+b*(a-p+b*(p-2*a+z+b*(a-d[1]-z+t[1])))]},linearValue:function(b,g,a){return b+(g-b)*a},quadraticValue:function(l,m,a,e){var b=l+(m-l)*e;var d=m+(a-m)*e;return b+(d-b)*e},cubicValue:function(o,q,a,d,m){var b=o*3,p=q*3,n=a*3;return o+m*(p-b+m*(b-2*p+n+m*(p-o-n+d)))},catmullRomPoint:function(d,o,p,q,a){var b=((-a+2)*a-1)*a*0.5;var s=(((3*a-5)*a)*a+2)*0.5;var t=((-3*a+4)*a+1)*a*0.5;var n=((a-1)*a*a)*0.5;return[d[0]*b+o[0]*s+p[0]*t+q[0]*n,d[1]*b+o[1]*s+p[1]*t+q[1]*n]},catmullRomAngle:function(m,o,a,b,d){var l=0.5*(a[0]-m[0]+2*d*(2*m[0]-5*o[0]+4*a[0]-b[0])+3*d*d*(3*o[0]+b[0]-m[0]-3*a[0]));var n=0.5*(a[1]-m[1]+2*d*(2*m[1]-5*o[1]+4*a[1]-b[1])+3*d*d*(3*o[1]+b[1]-m[1]-3*a[1]));return Math.atan2(n,l)},catmullRomPointAngle:function(l,m,a,b,k){var d=this.catmullRomPoint(l,m,a,b,k);var l=this.catmullRomAngle(l,m,a,b,k);return{point:d,angle:l}},lineAngle:function(a,b){return Math.atan2(b[1]-a[1],b[0]-a[0])},quadraticAngle:function(l,m,a,e){var b=this.linePoint(l,m,e);var d=this.linePoint(m,a,e);return this.lineAngle(b,d)},cubicAngle:function(o,p,a,b,n){var d=this.quadraticPoint(o,p,a,n);var e=this.quadraticPoint(p,a,b,n);return this.lineAngle(d,e)},lineLength:function(b,g){var h=(g[0]-b[0]);var a=(g[1]-b[1]);return Math.sqrt(h*h+a*a)},squareLineLength:function(b,g){var h=(g[0]-b[0]);var a=(g[1]-b[1]);return h*h+a*a},quadraticLength:function(l,m,a,k){var b=this.linePoint(l,m,2/3);var j=this.linePoint(m,a,1/3);return this.cubicLength(l,b,j,a,k)},cubicLength:(function(){var e=function(m){var b=[m.slice(0)];for(var j=1;j<4;j++){b[j]=[[],[],[],[]];for(var l=0;l<4-j;l++){b[j][l][0]=0.5*(b[j-1][l][0]+b[j-1][l+1][0]);b[j][l][1]=0.5*(b[j-1][l][1]+b[j-1][l+1][1])}}var a=[];var k=[];for(var l=0;l<4;l++){a[l]=b[l][0];k[l]=b[3-l][l]}return[a,k]};var d=function(k,j){var m=0;for(var b=0;b<3;b++){m+=Curves.lineLength(k[b],k[b+1])}var a=Curves.lineLength(k[0],k[3]);if((m-a)>j){var l=e(k);m=d(l[0],j)+d(l[1],j)}return m};return function(k,l,a,b,j){if(!j){j=1}return d([k,l,a,b],j)}})(),quadraticLengthPointAngle:function(m,n,a,o,l){var b=this.linePoint(m,n,2/3);var k=this.linePoint(n,a,1/3);return this.cubicLengthPointAngle(m,b,k,a,l)},cubicLengthPointAngle:function(a,b,d,A,M,F){var B=this.cubicLength(a,b,d,A,F);var G=a;var K=a;var N=[];var J=0;var P=0;var O=M*B;var H=20;var L=1/H;for(var C=1;C<=H;C++){K=G;G=this.cubicPoint(a,b,d,A,L*C);J=P;P+=this.lineLength(K,G);if(P>=O){if(P==J){return{point:G,angle:this.lineAngle(a,b)}}var D=P-O;var I=D/(P-J);return{point:this.linePoint(K,G,1-I),angle:this.cubicAngle(a,b,d,A,L*(C-I))}}}return{point:A.slice(0),angle:this.lineAngle(d,A)}}};Colors={hsl2rgb:function(l,B,q){var A,h,b;if(B==0){A=h=b=v}else{var z=(q<0.5?q*(1+B):q+B-(q*B));var w=2*q-z;var s=(l%360)/360;var g=s+1/3;var u=s;var p=s-1/3;if(g<0){g++}if(g>1){g--}if(u<0){u++}if(u>1){u--}if(p<0){p++}if(p>1){p--}if(g<1/6){A=w+((z-w)*6*g)}else{if(g<1/2){A=z}else{if(g<2/3){A=w+((z-w)*6*(2/3-g))}else{A=w}}}if(u<1/6){h=w+((z-w)*6*u)}else{if(u<1/2){h=z}else{if(u<2/3){h=w+((z-w)*6*(2/3-u))}else{h=w}}}if(p<1/6){b=w+((z-w)*6*p)}else{if(p<1/2){b=z}else{if(p<2/3){b=w+((z-w)*6*(2/3-p))}else{b=w}}}}return[A,h,b]},hsv2rgb:function(s,B,g){var A,q,h;if(B==0){A=q=h=g}else{s=(s%360)/60;var t=Math.floor(s);var p=s-t;var w=g*(1-B);var z=g*(1-B*p);var b=g*(1-B*(1-p));switch(t){case 0:A=g;q=b;h=w;break;case 1:A=z;q=g;h=w;break;case 2:A=w;q=g;h=b;break;case 3:A=w;q=z;h=g;break;case 4:A=b;q=w;h=g;break;case 5:A=g;q=w;h=z;break}}return[A,q,h]},parseColorStyle:function(d,e){if(typeof d=="string"){return d}else{if(d.compiled){return d.compiled}else{if(d.isPattern){return d.compile(e)}else{if(d.length==3){return"rgba("+d.map(Math.round).join(",")+", 1)"}else{if(d.length==4){return"rgba("+Math.round(d[0])+","+Math.round(d[1])+","+Math.round(d[2])+","+d[3]+")"}else{throw ("Bad style: "+d)}}}}}}};CanvasSupport={DEVICE_SPACE:0,USER_SPACE:1,isPointInPathMode:null,supportsIsPointInPath:null,supportsCSSTransform:null,supportsCanvas:null,isCanvasSupported:function(){if(this.supportsCanvas==null){var d={};try{d=E("canvas")}catch(e){}this.supportsCanvas=(d.getContext!=null)}return this.supportsCanvas},isCSSTransformSupported:function(){if(this.supportsCSSTransform==null){var d=E("div");var g=d.style;var e=(g.webkitTransform!=null||g.MozTransform!=null);this.supportsCSSTransform=(e!=null)}return this.supportsCSSTransform},getTestContext:function(){if(!this.testContext){var b=E.canvas(1,1);this.testContext=b.getContext("2d")}return this.testContext},getSupportsAudioTag:function(){var b=E("audio");return !!b.play},getSupportsSoundManager:function(){return(window.soundManager&&soundManager.enabled)},soundId:0,getSoundObject:function(){var b=null;if(this.getSupportsSoundManager()){b=this.getSoundManagerSoundObject()}return b},getAudioTagSoundObject:function(){var e="sound-"+this.soundId++;var d=E("audio",{id:e});d.load=function(a){this.src=a};d.addEventListener("canplaythrough",function(){if(this.onready){this.onready()}},false);d.setVolume=function(a){this.volume=a};d.setPan=function(a){this.pan=a};return d},getSoundManagerSoundObject:function(){var e="sound-"+this.soundId++;var d={volume:100,pan:0,sid:e,load:function(a){return soundManager.load(this.sid,{url:a,autoPlay:false,volume:this.volume,pan:this.pan})},_onload:function(){if(this.onload){this.onload()}if(this.onready){this.onready()}},_onerror:function(){if(this.onerror){this.onerror()}},_onfinish:function(){if(this.onfinish){this.onfinish()}},play:function(){return soundManager.play(this.sid)},stop:function(){return soundManager.stop(this.sid)},pause:function(){return soundManager.togglePause(this.sid)},setVolume:function(a){this.volume=a*100;return soundManager.setVolume(this.sid,a*100)},setPan:function(a){this.pan=a*100;return soundManager.setPan(this.sid,a*100)}};soundManager.createSound(e,"null.mp3");d.sound=soundManager.getSoundById(e);d.sound.options.onfinish=d._onfinish.bind(d);d.sound.options.onload=d._onload.bind(d);d.sound.options.onerror=d._onerror.bind(d);return d},ContextSetterAugment:{setFillStyle:function(b){this.fillStyle=b},setStrokeStyle:function(b){this.strokeStyle=b},setGlobalAlpha:function(b){this.globalAlpha=b},setLineWidth:function(b){this.lineWidth=b},setLineCap:function(b){this.lineCap=b},setLineJoin:function(b){this.lineJoin=b},setMiterLimit:function(b){this.miterLimit=b},setGlobalCompositeOperation:function(b){this.globalCompositeOperation=b},setShadowColor:function(b){this.shadowColor=b},setShadowBlur:function(b){this.shadowBlur=b},setShadowOffsetX:function(b){this.shadowOffsetX=b},setShadowOffsetY:function(b){this.shadowOffsetY=b},setMozTextStyle:function(b){this.mozTextStyle=b},setFont:function(b){this.font=b},setTextAlign:function(b){this.textAlign=b},setTextBaseline:function(b){this.textBaseline=b}},ContextJSImplAugment:{identity:function(){CanvasSupport.setTransform(this,[1,0,0,1,0,0])}},augment:function(b){Object.conditionalExtend(b,this.ContextSetterAugment);Object.conditionalExtend(b,this.ContextJSImplAugment);return b},getContext:function(d,g){var e=d.getContext(g||"2d");this.augment(e);return e},tMatrixMultiply:function(p,q){var n=p[0]*q[0]+p[2]*q[1];var o=p[1]*q[0]+p[3]*q[1];var l=p[0]*q[2]+p[2]*q[3];var m=p[1]*q[2]+p[3]*q[3];var j=p[0]*q[4]+p[2]*q[5]+p[4];var k=p[1]*q[4]+p[3]*q[5]+p[5];p[0]=n;p[1]=o;p[2]=l;p[3]=m;p[4]=j;p[5]=k;return p},tMatrixMultiplyPoint:function(d,e,g){return[e*d[0]+g*d[2]+d[4],e*d[1]+g*d[3]+d[5]]},tInvertMatrix:function(e){var d=1/(e[0]*e[3]-e[1]*e[2]);return[e[3]*d,-e[1]*d,-e[2]*d,e[0]*d,d*(e[2]*e[5]-e[3]*e[4]),d*(e[1]*e[4]-e[0]*e[5])]},transform:function(d,e){if(d.transform){return d.transform.apply(d,e)}d.translate(e[4],e[5]);if(Math.abs(e[1])<0.000001&&Math.abs(e[2])<0.000001){d.scale(e[0],e[3]);return}var g=this.svdTransform({xx:e[0],xy:e[2],yx:e[1],yy:e[3],dx:e[4],dy:e[5]});d.rotate(g.angle2);d.scale(g.sx,g.sy);d.rotate(g.angle1);return},brokenSvd:function(I){var M=[I[0],I[2],I[1],I[3],0,0];var S=[M[0]*I[0]+M[2]*I[1],M[1]*I[0]+M[3]*I[1],M[0]*I[2]+M[2]*I[3],M[1]*I[2]+M[3]*I[3],0,0];var u=1;var H=-(S[0]+S[3]);var a=-(S[1]*S[2])+(S[0]*S[3]);var b=Math.sqrt(H*H-4*u*a);var K=(-H+b)/(2*u);var N=(-H-b)/(2*u);if(K<N){var L=K,K=N,N=L}var U=Math.sqrt(K);var V=Math.sqrt(N);var d=[1/U,0,0,1/V,0,0];var l=((S[0]-K)/S[2]);var m=Math.sqrt(1+l*l);var O=1/m;var e=l/m;var J=O;var P=-e;var R=[O,P,e,J,0,0];var Q=I.slice(0);this.tMatrixMultiply(Q,R);this.tMatrixMultiply(Q,d);return[Q,[U,0,0,V,0,0],[O,e,P,J,0,0]]},svdTransform:(function(){var j={};j.Matrix2D=function(d){if(d){if(typeof d=="number"){this.xx=this.yy=d}else{if(d instanceof Array){if(d.length>0){var a=j.normalize(d[0]);for(var g=1;g<d.length;++g){var b=a,e=j.normalize(d[g]);a=new j.Matrix2D();a.xx=b.xx*e.xx+b.xy*e.yx;a.xy=b.xx*e.xy+b.xy*e.yy;a.yx=b.yx*e.xx+b.yy*e.yx;a.yy=b.yx*e.xy+b.yy*e.yy;a.dx=b.xx*e.dx+b.xy*e.dy+b.dx;a.dy=b.yx*e.dx+b.yy*e.dy+b.dy}Object.extend(this,a)}}else{Object.extend(this,d)}}}};j.normalize=function(a){return(a instanceof j.Matrix2D)?a:new j.Matrix2D(a)};j.multiply=function(b){var e=j.normalize(b);for(var a=1;a<arguments.length;++a){var d=e,g=j.normalize(arguments[a]);e=new j.Matrix2D();e.xx=d.xx*g.xx+d.xy*g.yx;e.xy=d.xx*g.xy+d.xy*g.yy;e.yx=d.yx*g.xx+d.yy*g.yx;e.yy=d.yx*g.xy+d.yy*g.yy;e.dx=d.xx*g.dx+d.xy*g.dy+d.dx;e.dy=d.yx*g.dx+d.yy*g.dy+d.dy}return e};j.invert=function(d){var a=j.normalize(d),b=a.xx*a.yy-a.xy*a.yx,a=new j.Matrix2D({xx:a.yy/b,xy:-a.xy/b,yx:-a.yx/b,yy:a.xx/b,dx:(a.xy*a.dy-a.yy*a.dx)/b,dy:(a.yx*a.dx-a.xx*a.dy)/b});return a};Object.extend(j.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var k=function(a,b){return Math.abs(a-b)<=0.000001*(Math.abs(a)+Math.abs(b))};var l=function(a,b){if(!isFinite(a)){return b}else{if(!isFinite(b)){return a}}return(a+b)/2};var q=function(b){var a=new j.Matrix2D(b);return Object.extend(a,{dx:0,dy:0,xy:a.yx,yx:a.xy})};var n=function(a){return(a.xx*a.yy<0||a.xy*a.yx>0)?-1:1};var o=function(C){var e=j.normalize(C),F=-e.xx-e.yy,b=e.xx*e.yy-e.xy*e.yx,d=Math.sqrt(F*F-4*b),w=-(F+(F<0?-d:d))/2,z=b/w,D=e.xy/(w-e.xx),g=1,a=e.xy/(z-e.xx),h=1;if(k(w,z)){D=1,g=0,a=0,h=1}if(!isFinite(D)){D=1,g=(w-e.xx)/e.xy;if(!isFinite(g)){D=(w-e.yy)/e.yx,g=1;if(!isFinite(D)){D=1,g=e.yx/(w-e.yy)}}}if(!isFinite(a)){a=1,h=(z-e.xx)/e.xy;if(!isFinite(h)){a=(z-e.yy)/e.yx,h=1;if(!isFinite(a)){a=1,h=e.yx/(z-e.yy)}}}var A=Math.sqrt(D*D+g*g),B=Math.sqrt(a*a+h*h);if(isNaN(D/=A)){D=0}if(isNaN(g/=A)){g=0}if(isNaN(a/=B)){a=0}if(isNaN(h/=B)){h=0}return{value1:w,value2:z,vector1:{x:D,y:g},vector2:{x:a,y:h}}};var m=function(h,g){var d=n(h),e=g.angle1=(Math.atan2(h.yx,h.yy)+Math.atan2(-d*h.xy,d*h.xx))/2,a=Math.cos(e),b=Math.sin(e);g.sx=l(h.xx/a,-h.xy/b);g.sy=l(h.yy/a,h.yx/b);return g};var p=function(h,g){var d=n(h),e=g.angle2=(Math.atan2(d*h.yx,d*h.xx)+Math.atan2(-h.xy,h.yy))/2,a=Math.cos(e),b=Math.sin(e);g.sx=l(h.xx/a,h.yx/b);g.sy=l(h.yy/a,-h.xy/b);return g};return function(e){var g=j.normalize(e),a={dx:g.dx,dy:g.dy,sx:1,sy:1,angle1:0,angle2:0};if(k(g.xy,0)&&k(g.yx,0)){return Object.extend(a,{sx:g.xx,sy:g.yy})}if(k(g.xx*g.yx,-g.xy*g.yy)){return m(g,a)}if(k(g.xx*g.xy,-g.yx*g.yy)){return p(g,a)}var h=q(g),b=o([g,h]),d=o([h,g]),u=new j.Matrix2D({xx:b.vector1.x,xy:b.vector2.x,yx:b.vector1.y,yy:b.vector2.y}),s=new j.Matrix2D({xx:d.vector1.x,xy:d.vector1.y,yx:d.vector2.x,yy:d.vector2.y}),t=new j.Matrix2D([j.invert(u),g,j.invert(s)]);m(s,a);t.xx*=a.sx;t.yy*=a.sy;p(u,a);t.xx*=a.sx;t.yy*=a.sy;return Object.extend(a,{sx:t.xx,sy:t.yy})}})(),setTransform:function(g,e,d){if(g.setTransform){return g.setTransform.apply(g,e)}this.transform(g,this.tInvertMatrix(d));this.transform(g,e)},skewX:function(e,d){return this.transform(e,this.tSkewXMatrix(d))},skewY:function(e,d){return this.transform(e,this.tSkewYMatrix(d))},tRotate:function(k,n){var l=Math.cos(n);var j=Math.sin(n);var p=k[0]*l+k[2]*j;var q=k[1]*l+k[3]*j;var m=k[0]*-j+k[2]*l;var o=k[1]*-j+k[3]*l;k[0]=p;k[1]=q;k[2]=m;k[3]=o;return k},tTranslate:function(d,e,g){d[4]+=d[0]*e+d[2]*g;d[5]+=d[1]*e+d[3]*g;return d},tScale:function(e,g,d){e[0]*=g;e[1]*=g;e[2]*=d;e[3]*=d;return e},tSkewX:function(e,d){return this.tMatrixMultiply(e,this.tSkewXMatrix(d))},tSkewY:function(e,d){return this.tMatrixMultiply(e,this.tSkewYMatrix(d))},tSkewXMatrix:function(b){return[1,0,Math.tan(b),1,0,0]},tSkewYMatrix:function(b){return[1,Math.tan(b),0,1,0,0]},tRotationMatrix:function(e){var h=Math.cos(e);var g=Math.sin(e);return[h,g,-g,h,0,0]},tTranslationMatrix:function(e,d){return[1,0,0,1,e,d]},tScalingMatrix:function(d,e){return[d,0,0,e,0,0]},getTextBackend:function(){if(this.textBackend==null){this.textBackend=this.detectTextBackend()}return this.textBackend},detectTextBackend:function(){var b=this.getTestContext();if(b.fillText){return"HTML5"}else{if(b.mozDrawText){return"MozText"}else{if(b.drawString){return"DrawString"}}}return"NONE"},getSupportsPutImageData:function(){if(this.supportsPutImageData==null){var g=this.getTestContext();var e=g.putImageData;if(e){try{var h=g.getImageData(0,0,1,1);h[0]=255;h[1]=0;h[2]=255;h[3]=255;g.putImageData({width:1,height:1,data:h},0,0);var h=g.getImageData(0,0,1,1);e=[255,0,255,255].equals(h.data)}catch(j){e=false}}this.supportsPutImageData=e}return e},getSupportsIsPointInPath:function(){if(this.supportsIsPointInPath==null){this.supportsIsPointInPath=!!this.getTestContext().isPointInPath}return this.supportsIsPointInPath},getIsPointInPathMode:function(){if(this.isPointInPathMode==null){this.isPointInPathMode=this.detectIsPointInPathMode()}return this.isPointInPathMode},detectIsPointInPathMode:function(){var e=this.getTestContext();var d;if(!e.isPointInPath){return this.USER_SPACE}e.save();e.translate(1,0);e.beginPath();e.rect(0,0,1,1);if(e.isPointInPath(0.3,0.3)){d=this.USER_SPACE}else{d=this.DEVICE_SPACE}e.restore();return d},isPointInPath:function(h,j,k,o,n){var l;if(!h.isPointInPath){if(n&&n.isPointInPath){var m=this.tMatrixMultiplyPoint(this.tInvertMatrix(o),j,k);return n.isPointInPath(m[0],m[1])}else{return false}}else{if(this.getIsPointInPathMode()==this.USER_SPACE){if(!h.setTransform){var m=this.tMatrixMultiplyPoint(this.tInvertMatrix(o),j,k);l=h.isPointInPath(m[0],m[1])}else{h.save();h.setTransform(1,0,0,1,0,0);l=h.isPointInPath(j,k);h.restore()}}else{l=h.isPointInPath(j,k)}return l}}};RecordingContext=Klass({objectId:0,commands:[],isMockObject:true,initialize:function(b){this.commands=b||[];Object.conditionalExtend(this,this.getMockContext())},getMockContext:function(){if(!RecordingContext.MockContext){var j=E.canvas(1,1);var h=CanvasSupport.getContext(j,"2d");var k={};for(var g in h){if(typeof(h[g])=="function"){k[g]=this.createRecordingFunction(g)}else{k[g]=h[g]}}k.isPointInPath=null;k.transform=null;k.setTransform=null;RecordingContext.MockContext=k}return RecordingContext.MockContext},createRecordingFunction:function(e){if(e.search(/^set[A-Z]/)!=-1&&e!="setTransform"){var d=e.charAt(3).toLowerCase()+e.slice(4);return function(){this[d]=arguments[0];this.commands.push([e,$A(arguments)])}}else{return function(){this.commands.push([e,$A(arguments)])}}},clear:function(){this.commands=[]},getRecording:function(){return this.commands},serialize:function(d,e){return"("+{width:d,height:e,commands:this.getRecording()}.toSource()+")"},play:function(b){RecordingContext.play(b,this.getRecording())},createLinearGradient:function(){var b=this.objectId++;this.commands.push([b,"=","createLinearGradient",$A(arguments)]);return new MockGradient(this,b)},createRadialGradient:function(){var b=this.objectId++;this.commands.push([b,"=","createRadialGradient",$A(arguments)]);return new this.MockGradient(this,b)},createPattern:function(){var b=this.objectId++;this.commands.push([b,"=","createPattern",$A(arguments)]);return new this.MockGradient(this,b)},MockGradient:Klass({isMockObject:true,initialize:function(e,d){this.recorder=e;this.id=d},addColorStop:function(){this.recorder.commands.push([this.id,"addColorStop",$A(arguments)])},toSource:function(){return{id:this.id,isMockObject:true}.toSource()}})});RecordingContext.play=function(h,j){var k=[];for(var n=0;n<j.length;n++){var m=j[n];if(m.length==2){var o=m[1];if(o[0]&&o[0].isMockObject){h[m[0]](k[o[0].id])}else{h[m[0]].apply(h,m[1])}}else{if(m.length==3){var l=k[m[0]];l[m[1]].apply(l,m[2])}else{if(m.length==4){k[m[0]]=h[m[2]].apply(h,m[3])}else{throw"Malformed command: "+m.toString()}}}}};Transformable=Klass({needMatrixUpdate:true,transform:function(n){var m=this.absoluteMatrix;var l=this.x||this.y;var w=this.rotation;var u=this.scale!=null;var o=this.skewX;var s=this.skewY;var q=this.matrix;var p=this.transformList;if(this.needMatrixUpdate||!this.currentMatrix){if(!this.currentMatrix){this.currentMatrix=[1,0,0,1,0,0]}if(this.parent){this.__copyMatrix(this.parent.currentMatrix)}else{this.__identityMatrix()}if(m){this.__setMatrixMatrix(this.absoluteMatrix)}if(l){this.__translateMatrix(this.x,this.y)}if(w){this.__rotateMatrix(this.rotation)}if(o){this.__skewXMatrix(this.skewX)}if(s){this.__skewYMatrix(this.skewY)}if(u){this.__scaleMatrix(this.scale)}if(q){this.__matrixMatrix(this.matrix)}if(p){for(var t=0;t<this.transformList.length;t++){var p=this.transformList[t];this["__"+p[0]+"Matrix"](p[1])}}this.needMatrixUpdate=false}if(!n){return}this.__setMatrix(n,this.currentMatrix)},distanceTo:function(b){return Curves.lineLength([this.x,this.y],[b.x,b.y])},angleTo:function(b){return Curves.lineAngle([this.x,this.y],[b.x,b.y])},__setMatrixMatrix:function(g){if(!this.previousMatrix){this.previousMatrix=[]}var e=this.previousMatrix;var h=this.currentMatrix;e[0]=h[0];e[1]=h[1];e[2]=h[2];e[3]=h[3];e[4]=h[4];e[5]=h[5];e=this.currentMatrix;h=g;e[0]=h[0];e[1]=h[1];e[2]=h[2];e[3]=h[3];e[4]=h[4];e[5]=h[5]},__copyMatrix:function(g){var e=this.currentMatrix;var h=g;e[0]=h[0];e[1]=h[1];e[2]=h[2];e[3]=h[3];e[4]=h[4];e[5]=h[5]},__identityMatrix:function(){var b=this.currentMatrix;b[0]=1;b[1]=0;b[2]=0;b[3]=1;b[4]=0;b[5]=0},__translateMatrix:function(e,d){if(e.length){CanvasSupport.tTranslate(this.currentMatrix,e[0],e[1])}else{CanvasSupport.tTranslate(this.currentMatrix,e,d)}},__rotateMatrix:function(b){if(b.length){if(b[0]%Math.PI*2==0){return}if(b[1]||b[2]){CanvasSupport.tTranslate(this.currentMatrix,b[1],b[2]);CanvasSupport.tRotate(this.currentMatrix,b[0]);CanvasSupport.tTranslate(this.currentMatrix,-b[1],-b[2])}else{CanvasSupport.tRotate(this.currentMatrix,b[0])}}else{if(b%Math.PI*2==0){return}CanvasSupport.tRotate(this.currentMatrix,b)}},__skewXMatrix:function(b){if(b.length&&b[0]){CanvasSupport.tSkewX(this.currentMatrix,b[0])}else{CanvasSupport.tSkewX(this.currentMatrix,b)}},__skewYMatrix:function(b){if(b.length&&b[0]){CanvasSupport.tSkewY(this.currentMatrix,b[0])}else{CanvasSupport.tSkewY(this.currentMatrix,b)}},__scaleMatrix:function(b){if(b.length==2){if(b[0]==1&&b[1]==1){return}CanvasSupport.tScale(this.currentMatrix,b[0],b[1])}else{if(b.length==3){if(b[0]==1||(b[0].length&&(b[0][0]==1&&b[0][1]==1))){return}CanvasSupport.tTranslate(this.currentMatrix,b[1],b[2]);if(b[0].length){CanvasSupport.tScale(this.currentMatrix,b[0][0],b[0][1])}else{CanvasSupport.tScale(this.currentMatrix,b[0],b[0])}CanvasSupport.tTranslate(this.currentMatrix,-b[1],-b[2])}else{if(b!=1){CanvasSupport.tScale(this.currentMatrix,b,b)}}}},__matrixMatrix:function(b){CanvasSupport.tMatrixMultiply(this.currentMatrix,b)},__setMatrix:function(e,d){CanvasSupport.setTransform(e,d,this.previousMatrix)},__translate:function(d,e,g){if(e.length!=null){d.translate(e[0],e[1])}else{d.translate(e,g)}},__rotate:function(e,d){if(d.length){if(d[1]||d[2]){if(d[0]%Math.PI*2==0){return}e.translate(d[1],d[2]);e.rotate(d[0]);e.translate(-d[1],-d[2])}else{e.rotate(d[0])}}else{e.rotate(d)}},__skewX:function(e,d){if(d.length&&d[0]){CanvasSupport.skewX(e,d[0])}else{CanvasSupport.skewX(e,d)}},__skewY:function(e,d){if(d.length&&d[0]){CanvasSupport.skewY(e,d[0])}else{CanvasSupport.skewY(e,d)}},__scale:function(e,d){if(d.length==2){e.scale(d[0],d[1])}else{if(d.length==3){e.translate(d[1],d[2]);if(d[0].length){e.scale(d[0][0],d[0][1])}else{e.scale(d[0],d[0])}e.translate(-d[1],-d[2])}else{e.scale(d,d)}}},__matrix:function(e,d){CanvasSupport.transform(e,d)}});Timeline=Klass({startTime:null,repeat:false,lastAction:0,initialize:function(d,e){this.repeat=d;this.keyframes=[]},addKeyframe:function(g,d,e){if(arguments.length==1){this.keyframes.push(g)}else{this.keyframes.push({time:g,target:d,tween:e})}},appendKeyframe:function(g,d,e){this.lastAction+=g;return this.addKeyframe(this.lastAction,d,e)},evaluate:function(u,w,C){if(this.startTime==null){this.startTime=w}var k=w-this.startTime;if(this.keyframes.length>0){var s,q,B;for(var t=0;t<this.keyframes.length;t++){if(this.keyframes[t].time>k){s=t;break}}if(s!=null){q=this.keyframes[s-1];B=this.keyframes[s]}if(!B){if(!this.keyframes.atEnd){this.keyframes.atEnd=true;q=this.keyframes[this.keyframes.length-1];Object.extend(u,Object.clone(q.target));if(this.repeat){this.startTime=w}u.changed=true}}else{if(q){this.keyframes.atEnd=false;var o=k-q.time;var z=B.time-q.time;var p=o/z;for(var A in B.target){if(q.target[A]!=null){u.tweenVariable(A,q.target[A],B.target[A],p,B.tween)}}}}}}});Animatable=Klass({tweenFunctions:{linear:function(b){return b},set:function(b){return Math.floor(b)},discrete:function(b){return Math.floor(b)},sine:function(b){return 0.5-0.5*Math.cos(b*Math.PI)},sproing:function(b){return(0.5-0.5*Math.cos(b*3.59261946538606))*1.05263157894737},square:function(b){return b*b},cube:function(b){return b*b*b},sqrt:function(b){return Math.sqrt(b)},curt:function(b){return Math.pow(b,-0.333333333333)}},initialize:function(){this.lastAction=0;this.timeline=[];this.keyframes=[];this.pendingKeyframes=[];this.pendingTimelineEvents=[];this.timelines=[];this.animators=[];this.addFrameListener(this.updateTimelines);this.addFrameListener(this.updateKeyframes);this.addFrameListener(this.updateTimeline);this.addFrameListener(this.updateAnimators)},updateTimelines:function(d,g){for(var e=0;e<this.timelines.length;e++){this.timelines[e].evaluate(this,d,g)}},addTimeline:function(b){this.timelines.push(b)},removeTimeline:function(b){this.timelines.deleteFirst(b)},updateKeyframes:function(k,w){this.addPendingKeyframes(k);if(this.keyframes.length>0){var p,o,u;for(var q=0;q<this.keyframes.length;q++){if(this.keyframes[q].time>k){p=q;break}}if(p!=null){o=this.keyframes[p-1];u=this.keyframes[p]}if(!u){if(!this.keyframes.atEnd){this.keyframes.atEnd=true;o=this.keyframes[this.keyframes.length-1];Object.extend(this,Object.clone(o.target));this.changed=true}}else{if(o){this.keyframes.atEnd=false;var m=k-o.time;var s=u.time-o.time;var n=m/s;for(var t in u.target){if(o.target[t]!=null){this.tweenVariable(t,o.target[t],u.target[t],n,u.tween)}}}}}},addPendingKeyframes:function(d){if(this.pendingKeyframes.length>0){while(this.pendingKeyframes.length>0){var e=this.pendingKeyframes.shift();if(e.time==null){e.time=e.relativeTime+d}this.keyframes.push(e)}this.keyframes.stableSort(function(a,b){return a.time-b.time})}},updateTimeline:function(e,j){this.addPendingTimelineEvents(e);while(this.timeline[0]&&this.timeline[0].startTime<=e){var g=this.timeline.shift();var h=true;if(typeof(g.action)=="function"){h=g.action.call(this,e,j,g)}else{this.animators.push(g.action)}if(g.repeatEvery!=null&&h!=false){if(g.repeatTimes!=null){if(g.repeatTimes<=0){continue}g.repeatTimes--}g.startTime+=g.repeatEvery;this.addTimelineEvent(g)}this.changed=true}},addPendingTimelineEvents:function(d){if(this.pendingTimelineEvents.length>0){while(this.pendingTimelineEvents.length>0){var e=this.pendingTimelineEvents.shift();if(!e.startTime){e.startTime=e.relativeStartTime+d}this.timeline.push(e)}this.timeline.stableSort(function(a,b){return a.startTime-b.startTime})}},addTimelineEvent:function(b){this.pendingTimelineEvents.push(b)},updateAnimators:function(m,l){for(var n=0;n<this.animators.length;n++){var h=this.animators[n];if(!h.startTime){h.startTime=m}var j=m-h.startTime;var k=j/h.duration;var o=false;if(k>=1){if(!h.repeat){k=1;o=true}else{if(h.repeat!==true){h.repeat=Math.max(0,h.repeat-1)}if(h.accumulate){h.startValue=Object.clone(h.endValue);h.endValue=Object.sum(h.difference,h.endValue)}if(h.repeat==0){o=true;k=1}else{h.startTime=m;k=k%1}}}else{if(h.repeat&&h.repeat!==true&&h.repeat<=k){o=true;k=h.repeat}}this.tweenVariable(h.variable,h.startValue,h.endValue,k,h.tween);if(o){this.animators.splice(n,1);n--}}},tweenVariable:function(o,k,j,l,n){if(typeof(n)!="function"){n=this.tweenFunctions[n]||this.tweenFunctions.linear}var m=n(l);if(typeof(o)!="function"){if(k instanceof Array){for(var h=0;h<k.length;h++){this[o][h]=k[h]+m*(j[h]-k[h])}}else{this[o]=k+m*(j-k)}}else{o.call(this,m,k,j)}this.changed=true},animate:function(p,l,j,m,o,q){var l=Object.clone(l);var j=Object.clone(j);if(!q){q={}}if(q.additive){var n=Object.sub(j,l);l=Object.sum(l,this[p]);j=Object.sum(j,this[p])}if(typeof(p)!="function"){this[p]=Object.clone(l)}var k={id:Animatable.uid++,variable:p,startValue:l,endValue:j,difference:n,duration:m,tween:o,repeat:q.repeat,additive:q.additive,accumulate:q.accumulate,pingpong:q.pingpong};this.animators.push(k);return k},removeAnimator:function(b){this.animators.deleteFirst(b)},animateTo:function(j,h,k,l,g){return this.animate(j,this[j],h,k,l,g)},animateFrom:function(k,j,l,g,h){return this.animate(k,j,this[k],l,g,h)},animateFactor:function(n,l,m,o,p,j){var k;if(l instanceof Array){k=[];for(var q=0;q<l.length;q++){k[q]=l[q]*m}}else{k=l*m}return this.animate(n,l,k,o,p,j)},animateToFactor:function(l,k,m,g,h){var j=this[l];return this.animateFactor(l,j,k,m,g,h)},addKeyframe:function(h,j,e){var g={relativeTime:h,target:j,tween:e};this.pendingKeyframes.push(g)},addKeyframeAt:function(h,j,e){var g={time:h,target:j,tween:e};this.pendingKeyframes.push(g)},appendKeyframe:function(g,d,e){this.lastAction+=g;return this.addKeyframe(this.lastAction,d,e)},every:function(h,j,e){var g={action:j,relativeStartTime:e?h:0,repeatEvery:h};this.addTimelineEvent(g);return g},at:function(g,d){var e={action:d,startTime:g};this.addTimelineEvent(e);return e},after:function(g,d){var e={action:d,relativeStartTime:g};this.addTimelineEvent(e);return e},afterFrame:function(j,h){var e=0;var g;g=function(b,a){if(e>=j){h.call(this);this.removeFrameListener(g)}e++};this.addFrameListener(g);return g},everyFrame:function(k,j,l){var g=l?0:k;var h;h=function(b,a){if(g>=k){if(j.call(this)==false){this.removeFrameListener(h)}g=0}g++};this.addFrameListener(h);return h}});Animatable.uid=0;CanvasNode=Klass(Animatable,Transformable,{OBJECTBOUNDINGBOX:"objectBoundingBox",visible:true,drawable:true,display:null,visibility:null,catchMouse:true,pickable:false,underCursor:false,zIndex:0,x:0,y:0,scale:1,rotation:0,matrix:null,absoluteMatrix:null,transformList:null,fill:null,stroke:null,strokeWidth:null,lineCap:null,lineJoin:null,miterLimit:null,absoluteOpacity:null,opacity:null,fillOpacity:null,strokeOpacity:null,compositeOperation:null,shadowColor:null,shadowBlur:null,shadowOffsetX:null,shadowOffsetY:null,font:null,textAlign:null,textBaseline:null,cursor:null,changed:true,tagName:"g",getNextSibling:function(){if(this.parentNode){return this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)+1]}return null},getPreviousSibling:function(){if(this.parentNode){return this.parentNode.childNodes[this.parentNode.childNodes.indexOf(this)-1]}return null},initialize:function(b){this.root=this;this.currentMatrix=[1,0,0,1,0,0];this.previousMatrix=[1,0,0,1,0,0];this.needMatrixUpdate=true;this.childNodes=[];this.frameListeners=[];this.eventListeners={};Animatable.initialize.call(this);if(b){Object.extend(this,b)}},clone:function(){var h=Object.clone(this);h.parent=h.root=null;for(var g in this){if(typeof(this[g])=="object"){h[g]=Object.clone(this[g])}}h.parent=h.root=null;h.childNodes=[];h.setRoot(null);for(var g=0;g<this.childNodes.length;g++){var e=this.childNodes[g].clone();h.append(e)}return h},cloneNode:function(){return this.clone()},getElementById:function(g){if(this.id==g){return this}for(var e=0;e<this.childNodes.length;e++){var d=this.childNodes[e].getElementById(g);if(d){return d}}return null},$:function(b){return this.getElementById(b)},appendChild:function(){return this.append.apply(this,arguments)},append:function(e){var a=$A(arguments);for(var g=0;g<a.length;g++){if(a[g].parent){a[g].removeSelf()}this.childNodes.push(a[g]);a[g].parent=a[g].parentNode=this;a[g].setRoot(this.root)}this.changed=true},removeAllChildren:function(){this.remove.apply(this,this.childNodes)},removeChild:function(){return this.remove.apply(this,arguments)},remove:function(e){var a=arguments;for(var g=0;g<a.length;g++){this.childNodes.deleteFirst(a[g]);delete a[g].parent;delete a[g].parentNode;a[g].setRoot(null)}this.changed=true},removeSelf:function(){if(this.parentNode){this.parentNode.remove(this)}},contains:function(b){while(b){if(b==this){return true}b=b.parentNode}return false},setRoot:function(e){if(!e){e=this}this.dispatchEvent({type:"rootChanged",canvasTarget:this,relatedTarget:e});this.root=e;for(var d=0;d<this.childNodes.length;d++){this.childNodes[d].setRoot(e)}},addFrameListener:function(b){this.frameListeners.push(b)},removeFrameListener:function(b){this.frameListeners.deleteFirst(b)},addEventListener:function(d,g,e){if(!this.eventListeners[d]){this.eventListeners[d]={capture:[],bubble:[]}}this.eventListeners[d][e?"capture":"bubble"].push(g)},when:function(d,g,e){this.addEventListener(d,g,e||false)},removeEventListener:function(d,g,e){if(!this.eventListeners[d]){return}this.eventListeners[d][e?"capture":"bubble"].deleteFirst(g);if(this.eventListeners[d].capture.length==0&&this.eventListeners[d].bubble.length==0){delete this.eventListeners[d]}},dispatchEvent:function(l){var g=l.type;if(!l.canvasTarget){if(g.search(/^(key|text)/i)==0){l.canvasTarget=this.root.focused||this.root.target}else{l.canvasTarget=this.root.target}if(!l.canvasTarget){l.canvasTarget=this}}var j=[];var k=l.canvasTarget;while(k&&k!=this){j.push(k);k=k.parent}j.push(this);l.canvasPhase="capture";for(var h=j.length-1;h>=0;h--){if(!j[h].handleEvent(l)){return false}}l.canvasPhase="bubble";for(var h=0;h<j.length;h++){if(!j[h].handleEvent(l)){return false}}return true},broadcastEvent:function(g){var d=g.type;g.canvasPhase="capture";if(!this.handleEvent(g)){return false}for(var e=0;e<this.childNodes.length;e++){if(!this.childNodes[e].broadcastEvent(g)){return false}}g.canvasPhase="bubble";if(!this.handleEvent(g)){return false}return true},handleEvent:function(k){var l=k.type;var h=k.canvasPhase;if(this.cursor&&h=="capture"){k.cursor=this.cursor}var m=this.eventListeners[l];m=m&&m[h];if(m){for(var g=0;g<m.length;g++){var j=m[g].call(this,k);if(j==false||k.stopped){if(!k.stopped){k.stopPropagation()}k.stopped=true;return false}}}return true},handleUpdate:function(g,d){this.update(g,d);this.willBeDrawn=(!this.parent||this.parent.willBeDrawn)&&(this.display?this.display!="none":this.visible);for(var e=0;e<this.childNodes.length;e++){this.childNodes[e].handleUpdate(g,d)}if(this.parent&&this.changed){this.parent.changed=this.changed;this.changed=false}this.needMatrixUpdate=true},update:function(h,j){var e=this.frameListeners.slice(0);for(var g=0;g<e.length;g++){if(this.frameListeners.includes(e[g])){e[g].apply(this,arguments)}}},handlePick:function(h){if(this.display){this.visible=(this.display!="none")}if(this.visibility){this.drawable=(this.visibility!="hidden")}this.underCursor=false;if(this.visible&&this.catchMouse&&this.root.absoluteMouseX!=null){h.save();this.transform(h,true);if(this.pickable&&this.drawable){if(h.isPointInPath){h.beginPath();if(this.drawPickingPath){this.drawPickingPath(h)}}this.underCursor=CanvasSupport.isPointInPath(this.drawPickingPath?h:false,this.root.mouseX,this.root.mouseY,this.currentMatrix,this);if(this.underCursor){this.root.target=this}}else{this.underCursor=false}var j=this.__getChildrenCopy();this.__zSort(j);for(var g=0;g<j.length;g++){j[g].handlePick(h);if(!this.underCursor){this.underCursor=j[g].underCursor}}h.restore()}else{var j=this.__getChildrenCopy();while(j.length>0){var k=j.pop();if(k.underCursor){k.underCursor=false;Array.prototype.push.apply(j,k.childNodes)}}}},__zSort:function(b){b.stableSort(function(d,a){return d.zIndex-a.zIndex})},__getChildrenCopy:function(){if(this.__childNodesCopy){while(this.__childNodesCopy.length>this.childNodes.length){this.__childNodesCopy.pop()}for(var b=0;b<this.childNodes.length;b++){this.__childNodesCopy[b]=this.childNodes[b]}}else{this.__childNodesCopy=this.childNodes.slice(0)}return this.__childNodesCopy},isPointInPath:false,handleDraw:function(k){if(this.display){this.visible=(this.display!="none")}if(this.visibility){this.drawable=(this.visibility!="hidden")}if(!this.visible){return}k.save();var p=k.fontFamily;var s=k.fontSize;var o=k.fillOn;var l=k.strokeOn;if(this.fontFamily){k.fontFamily=this.fontFamily}if(this.fontSize){k.fontSize=this.fontSize}this.transform(k);if(this.clipPath){k.beginPath();if(this.clipPath.units==this.OBJECTBOUNDINGBOX){var n=this.getSubtreeBoundingBox(true);k.save();k.translate(n[0],n[1]);k.scale(n[2],n[3]);this.clipPath.createSubtreePath(k,true);k.restore();k.clip()}else{this.clipPath.createSubtreePath(k,true);k.clip()}}if(this.drawable&&this.draw){this.draw(k)}var m=this.__getChildrenCopy();this.__zSort(m);for(var q=0;q<m.length;q++){m[q].handleDraw(k)}k.fontFamily=p;k.fontSize=s;k.fillOn=o;k.strokeOn=l;k.restore()},transform:function(d,e){Transformable.prototype.transform.call(this,d);if(e){return}if(this.fill!=null){if(!this.fill||this.fill=="none"){d.fillOn=false}else{d.fillOn=true;if(this.fill!=true){var g=Colors.parseColorStyle(this.fill,d);d.setFillStyle(g)}}}if(this.stroke!=null){if(!this.stroke||this.stroke=="none"){d.strokeOn=false}else{d.strokeOn=true;if(this.stroke!=true){d.setStrokeStyle(Colors.parseColorStyle(this.stroke,d))}}}if(this.strokeWidth!=null){d.setLineWidth(this.strokeWidth)}if(this.lineCap!=null){d.setLineCap(this.lineCap)}if(this.lineJoin!=null){d.setLineJoin(this.lineJoin)}if(this.miterLimit!=null){d.setMiterLimit(this.miterLimit)}if(this.absoluteOpacity!=null){d.setGlobalAlpha(this.absoluteOpacity)}if(this.opacity!=null){d.setGlobalAlpha(d.globalAlpha*this.opacity)}if(this.compositeOperation!=null){d.setGlobalCompositeOperation(this.compositeOperation)}if(this.shadowColor!=null){d.setShadowColor(Colors.parseColorStyle(this.shadowColor,d))}if(this.shadowBlur!=null){d.setShadowBlur(this.shadowBlur)}if(this.shadowOffsetX!=null){d.setShadowOffsetX(this.shadowOffsetX)}if(this.shadowOffsetY!=null){d.setShadowOffsetY(this.shadowOffsetY)}if(this.textAlign!=null){d.setTextAlign(this.textAlign)}if(this.textBaseline!=null){d.setTextBaseline(this.textBaseline)}if(this.font!=null){d.setFont(this.font)}},drawPickingPath:false,draw:false,createSubtreePath:function(e,g){e.save();if(!g){this.transform(e,true)}for(var d=0;d<this.childNodes.length;d++){this.childNodes[d].createSubtreePath(e)}e.restore()},getSubtreeBoundingBox:function(h){if(h){var l=this.parent;this.parent=null;this.needMatrixUpdate=true}var j=this.getAxisAlignedBoundingBox();for(var g=0;g<this.childNodes.length;g++){var k=this.childNodes[g].getSubtreeBoundingBox();if(!j){j=k}else{if(k){this.mergeBoundingBoxes(j,k)}}}if(h){this.parent=l;this.needMatrixUpdate=true}return j},mergeBoundingBoxes:function(d,e){if(d[0]>e[0]){d[0]=e[0]}if(d[1]>e[1]){d[1]=e[1]}if(d[2]+d[0]<e[2]+e[0]){d[2]=e[2]+e[0]-d[0]}if(d[3]+d[1]<e[3]+e[1]){d[3]=e[3]+e[1]-d[1]}},getAxisAlignedBoundingBox:function(){this.transform(null,true);if(!this.getBoundingBox){return null}var j=this.getBoundingBox();var k=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,j[0],j[1]);var l=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,j[0]+j[2],j[1]+j[3]);var n=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,j[0],j[1]+j[3]);var o=CanvasSupport.tMatrixMultiplyPoint(this.currentMatrix,j[0]+j[2],j[1]);var q=Math.min(k[0],l[0],n[0],o[0]);var s=Math.max(k[0],l[0],n[0],o[0]);var m=Math.min(k[1],l[1],n[1],o[1]);var p=Math.max(k[1],l[1],n[1],o[1]);return[q,m,s-q,p-m]},makeDraggable:function(){this.addEventListener("dragstart",function(b){this.dragStartPosition={x:this.x,y:this.y};b.stopPropagation();b.preventDefault();return false},false);this.addEventListener("drag",function(b){this.x=this.dragStartPosition.x+this.root.dragX/this.parent.currentMatrix[0];this.y=this.dragStartPosition.y+this.root.dragY/this.parent.currentMatrix[3];b.stopPropagation();b.preventDefault();return false},false)}});Canvas=Klass(CanvasNode,{clear:true,frameLoop:false,recording:false,opacity:1,frame:0,elapsed:0,frameDuration:30,speed:1,time:0,fps:0,currentRealFps:0,currentFps:0,fpsFrames:30,startTime:0,realFps:0,fixedTimestep:false,playOnlyWhenFocused:true,isPlaying:true,redrawOnlyWhenChanged:false,changed:true,drawBoundingBoxes:false,cursor:"default",mouseDown:false,mouseEvents:[],absoluteMouseX:null,absoluteMouseY:null,mouseX:null,mouseY:null,elementNodeZIndexCounter:0,initialize:function(n,o){if(arguments.length>2){var h=arguments[0];var j=arguments[1];var m=arguments[2];var o=arguments[3];var n=E.canvas(j,m);var k=E("div",n,{style:{overflow:"hidden",width:j+"px",height:m+"px",position:"relative"}});this.canvasContainer=k;if(h){h.appendChild(k)}}CanvasNode.initialize.call(this,o);this.mouseEventStack=[];this.canvas=n;n.canvas=this;this.width=this.canvas.width;this.height=this.canvas.height;var l=this;this.frameHandler=function(){l.onFrame()};this.canvas.addEventListener("DOMNodeInserted",function(a){if(a.target==this){l.addEventListeners()}},false);this.canvas.addEventListener("DOMNodeRemoved",function(a){if(a.target==this){l.removeEventListeners()}},false);if(this.canvas.parentNode){this.addEventListeners()}this.startTime=new Date().getTime();if(this.isPlaying){this.play()}},removeEventListeners:function(){},addEventListeners:function(){var h=this;this.canvas.parentNode.addMouseEvent=function(a){var b=Mouse.getRelativeCoords(this,a);h.absoluteMouseX=b.x;h.absoluteMouseY=b.y;var d=document.defaultView.getComputedStyle(h.canvas,"");var m=parseFloat(d.getPropertyValue("width"));var l=parseFloat(d.getPropertyValue("height"));h.mouseX=h.absoluteMouseX*(m/h.canvas.width);h.mouseY=h.absoluteMouseY*(l/h.canvas.height);h.addMouseEvent(h.mouseX,h.mouseY,h.mouseDown)};this.canvas.parentNode.contains=this.contains;this.canvas.parentNode.addEventListener("mousedown",function(a){h.mouseDown=true;if(h.keyTarget!=h.target){if(h.keyTarget){h.dispatchEvent({type:"blur",canvasTarget:h.keyTarget})}h.keyTarget=h.target;if(h.keyTarget){h.dispatchEvent({type:"focus",canvasTarget:h.keyTarget})}}this.addMouseEvent(a)},true);this.canvas.parentNode.addEventListener("mouseup",function(a){this.addMouseEvent(a);h.mouseDown=false},true);this.canvas.parentNode.addEventListener("mousemove",function(a){this.addMouseEvent(a);if(h.prevClientX==null){h.prevClientX=a.clientX;h.prevClientY=a.clientY}if(h.dragTarget){var b=document.createEvent("MouseEvents");b.initMouseEvent("drag",true,true,window,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget);b.canvasTarget=h.dragTarget;b.dx=a.clientX-h.prevClientX;b.dy=a.clientY-h.prevClientY;h.dragX+=b.dx;h.dragY+=b.dy;h.dispatchEvent(b)}if(!h.mouseDown){if(h.dragTarget){var b=document.createEvent("MouseEvents");b.initMouseEvent("dragend",true,true,window,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget);b.canvasTarget=h.dragTarget;h.dispatchEvent(b);h.dragX=h.dragY=0;h.dragTarget=false}}else{if(!h.dragTarget&&h.target){h.dragTarget=h.target;var b=document.createEvent("MouseEvents");b.initMouseEvent("dragstart",true,true,window,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget);b.canvasTarget=h.dragTarget;h.dragStartX=a.clientX;h.dragStartY=a.clientY;h.dragX=h.dragY=0;h.dispatchEvent(b)}}h.prevClientX=a.clientX;h.prevClientY=a.clientY},true);this.canvas.parentNode.addEventListener("mouseout",function(a){if(!CanvasNode.contains.call(this,a.relatedTarget)){h.absoluteMouseX=h.absoluteMouseY=h.mouseX=h.mouseY=null}},true);var g=this.dispatchEvent.bind(this);var j=["mousemove","mouseover","mouseout","click","dblclick","mousedown","mouseup","keypress","keydown","keyup","DOMMouseScroll","mousewheel","mousemultiwheel","textInput","focus","blur"];for(var e=0;e<j.length;e++){this.canvas.parentNode.addEventListener(j[e],g,false)}this.keys={};this.windowEventListeners={keydown:function(a){if(h.keyTarget){h.updateKeys(a);a.canvasTarget=h.keyTarget;h.dispatchEvent(a)}},keyup:function(a){if(h.keyTarget){h.updateKeys(a);a.canvasTarget=h.keyTarget;h.dispatchEvent(a)}},keypress:function(a){if(h.keyTarget){a.canvasTarget=h.keyTarget;h.dispatchEvent(a)}},blur:function(a){h.absoluteMouseX=h.absoluteMouseY=null;if(h.playOnlyWhenFocused&&h.isPlaying){h.stop();h.__blurStop=true}},focus:function(a){if(h.__blurStop&&!h.isPlaying){h.play()}},mouseup:function(b){h.mouseDown=false;if(h.dragTarget){var d=document.createEvent("MouseEvents");d.initMouseEvent("dragend",true,true,window,b.detail,b.screenX,b.screenY,b.clientX,b.clientY,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.button,b.relatedTarget);d.canvasTarget=h.dragTarget;h.dispatchEvent(d);h.dragTarget=false}if(!h.canvas.parentNode.contains(b.target)){var a=h.dispatchEvent(b);if(h.keyTarget){h.dispatchEvent({type:"blur",canvasTarget:h.keyTarget});h.keyTarget=null}return a}},mousemove:function(a){if(h.__blurStop&&!h.isPlaying){h.play()}if(!h.canvas.parentNode.contains(a.target)&&h.mouseDown){return h.dispatchEvent(a)}}};this.canvas.parentNode.addEventListener("DOMNodeRemoved",function(a){if(a.target==this){h.removeWindowEventListeners()}},false);this.canvas.parentNode.addEventListener("DOMNodeInserted",function(a){if(a.target==this){h.addWindowEventListeners()}},false);if(this.canvas.parentNode.parentNode){this.addWindowEventListeners()}},updateKeys:function(e){this.keys.shift=e.shiftKey;this.keys.ctrl=e.ctrlKey;this.keys.alt=e.altKey;this.keys.meta=e.metaKey;var d=(e.type=="keydown");switch(e.keyCode){case 37:this.keys.left=d;break;case 38:this.keys.up=d;break;case 39:this.keys.right=d;break;case 40:this.keys.down=d;break;case 32:this.keys.space=d;break;case 13:this.keys.enter=d;break;case 9:this.keys.tab=d;break;case 8:this.keys.backspace=d;break;case 16:this.keys.shift=d;break;case 17:this.keys.ctrl=d;break;case 18:this.keys.alt=d;break}this.keys[e.keyCode]=d},addWindowEventListeners:function(){for(var b in this.windowEventListeners){window.addEventListener(b,this.windowEventListeners[b],false)}},removeWindowEventListeners:function(){for(var b in this.windowEventListeners){window.removeEventListener(b,this.windowEventListeners[b],false)}},addMouseEvent:function(j,g,a){var h=this.allocMouseEvent();h[0]=j;h[1]=g;h[2]=a;this.mouseEvents.push(h)},allocMouseEvent:function(){if(this.mouseEventStack.length>0){return this.mouseEventStack.pop()}else{return[null,null,null]}},freeMouseEvent:function(b){this.mouseEventStack.push(b);if(this.mouseEventStack.length>100){this.mouseEventStack.splice(0,this.mouseEventStack.length)}},clearMouseEvents:function(){while(this.mouseEvents.length>0){this.freeMouseEvent(this.mouseEvents.pop())}},play:function(){this.stop();this.realTime=new Date().getTime();this.frameLoop=setInterval(this.frameHandler,this.frameDuration);this.isPlaying=true},stop:function(){this.__blurStop=false;if(this.frameLoop){clearInterval(this.frameLoop);this.frameLoop=false}this.isPlaying=false},dispatchEvent:function(e){var d=CanvasNode.prototype.dispatchEvent.call(this,e);if(e.cursor){if(this.canvas.style.cursor!=e.cursor){this.canvas.style.cursor=e.cursor}}else{if(this.canvas.style.cursor!=this.cursor){this.canvas.style.cursor=this.cursor}}return d},onFrame:function(q,s){this.elementNodeZIndexCounter=0;var e=this.getContext();try{var p=new Date().getTime();this.currentRealElapsed=(p-this.realTime);this.currentRealFps=1000/this.currentRealElapsed;var t=this.frameDuration*this.speed;if(!this.fixedTimestep){t=this.currentRealElapsed*this.speed}this.realTime=p;if(q!=null){this.time=q;if(s){t=s}}else{this.time+=t}this.previousTarget=this.target;this.target=null;if(this.catchMouse){this.handlePick(e)}if(this.previousTarget!=this.target){if(this.previousTarget){var m=document.createEvent("MouseEvents");m.initMouseEvent("mouseout",true,true,window,0,0,0,0,0,false,false,false,false,0,null);m.canvasTarget=this.previousTarget;this.dispatchEvent(m)}if(this.target){var m=document.createEvent("MouseEvents");m.initMouseEvent("mouseover",true,true,window,0,0,0,0,0,false,false,false,false,0,null);m.canvasTarget=this.target;this.dispatchEvent(m)}}this.handleUpdate(this.time,t);this.clearMouseEvents();if(!this.redrawOnlyWhenChanged||this.changed){try{this.handleDraw(e)}catch(n){console.log(n);throw (n)}this.changed=false}this.currentElapsed=(new Date().getTime()-this.realTime);this.elapsed+=this.currentElapsed;this.currentFps=1000/this.currentElapsed;this.frame++;if(this.frame%this.fpsFrames==0){this.fps=this.fpsFrames*1000/(this.elapsed);this.realFps=this.fpsFrames*1000/(new Date().getTime()-this.startTime);this.elapsed=0;this.startTime=new Date().getTime()}}catch(n){if(e){try{for(var o=0;o<1000;o++){e.restore()}}catch(l){}}delete this.context;throw (n)}},getContext:function(){if(this.recording){return this.getRecordingContext()}else{if(this.useMockContext){return this.getMockContext()}else{return this.get2DContext()}}},get2DContext:function(){if(!this.context){var b=CanvasSupport.getContext(this.canvas,"2d");this.context=b}return this.context},getMockContext:function(){if(!this.fakeContext){var e=this.get2DContext();this.fakeContext={};var g=function(){return this};for(var d in e){if(typeof(e[d])=="function"){this.fakeContext[d]=g}else{this.fakeContext[d]=e[d]}}this.fakeContext.isMockObject=true;this.fakeContext.addColorStop=g}return this.fakeContext},getRecordingContext:function(){if(!this.recordingContext){this.recordingContext=new RecordingContext()}return this.recordingContext},drawPickingPath:function(b){b.rect(0,0,this.canvas.width,this.canvas.height)},isPointInPath:function(e,d){return((e>=0)&&(e<=this.canvas.width)&&(d>=0)&&(d<=this.canvas.height))},draw:function(b){b.setGlobalAlpha(this.opacity);if(this.clear){if(b.fillOn){b.beginPath();b.rect(0,0,this.canvas.width,this.canvas.height);b.fill()}else{b.clearRect(0,0,this.canvas.width,this.canvas.height)}}b.fillStyle="black";b.strokeStyle="black";b.fillOn=false;b.strokeOn=false}});LinkNode=Klass(CanvasNode,{href:null,target:"_self",cursor:"pointer",initialize:function(e,g,d){this.href=e;if(g){this.target=g}CanvasNode.initialize.call(this,d);this.setupLinkEventListeners()},setupLinkEventListeners:function(){this.addEventListener("click",function(e){if(e.button==Mouse.RIGHT){return}var d=this.target;if((e.ctrlKey||e.button==Mouse.MIDDLE)&&d=="_self"){d="_blank"}window.open(this.href,d)},false)}});AudioNode=Klass(CanvasNode,{ready:false,autoPlay:false,playing:false,paused:false,pan:0,volume:1,loop:false,transformSound:false,initialize:function(e,d){CanvasNode.initialize.call(this,d);this.filename=e;this.when("load",this._autoPlaySound);this.loadSound()},loadSound:function(){this.sound=CanvasSupport.getSoundObject();if(!this.sound){return}var b=this;this.sound.onready=function(){b.ready=true;b.root.dispatchEvent({type:"ready",canvasTarget:b})};this.sound.onload=function(){b.loaded=true;b.root.dispatchEvent({type:"load",canvasTarget:b})};this.sound.onerror=function(){b.root.dispatchEvent({type:"error",canvasTarget:b})};this.sound.onfinish=function(){if(b.loop){b.play()}else{b.stop()}};this.sound.load(this.filename)},play:function(){this.playing=true;this.needPlayUpdate=true},stop:function(){this.playing=false;this.needPlayUpdate=true},pause:function(){if(this.needPauseUpdate){this.needPauseUpdate=false;return}this.paused=!this.paused;this.needPauseUpdate=true},setVolume:function(b){this.volume=b;this.needStatusUpdate=true},setPan:function(b){this.pan=b;this.needStatusUpdate=true},handleUpdate:function(){CanvasNode.handleUpdate.apply(this,arguments);if(this.willBeDrawn){this.transform(null,true);if(!this.sound){this.loadSound()}if(this.ready){if(this.transformSound){var b=this.currentMatrix[4];var o=this.currentMatrix[5];var d=this.currentMatrix[2];var n=this.currentMatrix[3];var p=this.currentMatrix[0];var s=this.currentMatrix[1];var q=this.root.width*0.5;var a=Math.sqrt(d*d+n*n);var t=Math.sqrt(p*p+s*s);this.setVolume(a);this.setPan((b-q)/q)}if(this.needPauseUpdate){this.needPauseUpdate=false;this._pauseSound()}if(this.needPlayUpdate){this.needPlayUpdate=false;if(this.playing){this._playSound()}else{this._stopSound()}}if(this.needStatusUpdate){this._setSoundVolume();this._setSoundPan()}}}},_autoPlaySound:function(){if(this.autoPlay){this.play()}},_setSoundVolume:function(){this.sound.setVolume(this.volume)},_setSoundPan:function(){this.sound.setPan(this.pan)},_playSound:function(){if(this.sound.play()==false){return this.playing=false}this.root.dispatchEvent({type:"play",canvasTarget:this})},_stopSound:function(){this.sound.stop();this.root.dispatchEvent({type:"stop",canvasTarget:this})},_pauseSound:function(){this.sound.pause();this.root.dispatchEvent({type:this.paused?"pause":"play",canvasTarget:this})}});ElementNode=Klass(CanvasNode,{noScaling:false,noAlpha:false,inherit:"inherit",align:null,valign:null,xOffset:0,yOffset:0,initialize:function(d,e){CanvasNode.initialize.call(this,e);this.content=d;this.element=E("div",d);this.element.style.MozTransformOrigin=this.element.style.webkitTransformOrigin="0 0";this.element.style.position="absolute"},clone:function(){var b=CanvasNode.prototype.clone.call(this);if(this.content&&this.content.cloneNode){b.content=this.content.cloneNode(true)}b.element=E("div",b.content);b.element.style.position="absolute";b.element.style.MozTransformOrigin=b.element.style.webkitTransformOrigin="0 0";return b},setRoot:function(b){CanvasNode.setRoot.call(this,b);if(this.element&&this.element.parentNode&&this.element.parentNode.removeChild){this.element.parentNode.removeChild(this.element)}},handleUpdate:function(e,d){CanvasNode.handleUpdate.call(this,e,d);if(!this.willBeDrawn||!this.visible||this.display=="none"||this.visibility=="hidden"||!this.drawable){if(this.element.style.display!="none"){this.element.style.display="none"}}else{if(this.element.style.display=="none"){this.element.style.display="block"}}},addEventListener:function(l,j,h){var g=this;var k=function(){j.apply(g,arguments)};return this.element.addEventListener(l,k,h||false)},removeEventListener:function(l,j,h){var g=this;var k=function(){j.apply(g,arguments)};return this.element.removeEventListener(l,k,h||false)},draw:function(I){if(this.cursor&&this.element.style.cursor!=this.cursor){this.element.style.cursor=this.cursor}if(this.element.style.zIndex!=this.root.elementNodeZIndexCounter){this.element.style.zIndex=this.root.elementNodeZIndexCounter}this.root.elementNodeZIndexCounter++;var J=this.currentMatrix;xo=this.xOffset;yo=this.yOffset;if(this.fillBoundingBox&&this.parent&&this.parent.getBoundingBox){var Q=this.parent.getBoundingBox();xo+=Q[0];yo+=Q[1]}var R=CanvasSupport.tMatrixMultiplyPoint(J.slice(0,4).concat([0,0]),xo,yo);var M=this.currentMatrix[4]+R[0];var N=this.currentMatrix[5]+R[1];var a=this.currentMatrix[2];var b=this.currentMatrix[3];var d=this.currentMatrix[0];var B=this.currentMatrix[1];var F=Math.sqrt(a*a+b*b);var O=Math.sqrt(d*d+B*B);if(I.fontFamily!=null){this.element.style.fontFamily=I.fontFamily}var C=CanvasSupport.isCSSTransformSupported();if(C&&!this.noScaling){this.element.style.MozTransform=this.element.style.webkitTransform="matrix("+J.join(",")+")"}else{this.element.style.MozTransform=this.element.style.webkitTransform=""}if(I.fontSize!=null){if(this.noScaling||C){this.element.style.fontSize=I.fontSize+"px"}else{this.element.style.fontSize=I.fontSize*F+"px"}}else{if(this.noScaling||C){this.element.style.fontSize="inherit"}else{this.element.style.fontSize=100*F+"%"}}if(this.noAlpha){this.element.style.opacity=1}else{this.element.style.opacity=I.globalAlpha}if(!this.element.parentNode&&this.root.canvas.parentNode){this.element.style.visibility="hidden";this.root.canvas.parentNode.appendChild(this.element);var D=true}var P=this.color||this.fill;if(this.parent){if(!P||!P.length){P=this.parent.color}if(!P||!P.length){P=this.parent.fill}}if(!P||!P.length){P=I.fillStyle}if(typeof(P)=="string"){if(P.search(/^rgba\(/)!=-1){this.element.style.color="rgb("+P.match(/\d+/g).slice(0,3).join(",")+")"}else{this.element.style.color=P}}else{if(P.length){this.element.style.color="rgb("+P.slice(0,3).map(Math.floor).join(",")+")"}}var K=0,L=0;if(Q){this.element.style.width=Math.floor(O*Q[2])+"px";this.element.style.height=Math.floor(F*Q[3])+"px";this.eWidth=O;this.eHeight=F}else{this.element.style.width="";this.element.style.height="";var H=this.align||this.textAnchor;var G=[0,0];if(H=="center"||H=="middle"){K=-this.element.offsetWidth/2;G[0]="50%"}else{if(H=="right"){K=-this.element.offsetWidth;G[0]="100%"}}var S=this.valign;if(S=="center"||S=="middle"){L=-this.element.offsetHeight/2;G[1]="50%"}else{if(S=="bottom"){L=-this.element.offsetHeight;G[1]="100%"}}this.element.style.webkitTransformOrigin=this.element.style.MozTransformOrigin=G.join(" ");this.eWidth=this.element.offsetWidth/O;this.eHeight=this.element.offsetHeight/F}if(C&&!this.noScaling){this.element.style.left=Math.floor(K)+"px";this.element.style.top=Math.floor(L)+"px"}else{this.element.style.left=Math.floor(M+K)+"px";this.element.style.top=Math.floor(N+L)+"px"}if(D){this.element.style.visibility="visible"}}});Drawable=Klass(CanvasNode,{pickable:true,strokeMode:"above",ABOVE:"above",BELOW:"below",INSIDE:"inside",initialize:function(b){CanvasNode.initialize.call(this,b)},drawPickingPath:function(b){if(!this.drawGeometry){return}b.beginPath();this.drawGeometry(b)},isPointInPath:function(e,d){return false},isVisible:function(h){var p=this.getAxisAlignedBoundingBox();if(!p){return true}var t=p[0],u=p[0]+p[2],n=p[1],o=p[1]+p[3];var m=this.root.width;var q=this.root.height;if(this.root.drawBoundingBoxes){h.save();var l=this.getBoundingBox();h.beginPath();h.rect(l[0],l[1],l[2],l[3]);h.strokeStyle="green";h.lineWidth=1;h.stroke();h.restore();h.save();CanvasSupport.setTransform(h,[1,0,0,1,0,0],this.currentMatrix);h.beginPath();h.rect(t,n,u-t,o-n);h.strokeStyle="red";h.lineWidth=1.5;h.stroke();h.restore()}var s=!(u<0||t>m||o<0||n>q);return s},createSubtreePath:function(e,g){e.save();if(!g){this.transform(e,true)}if(this.drawGeometry){this.drawGeometry(e)}for(var d=0;d<this.childNodes.length;d++){this.childNodes[d].createSubtreePath(e)}e.restore()},draw:function(g){if(!this.drawGeometry){return}if(this.root.drawBoundingBoxes){this.isVisible(g)}var h=(g.fillStyle.transformList||g.fillStyle.matrix||g.fillStyle.scale!=null||g.fillStyle.rotation||g.fillStyle.x||g.fillStyle.y);var e=(g.strokeStyle.transformList||g.strokeStyle.matrix||g.strokeStyle.scale!=null||g.strokeStyle.rotation||g.strokeStyle.x||g.strokeStyle.y);g.beginPath();this.drawGeometry(g);if(g.strokeOn){switch(this.strokeMode){case this.ABOVE:if(g.fillOn){this.doFill(g,h)}this.doStroke(g,e);break;case this.BELOW:this.doStroke(g,e);if(g.fillOn){this.doFill(g,h)}break;case this.INSIDE:if(g.fillOn){this.doFill(g,h)}g.save();var j=g.lineWidth;g.setLineWidth(1);this.doStroke(g,e);g.setLineWidth(j);g.clip();this.doStroke(g,e);g.restore();break}}else{if(g.fillOn){this.doFill(g,h)}}this.drawMarkers(g);if(this.clip){g.clip()}},doFill:function(h,j){if(j||(this.getBoundingBox&&h.fillStyle.units==this.OBJECTBOUNDINGBOX)){h.save();if(this.getBoundingBox&&h.fillStyle.units==this.OBJECTBOUNDINGBOX){var l=this.getBoundingBox();var k=l[2];var m=l[3];h.translate(l[0],l[1]);h.scale(k,m)}h.fillStyle.transform(h)}if(this.fillOpacity!=null){var g=h.globalAlpha;h.setGlobalAlpha(g*this.fillOpacity);h.fill();h.globalAlpha=g}else{h.fill()}if(j){h.restore()}},doStroke:function(q,p){if(p||(this.getBoundingBox&&q.strokeStyle.units==this.OBJECTBOUNDINGBOX)){q.save();if(this.getBoundingBox&&q.strokeStyle.units==this.OBJECTBOUNDINGBOX){var m=this.getBoundingBox();var l=m[2];var n=m[3];q.translate(m[0],m[1]);q.scale(l,n)}q.strokeStyle.needMatrixUpdate=true;q.strokeStyle.transform(q);if(l!=null){CanvasSupport.tScale(q.strokeStyle.currentMatrix,l,n)}var j=q.strokeStyle.currentMatrix;var k=Math.sqrt(Math.max(j[0]*j[0]+j[1]*j[1],j[2]*j[2]+j[3]*j[3]));q.setLineWidth(((q.lineWidth==null)?1:q.lineWidth)/k)}if(this.strokeOpacity!=null){var o=q.globalAlpha;q.setGlobalAlpha(o*this.strokeOpacity);q.stroke();q.globalAlpha=o}else{q.stroke()}if(p){q.restore()}},drawMarkers:function(k){var s=this.markerStart||this.marker;var t=this.markerEnd||this.marker;var p=this.markerMid||this.marker;if(s&&this.getStartPoint){var m=this.getStartPoint();if(s.orient!=null&&s.orient!="auto"){m.angle=s.orient}var q=(s.markerUnits=="strokeWidth")?k.lineWidth:1;k.save();k.translate(m.point[0],m.point[1]);k.scale(q,q);k.rotate(m.angle);var l=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),m.point[0],m.point[1]),q,q),m.angle);s.__copyMatrix(l);s.handleDraw(k);k.restore()}if(t&&this.getEndPoint){var m=this.getEndPoint();if(t.orient!=null&&t.orient!="auto"){m.angle=t.orient}var q=(t.markerUnits=="strokeWidth")?k.lineWidth:1;k.save();k.translate(m.point[0],m.point[1]);k.scale(q,q);k.rotate(m.angle);var l=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),m.point[0],m.point[1]),q,q),m.angle);t.__copyMatrix(l);t.handleDraw(k);k.restore()}if(p&&this.getMidPoints){var n=this.getMidPoints();var q=(p.markerUnits=="strokeWidth")?k.lineWidth:1;for(var o=0;o<n.length;o++){var m=n[o];k.save();k.translate(m.point[0],m.point[1]);k.scale(q,q);if(p.orient!=null&&p.orient!="auto"){m.angle=t.orient}k.rotate(m.angle);var l=CanvasSupport.tRotate(CanvasSupport.tScale(CanvasSupport.tTranslate(this.currentMatrix.slice(0),m.point[0],m.point[1]),q,q),m.angle);p.__copyMatrix(l);p.handleDraw(k);k.restore()}}},getStartPoint:false,getEndPoint:false,getMidPoints:false,getBoundingBox:false});Line=Klass(Drawable,{x1:0,y1:0,x2:0,y2:0,stroke:true,initialize:function(l,j,h,k,g){this.x1=l;this.y1=j;this.x2=h;this.y2=k;Drawable.initialize.call(this,g)},drawGeometry:function(b){b.moveTo(this.x1,this.y1);b.lineTo(this.x2,this.y2)},getStartPoint:function(){return{point:[this.x1,this.y1],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getEndPoint:function(){return{point:[this.x2,this.y2],angle:Math.atan2(this.y2-this.y1,this.x2-this.x1)}},getBoundingBox:function(){return[this.x1,this.y1,this.x2-this.x1,this.y2-this.y1]},getLength:function(){return Curves.lineLength([this.x1,this.y1],[this.x2,this.y2])}});Circle=Klass(Drawable,{cx:0,cy:0,radius:10,startAngle:0,endAngle:Math.PI*2,clockwise:false,closePath:true,includeCenter:false,initialize:function(e,d){if(e!=null){this.radius=e}Drawable.initialize.call(this,d)},drawGeometry:function(e){if(this.radius==0){return}if(this.includeCenter){e.moveTo(this.cx,this.cy)}e.arc(this.cx,this.cy,this.radius,this.startAngle,this.endAngle,this.clockwise);if(this.closePath){var d=Math.cos(this.endAngle);var g=Math.sin(this.endAngle);e.moveTo(this.cx+d*this.radius,this.cy+g*this.radius);e.closePath()}},isPointInPath:function(e,d){e-=this.cx;d-=this.cy;return(e*e+d*d)<=(this.radius*this.radius)},getBoundingBox:function(){return[this.cx-this.radius,this.cy-this.radius,2*this.radius,2*this.radius]}});Ellipse=Klass(Circle,{radiusX:0,radiusY:0,initialize:function(g,d,e){this.radiusX=g;this.radiusY=d;Circle.initialize.call(this,1,e)},drawGeometry:function(g){if(this.radiusX==0||this.radiusY==0){return}var m=0.5522847498;var h=this.cx;var j=this.cy;var k=m*this.radiusX;var l=m*this.radiusY;g.moveTo(h+this.radiusX,j);g.bezierCurveTo(h+this.radiusX,j-l,h+k,j-this.radiusY,h,j-this.radiusY);g.bezierCurveTo(h-k,j-this.radiusY,h-this.radiusX,j-l,h-this.radiusX,j);g.bezierCurveTo(h-this.radiusX,j+l,h-k,j+this.radiusY,h,j+this.radiusY);g.bezierCurveTo(h+k,j+this.radiusY,h+this.radiusX,j+l,h+this.radiusX,j)},isPointInPath:function(e,d){e-=this.cx;d-=this.cy;e/=this.radiusX;d/=this.radiusY;return(e*e+d*d)<=1},getBoundingBox:function(){return[this.cx-this.radiusX,this.cy-this.radiusY,this.radiusX*2,this.radiusY*2]}});Spiral=Klass(Drawable,{cx:0,cy:0,startRadius:0,startAngle:0,endAngle:0,radiusFunction:function(a){return a},initialize:function(e,d){this.endAngle=e;Drawable.initialize.call(this,d)},drawGeometry:function(j){var a=this.cx;var g=this.cy;var k=this.startAngle;var h=this.startRadius+this.radiusFunction(k);j.moveTo(a+Math.cos(k)*h,g-Math.sin(k)*h);if(this.startAngle<this.endAngle){k+=0.1;h=this.startRadius+this.radiusFunction(k);while(k<this.endAngle){j.lineTo(a+Math.cos(k)*h,g-Math.sin(k)*h);k+=0.1;h=this.startRadius+this.radiusFunction(k)}}else{k-=0.1;h=this.startRadius+this.radiusFunction(k);while(k>this.endAngle){j.lineTo(a+Math.cos(k)*h,g-Math.sin(k)*h);k-=0.1;h=this.startRadius+this.radiusFunction(k)}}k=this.endAngle;h=this.startRadius+this.radiusFunction(k);j.lineTo(a+Math.cos(k)*h,g-Math.sin(k)*h)},isPointInPath:function(e,d){return false}});Rectangle=Klass(Drawable,{cx:0,cy:0,x2:0,y2:0,width:0,height:0,rx:0,ry:0,centered:false,initialize:function(g,e,d){if(g!=null){this.width=g;this.height=g}if(e!=null){this.height=e}Drawable.initialize.call(this,d)},drawGeometry:function(h){var m=this.cx;var n=this.cy;var k=(this.width||(this.x2-m));var o=(this.height||(this.y2-n));if(k==0||o==0){return}if(this.centered){m-=0.5*k;n-=0.5*o}if(this.rx||this.ry){var t=Math.min(k*0.5,this.rx||this.ry);var u=Math.min(o*0.5,this.ry||t);var q=0.5522847498;var p=q*t;var s=q*u;h.moveTo(m+t,n);h.lineTo(m-t+k,n);h.bezierCurveTo(m-t+k+p,n,m+k,n+u-s,m+k,n+u);h.lineTo(m+k,n+o-u);h.bezierCurveTo(m+k,n+o-u+s,m-t+k+p,n+o,m-t+k,n+o);h.lineTo(m+t,n+o);h.bezierCurveTo(m+t-p,n+o,m,n+o-u+s,m,n+o-u);h.lineTo(m,n+u);h.bezierCurveTo(m,n+u-s,m+t-p,n,m+t,n);h.closePath()}else{if(k<0){m+=k}if(o<0){n+=o}h.rect(m,n,Math.abs(k),Math.abs(o))}},isPointInPath:function(e,d){e-=this.cx;d-=this.cy;if(this.centered){e+=this.width/2;d+=this.height/2}return(e>=0&&e<=this.width&&d>=0&&d<=this.height)},getBoundingBox:function(){var e=this.cx;var d=this.cy;if(this.centered){e-=this.width/2;d-=this.height/2}return[e,d,this.width,this.height]}});Polygon=Klass(Drawable,{segments:[],closePath:true,initialize:function(d,e){this.segments=d;Drawable.initialize.call(this,e)},drawGeometry:function(e){if(!this.segments||this.segments.length<2){return}var g=this.segments;e.moveTo(g[0],g[1]);for(var d=2;d<g.length;d+=2){e.lineTo(g[d],g[d+1])}if(this.closePath){e.closePath()}},isPointInPath:function(d,e){if(!this.segments||this.segments.length<2){return false}var g=this.getBoundingBox();return(d>=g[0]&&d<=g[0]+g[2]&&e>=g[1]&&e<=g[1]+g[3])},getStartPoint:function(){if(!this.segments||this.segments.length<2){return{point:[0,0],angle:0}}var a=0;if(this.segments.length>2){a=Curves.lineAngle(this.segments.slice(0,2),this.segments.slice(2,4))}return{point:this.segments.slice(0,2),angle:a}},getEndPoint:function(){if(!this.segments||this.segments.length<2){return{point:[0,0],angle:0}}var a=0;if(this.segments.length>2){a=Curves.lineAngle(this.segments.slice(-4,-2),this.segments.slice(-2))}return{point:this.segments.slice(-2),angle:a}},getMidPoints:function(){if(!this.segments||this.segments.length<2){return[]}var n=this.segments;var a=[];for(var l=2;l<n.length-2;l+=2){var o=n.slice(l-2,l);var p=n.slice(l,l+2);var b=n.slice(l+2,l+4);var m=0.5*(Curves.lineAngle(o,p)+Curves.lineAngle(p,b));a.push({point:p,angle:m})}return a},getBoundingBox:function(){var j=Infinity,l=Infinity,n=-Infinity,o=-Infinity;var p=this.segments;for(var q=0;q<p.length;q+=2){var k=p[q],m=p[q+1];if(k<j){j=k}if(k>n){n=k}if(m<l){l=m}if(m>o){o=m}}return[j,l,n-j,o-l]}});CatmullRomSpline=Klass(Drawable,{segments:[],loop:false,closePath:false,initialize:function(d,e){this.segments=d;Drawable.initialize.call(this,e)},drawGeometry:function(n){var z=this.currentMatrix[0];var A=this.currentMatrix[1];var p=this.currentMatrix[2];var q=this.currentMatrix[3];var u=z*z+A*A;var o=p*p+q*q;var m=Math.floor(Math.sqrt(Math.max(u,o)));var s=this.compiled;if(!s||s.scale!=m){s=this.compile(m)}for(var t=0;t<s.length;t++){var w=s[t];n[w[0]].apply(n,w[1])}if(this.closePath){n.closePath()}},compile:function(u){if(!u){u=1}var b=[];if(this.segments&&this.segments.length>=(this.loop?1:4)){var z=this.segments;if(this.loop){z=z.slice(0);z.unshift(z[z.length-1]);z.push(z[1]);z.push(z[2])}var A=1/(15*(u+0.5));var C,a,d,j,B,w;b.push(["moveTo",z[1].slice(0)]);B=z[1];for(var t=1;t<z.length-2;t++){C=z[t-1];a=z[t];d=z[t+1];j=z[t+2];for(var p=0;p<1;p+=A){w=B;B=Curves.catmullRomPoint(C,a,d,j,p);b.push(["lineTo",B])}}B=Curves.catmullRomPoint(C,a,d,j,1);b.push(["lineTo",B])}b.scale=u;this.compiled=b;return b},getBoundingBox:function(){var s=Infinity,t=Infinity,u=-Infinity,w=-Infinity;var n=(this.compiled?this.compiled:this.compile());for(var o=0;o<n.length;o++){var p=n[o][1];for(var q=0;q<p.length;q+=2){var j=p[q],m=p[q+1];if(j<s){s=j}if(j>u){u=j}if(m<t){t=m}if(m>w){w=m}}}return[s,t,u-s,w-t]},pointAt:function(b){if(!this.segments){return[0,0]}if(this.segments.length>=(this.loop?1:4)){var t=this.segments;if(this.loop){t=t.slice(0);t.unshift(t[t.length-1]);t.push(t[1]);t.push(t[2])}var s=b*(t.length-3);var q=Math.floor(s);var a=s-q;var d=t[q],j=t[q+1],o=t[q+2],p=t[q+3];return Curves.catmullRomPoint(d,j,o,p,a)}else{return this.segments[0]}},pointAngleAt:function(b){if(!this.segments){return{point:[0,0],angle:0}}if(this.segments.length>=(this.loop?1:4)){var t=this.segments;if(this.loop){t=t.slice(0);t.unshift(t[t.length-1]);t.push(t[1]);t.push(t[2])}var s=b*(t.length-3);var q=Math.floor(s);var a=s-q;var d=t[q],j=t[q+1],o=t[q+2],p=t[q+3];return Curves.catmullRomPointAngle(d,j,o,p,a)}else{return{point:this.segments[0]||[0,0],angle:0}}}});Path=Klass(Drawable,{segments:[],closePath:false,initialize:function(d,e){this.segments=d;Drawable.initialize.call(this,e)},drawGeometry:function(e){var j=this.getSegments();for(var h=0;h<j.length;h++){var g=j[h];e[g[0]].apply(e,g[1])}if(this.closePath){e.closePath()}},isPointInPath:function(d,e){var g=this.getBoundingBox();return(d>=g[0]&&d<=g[0]+g[2]&&e>=g[1]&&e<=g[1]+g[3])},getBoundingBox:function(){if(!(this.compiled&&this.compiledBoundingBox)){var s=Infinity,t=Infinity,u=-Infinity,w=-Infinity;var n=this.getSegments();for(var o=0;o<n.length;o++){var p=n[o][1];for(var q=0;q<p.length;q+=2){var j=p[q],m=p[q+1];if(j<s){s=j}if(j>u){u=j}if(m<t){t=m}if(m>w){w=m}}}this.compiledBoundingBox=[s,t,u-s,w-t]}return this.compiledBoundingBox},getStartPoint:function(){var n=this.getSegments();if(!n||!n[0]){return{point:[0,0],angle:0}}var h=n[0];var k=h[1];var j=[k[k.length-2],k[k.length-1]];var m=n[1];var l=0;if(m){c2=m[1];l=Curves.lineAngle(j,[c2[c2.length-2],c2[c2.length-1]])}return{point:j,angle:l}},getEndPoint:function(){var n=this.getSegments();if(!n||!n[0]){return{point:[0,0],angle:0}}var h=n[n.length-1];var k=h[1];var j=[k[k.length-2],k[k.length-1]];var m=n[n.length-2];var l=0;if(m){c2=m[1];l=Curves.lineAngle([c2[c2.length-2],c2[c2.length-1]],j)}return{point:j,angle:l}},getMidPoints:function(){var p=this.getSegments();if(this.vertices){return this.vertices.slice(1,-1)}var a=[];for(var n=1;n<p.length-1;n++){var s=p[n-1][1].slice(-2);var b=p[n][1].slice(0,2);if(p[n-1].length>2){var q=p[n-1][1].slice(-4,-2);var o=0.5*(Curves.lineAngle(q,s)+Curves.lineAngle(s,b))}else{var o=Curves.lineAngle(s,b)}a.push({point:s,angle:o});var m=p[n][2];if(m!=null){n++;while(p[n]&&p[n][2]==m){n++}n--}}return a},getSegments:function(){if(typeof(this.segments)=="string"){if(!this.compiled||this.segments!=this.compiledSegments){this.compiled=this.compileSVGPath(this.segments);this.compiledSegments=this.segments}}else{if(!this.compiled){this.compiled=Object.clone(this.segments)}}return this.compiled},compileSVGPath:function(H){var G=H.split(/(?=[a-z])/i);var q=0;var w=0;var l,s;var u;var F=[];for(var A=0;A<G.length;A++){var B=G[A];var D=B.match(/[a-z]/i);if(!D){return[]}D=D[0];var t=B.match(/[+-]?\d+(\.\d+(e\d+(\.\d+)?)?)?/gi);if(t){t=t.map(parseFloat)}switch(D){case"M":q=t[0];w=t[1];l=s=null;F.push(["moveTo",[q,w]]);break;case"m":q+=t[0];w+=t[1];l=s=null;F.push(["moveTo",[q,w]]);break;case"L":q=t[0];w=t[1];l=s=null;F.push(["lineTo",[q,w]]);break;case"l":q+=t[0];w+=t[1];l=s=null;F.push(["lineTo",[q,w]]);break;case"H":q=t[0];l=s=null;F.push(["lineTo",[q,w]]);break;case"h":q+=t[0];l=s=null;F.push(["lineTo",[q,w]]);break;case"V":w=t[0];l=s=null;F.push(["lineTo",[q,w]]);break;case"v":w+=t[0];l=s=null;F.push(["lineTo",[q,w]]);break;case"C":q=t[4];w=t[5];l=t[2];s=t[3];F.push(["bezierCurveTo",t]);break;case"c":F.push(["bezierCurveTo",[t[0]+q,t[1]+w,t[2]+q,t[3]+w,t[4]+q,t[5]+w]]);l=q+t[2];s=w+t[3];q+=t[4];w+=t[5];break;case"S":if(l==null||!u.match(/[sc]/i)){l=q;s=w}F.push(["bezierCurveTo",[q-(l-q),w-(s-w),t[0],t[1],t[2],t[3]]]);l=t[0];s=t[1];q=t[2];w=t[3];break;case"s":if(l==null||!u.match(/[sc]/i)){l=q;s=w}F.push(["bezierCurveTo",[q-(l-q),w-(s-w),q+t[0],w+t[1],q+t[2],w+t[3]]]);l=q+t[0];s=w+t[1];q+=t[2];w+=t[3];break;case"Q":l=t[0];s=t[1];q=t[2];w=t[3];F.push(["quadraticCurveTo",t]);break;case"q":F.push(["quadraticCurveTo",[t[0]+q,t[1]+w,t[2]+q,t[3]+w]]);l=q+t[0];s=w+t[1];q+=t[2];w+=t[3];break;case"T":if(l==null||!u.match(/[qt]/i)){l=q;s=w}else{l=q-(l-q);s=w-(s-w)}F.push(["quadraticCurveTo",[l,s,t[0],t[1]]]);l=q-(l-q);s=w-(s-w);q=t[0];w=t[1];break;case"t":if(l==null||!u.match(/[qt]/i)){l=q;s=w}else{l=q-(l-q);s=w-(s-w)}F.push(["quadraticCurveTo",[l,s,q+t[0],w+t[1]]]);q+=t[0];w+=t[1];break;case"A":var z=this.solveArc(q,w,t);for(var C=0;C<z.length;C++){z[C][2]=A}F.push.apply(F,z);q=t[5];w=t[6];break;case"a":t[5]+=q;t[6]+=w;var z=this.solveArc(q,w,t);for(var C=0;C<z.length;C++){z[C][2]=A}F.push.apply(F,z);q=t[5];w=t[6];break;case"Z":F.push(["closePath",[]]);break;case"z":F.push(["closePath",[]]);break}u=D}return F},solveArc:function(q,t,s){var B=s[0];var F=s[1];var A=s[2];var p=s[3];var o=s[4];var u=s[5];var w=s[6];var C=this.arcToSegments(u,w,B,F,p,o,A,q,t);var D=[];for(var z=0;z<C.length;z++){D.push(["bezierCurveTo",this.segmentToBezier.apply(this,C[z])])}return D},arcToSegments:function(Y,Z,ad,ae,ai,ac,al,af,ag){var az=al*(Math.PI/180);var V=Math.sin(az);var Q=Math.cos(az);ad=Math.abs(ad);ae=Math.abs(ae);var ar=Q*(af-Y)*0.5+V*(ag-Z)*0.5;var at=Q*(ag-Z)*0.5-V*(af-Y)*0.5;var an=(ar*ar)/(ad*ad)+(at*at)/(ae*ae);if(an>1){an=Math.sqrt(an);ad*=an;ae*=an}var aa=Q/ad;var ab=V/ad;var ao=(-V)/ae;var ap=(Q)/ae;var ak=aa*af+ab*ag;var aA=ao*af+ap*ag;var am=aa*Y+ab*Z;var d=ao*Y+ap*Z;var R=(am-ak)*(am-ak)+(d-aA)*(d-aA);var X=1/R-0.25;if(X<0){X=0}var au=Math.sqrt(X);if(ac==ai){au=-au}var W=0.5*(ak+am)-au*(d-aA);var ah=0.5*(aA+d)+au*(am-ak);var av=Math.atan2(aA-ah,ak-W);var aw=Math.atan2(d-ah,am-W);var S=aw-av;if(S<0&&ac==1){S+=2*Math.PI}else{if(S>0&&ac==0){S-=2*Math.PI}}var aq=Math.ceil(Math.abs(S/(Math.PI*0.5+0.001)));var aj=[];for(var U=0;U<aq;U++){var ax=av+U*S/aq;var ay=av+(U+1)*S/aq;aj[U]=[W,ah,ax,ay,ad,ae,V,Q]}return aj},segmentToBezier:function(M,P,D,G,K,L,O,F){var t=F*K;var w=-O*L;var I=O*K;var J=F*L;var C=0.5*(G-D);var H=(8/3)*Math.sin(C*0.5)*Math.sin(C*0.5)/Math.sin(C);var z=M+Math.cos(D)-H*Math.sin(D);var N=P+Math.sin(D)+H*Math.cos(D);var B=M+Math.cos(G);var R=P+Math.sin(G);var A=B+H*Math.sin(G);var Q=R-H*Math.cos(G);return[t*z+w*N,I*z+J*N,t*A+w*Q,I*A+J*Q,t*B+w*R,I*B+J*R]},getLength:function(){var g=this.getSegments();if(g.arcLength==null){g.arcLength=0;var h=0,j=0;for(var k=0;k<g.length;k++){var l=g[k][1];if(l.length<2){continue}switch(g[k][0]){case"bezierCurveTo":g[k][3]=Curves.cubicLength([h,j],[l[0],l[1]],[l[2],l[3]],[l[4],l[5]]);break;case"quadraticCurveTo":g[k][3]=Curves.quadraticLength([h,j],[l[0],l[1]],[l[2],l[3]]);break;case"lineTo":g[k][3]=Curves.lineLength([h,j],[l[0],l[1]]);break}if(g[k][3]){g.arcLength+=g[k][3]}h=l[l.length-2];j=l[l.length-1]}}return g.arcLength},pointAngleAt:function(s,J){var C=[];var L=this.getSegments();var K=this.getLength();var w=0,z=0;for(var D=0;D<L.length;D++){var F=L[D];if(F[1].length<2){continue}if(F[0]!="moveTo"){C.push([w,z,F])}w=F[1][F[1].length-2];z=F[1][F[1].length-1]}if(C.length<1){return{point:[w,z],angle:0}}if(s>=1){var G=1;var F=C[C.length-1]}else{if(J&&J.discrete){var t=Math.floor(s*C.length);var F=C[t];var G=0}else{if(J&&J.linear){var t=s*C.length;var G=t-Math.floor(t);var F=C[Math.floor(t)]}else{var B=s*K;var u=0,t,G;for(var D=0;D<C.length;D++){if(u+C[D][2][3]>B){t=D;G=(B-u)/C[D][2][3];break}u+=C[D][2][3]}var F=C[t]}}}var H=0;var I=F[2][0];var A=F[2][1];switch(I){case"bezierCurveTo":return Curves.cubicLengthPointAngle([F[0],F[1]],[A[0],A[1]],[A[2],A[3]],[A[4],A[5]],G);break;case"quadraticCurveTo":return Curves.quadraticLengthPointAngle([F[0],F[1]],[A[0],A[1]],[A[2],A[3]],G);break;case"lineTo":w=Curves.linearValue(F[0],A[0],G);z=Curves.linearValue(F[1],A[1],G);H=Curves.lineAngle([F[0],F[1]],[A[0],A[1]],G);break}return{point:[w,z],angle:H}}});ImageNode=Klass(Drawable,{centered:false,usePattern:false,sX:0,sY:0,sWidth:null,sHeight:null,dX:0,dY:0,dWidth:null,dHeight:null,initialize:function(d,e){this.image=d;Drawable.initialize.call(this,e)},drawGeometry:function(l){if(Object.isImageLoaded(this.image)){var m=this.dWidth==null?this.image.width:this.dWidth;var k=this.dHeight==null?this.image.height:this.dHeight;var g=this.dX+(this.centered?-m*0.5:0);var j=this.dY+(this.centered?-k*0.5:0);if(this.dWidth!=null){if(this.sWidth!=null){l.drawImage(this.image,this.sX,this.sY,this.sWidth,this.sHeight,g,j,m,k)}else{l.drawImage(this.image,g,j,m,k)}}else{m=this.image.width;k=this.image.height;if(this.usePattern){if(!this.imagePattern){this.imagePattern=new Pattern(this.image,"repeat")}var h=this.imagePattern.compiled;if(!h){h=this.imagePattern.compile(l)}l.save();l.beginPath();l.rect(g,j,m,k);l.setFillStyle(h);l.fill();l.restore();l.beginPath()}else{l.drawImage(this.image,g,j)}}}else{var m=this.dWidth;var k=this.dHeight;if(!(m&&k)){return}var g=this.dX+(this.centered?-m*0.5:0);var j=this.dY+(this.centered?-k*0.5:0)}l.rect(g,j,m,k)},drawPickingPath:function(l){var h=this.dX+(this.centered?-this.image.width*0.5:0);var j=this.dY+(this.centered?-this.image.height*0.5:0);var g=this.dWidth;var k=this.dHeight;if(this.dWidth==null){g=this.image.width;k=this.image.height}l.rect(h,j,g,k)},isPointInPath:function(g,h){g-=this.dX;h-=this.dY;if(this.centered){g+=this.image.width*0.5;h+=this.image.height*0.5}var e=this.dWidth;var j=this.dHeight;if(this.dWidth==null){e=this.image.width;j=this.image.height}return((g>=0)&&(g<=e)&&(h>=0)&&(h<=j))},getBoundingBox:function(){x=this.dX;y=this.dY;if(this.centered){x-=this.image.width*0.5;y-=this.image.height*0.5}var e=this.dWidth;var d=this.dHeight;if(this.dWidth==null){e=this.image.width;d=this.image.height}return[x,y,e,d]}});ImageNode.load=function(g){var e=new Image();e.src=g;var d=new ImageNode(e);return d};TextNode=Klass(Drawable,{text:"Text",align:"start",baseline:"alphabetic",accuratePicking:false,asPath:false,pathGeometry:null,maxWidth:null,width:0,height:20,cx:0,cy:0,__drawMethodName:"draw"+CanvasSupport.getTextBackend(),__pickingMethodName:"drawPickingPath"+CanvasSupport.getTextBackend(),initialize:function(d,e){this.lastText=this.text;this.text=d;Drawable.initialize.call(this,e)},drawGeometry:function(b){this.drawUsing(b,this.__drawMethodName)},drawPickingPath:function(b){this.drawUsing(b,this.__pickingMethodName)},drawUsing:function(e,d){if(!this.text||this.text.length==0){return}if(this.lastText!=this.text||this.lastStyle!=e.font){this.dimensions=this.measureText(e);this.lastText=this.text;this.lastStyle=e.font}if(this[d]){this[d](e)}},measureText:function(e){var d="measureText"+CanvasSupport.getTextBackend().capitalize();if(this[d]){return this[d](e)}else{return{width:0,height:0}}},computeXForAlign:function(){if(this.align=="left"){return 0}else{if(this.align=="right"){return -this.dimensions.width}else{if(this.align=="center"){return -this.dimensions.width*0.5}}}},measureTextHTML5:function(b){return{width:b.measureText(this.text).width,height:20}},drawHTML5:function(b){b.fillText(this.text,this.cx,this.cy,this.maxWidth)},drawPickingPathHTML5:function(d){var e=15;var g=this.cy-e;d.rect(this.cx,g,this.dimensions.width,this.dimensions.height)},measureTextMozText:function(b){return{width:b.mozMeasureText(this.text),height:20}},drawMozText:function(d){var e=this.cx+this.computeXForAlign();var g=this.cy+0;if(this.pathGeometry){this.pathGeometry.draw(d);d.mozDrawTextAlongPath(this.text,this.path)}else{d.save();d.translate(e,g);if(this.asPath){d.mozPathText(this.text)}else{d.mozDrawText(this.text)}d.restore()}},drawPickingPathMozText:function(l){var g=this.cx+this.computeXForAlign();var j=this.cy+0;if(this.pathGeometry){this.pathGeometry.draw(l)}else{if(!this.accuratePicking){var h=15;var k=j-h;l.rect(g,k,this.dimensions.width,this.dimensions.height)}else{l.save();l.translate(g,j);l.mozPathText(this.text);l.restore()}}},drawDrawString:function(d){var e=this.cx+this.computeXForAlign();var g=this.cy+0;d.drawString(e,g,this.text)},measureTextPerfectWorld:function(b){return b.measureText(this.text)},drawPerfectWorld:function(b){if(this.pathGeometry){this.pathGeometry.draw(b);if(this.asPath){b.pathTextAlongPath(this.text)}else{b.drawTextAlongPath(this.text)}}else{if(this.asPath){b.pathText(this.text)}else{b.drawText(this.text)}}},drawPickingPathPerfectWorld:function(b){if(this.accuratePicking){if(this.pathGeometry){b.pathTextAlongPath(this.text)}else{b.pathText(this.text)}}else{if(this.pathGeometry){b.textRectAlongPath(this.text)}else{b.textRect(this.text)}}}});Gradient=Klass({type:"linear",isPattern:true,startX:0,startY:0,endX:1,endY:0,startRadius:0,endRadius:1,colorStops:[],initialize:function(b){this.colorStops=[[0,"#000000"],[1,"#FFFFFF"]];if(b){Object.extend(this,b)}},compile:function(n){if(this.type=="linear"){var g=n.createLinearGradient(this.startX,this.startY,this.endX,this.endY)}else{var g=n.createRadialGradient(this.startX,this.startY,this.startRadius,this.endX,this.endY,this.endRadius)}for(var m=0;m<this.colorStops.length;m++){var l=this.colorStops[m];if(typeof(l[1])=="string"){g.addColorStop(l[0],l[1])}else{var o=l[1];var a=(o.length==3)?1:o[3];var k="rgba("+o.slice(0,3).map(Math.round).join(",")+", "+a+")";g.addColorStop(l[0],k)}}Object.extend(g,Transformable.prototype);g.transformList=this.transformList;g.scale=this.scale;g.x=this.x;g.y=this.y;g.matrix=this.matrix;g.rotation=this.rotation;g.units=this.units;if(!g.isMockObject){this.compiled=g}return g}});Pattern=Klass({isPattern:true,repeat:"repeat",initialize:function(d,e){this.image=d;if(e){this.repeat=e}},compile:function(e){var d=e.createPattern(this.image,this.repeat);Object.extend(d,Transformable.prototype);d.transformList=this.transformList;d.scale=this.scale;d.x=this.x;d.y=this.y;d.matrix=this.matrix;d.rotation=this.rotation;d.units=this.units;if(!d.isMockObject){this.compiled=d}return d}});SVGParser={load:function(e,k){if(!k.onSuccess){throw ("Need to provide an onSuccess function.")}if(!k.filename){k.filename=e}var h=window.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject("MSXML2.XMLHTTP.3.0");h.open("GET",e,true);h.overrideMimeType("text/xml");var g=false;h.onreadystatechange=function(){if(h.readyState==4){if(h.status==200||h.status==0){try{var d=h.responseXML;var b=SVGParser.parse(d,k);b.svgRootElement=d}catch(a){if(k.onFailure){k.onFailure(h,a,e,k)}return}k.onSuccess(b,h,e,k)}else{if(k.onFailure&&!g){k.onFailure(h,null,e,k)}}}else{if(h.readyState==3){if(k.onLoading){k.onLoading(h,e,k)}}}};try{h.send(null)}catch(j){if(k.onFailure){k.onFailure(h,j,e,k);g=true}h.abort()}},parse:function(p,n){var k=new CanvasNode();var o=n.width,l=n.height,h=n.fontSize;k.innerWidth=o||window.innerWidth;k.innerHeight=l||window.innerHeight;k.innerSize=Math.sqrt(o*o+l*l)/Math.sqrt(2);k.fontSize=h||12;k.filename=n.filename||".";var j={};var m={ids:{},classes:{},tags:{}};k.color=n.currentColor||"black";this.parseChildren(p,k,j,m);k.defs=j;k.style=m;return k},parsePreserveAspectRatio:function(I,h,A,z,F){var I=I||"";var w=I.split(/\s+/);var J=(w[0]=="defer");if(J){w.shift()}var u=(w[0]||"xMidYMid");var D=(w[1]||"meet");var G=h/z;var C=A/F;var H={x:0,y:0,w:G,h:C};if(u=="none"){return H}H.w=H.h=(D=="meet"?Math.min:Math.max)(G,C);var K=u.slice(1,4).toLowerCase();var t=u.slice(5,8).toLowerCase();var s=(this.SVGAlignMap[K]||0);var B=(this.SVGAlignMap[t]||0);H.x=s*(h-z*H.w);H.y=B*(A-F*H.h);return H},SVGAlignMap:{min:0,mid:0.5,max:1},SVGTagMapping:{svg:function(u,s,C,G){var F=new Rectangle();F.width=0;F.height=0;F.doFill=function(){};F.doStroke=function(){};F.drawMarkers=function(){};F.fill="black";F.stroke="none";var t=u.getAttribute("viewBox");var p=u.getAttribute("width");var A=u.getAttribute("height");if(!p){p=A}else{if(!A){A=p}}if(p){var w=this.parseUnit(p,s,"x");var B=this.parseUnit(A,s,"y")}if(t){xywh=t.match(/[-+]?\d+/g).map(parseFloat);F.cx=xywh[0];F.cy=xywh[1];F.width=xywh[2];F.height=xywh[3];var D=s.innerWidth=F.width;var h=s.innerHeight=F.height;s.innerSize=Math.sqrt(D*D+h*h)/Math.sqrt(2);if(u.getAttribute("overflow")!="visible"){F.clip=true}}if(p){if(t){var H=u.getAttribute("preserveAspectRatio");var z=this.parsePreserveAspectRatio(H,w,B,F.width,F.height);F.cx-=z.x/z.w;F.cy-=z.y/z.h;F.width=w/z.w;F.height=B/z.h;F.x+=z.x;F.y+=z.y;F.scale=[z.w,z.h]}s.docWidth=w;s.docHeight=B}return F},marker:function(l,m){var p=new CanvasNode();p.draw=function(a){if(this.overflow!="hidden"&&this.viewBox){return}a.beginPath();a.rect(this.viewBox[0],this.viewBox[1],this.viewBox[2],this.viewBox[3]);a.clip()};var j=-this.parseUnit(l.getAttribute("refX"),m,"x")||0;var n=-this.parseUnit(l.getAttribute("refY"),m,"y")||0;p.transformList=[["translate",[j,n]]];p.markerUnits=l.getAttribute("markerUnits")||"strokeWidth";p.markerWidth=this.parseUnit(l.getAttribute("markerWidth"),m,"x")||3;p.markerHeight=this.parseUnit(l.getAttribute("markerHeight"),m,"y")||3;p.overflow=l.getAttribute("overflow")||"hidden";p.viewBox=l.getAttribute("viewBox");p.orient=l.getAttribute("orient")||0;if(p.orient&&p.orient!="auto"){p.orient=parseFloat(p.orient)*SVGMapping.DEG_TO_RAD_FACTOR}if(p.viewBox){p.viewBox=p.viewBox.strip().split(/[\s,]+/g).map(parseFloat);var k=p.viewBox[2]-p.viewBox[0];var q=p.viewBox[3]-p.viewBox[1];if(p.markerWidth){var o=sy=Math.min(p.markerWidth/k,p.markerHeight/q);p.transformList.unshift(["scale",[o,sy]])}}return p},clipPath:function(h,e){var g=new CanvasNode();g.units=h.getAttribute("clipPathUnits");return g},title:function(d,e){e.root.title=d.textContent},desc:function(d,e){e.root.description=d.textContent},metadata:function(d,e){e.root.metadata=d},parseAnimateTag:function(p,o){var A=SVGParser.SVGTagMapping.parseTime(p.getAttribute("begin"));var z=SVGParser.SVGTagMapping.parseTime(p.getAttribute("dur"));var s=SVGParser.SVGTagMapping.parseTime(p.getAttribute("end"));if(z==null){z=s-A}z=isNaN(z)?0:z;var t=p.getAttribute("attributeName");var m=p.getAttribute("fill");if(o.tagName=="rect"){if(t=="x"){t="cx"}if(t=="y"){t="cy"}}var n=p.getAttribute("accumulate")=="sum";var q=p.getAttribute("additive");if(q){q=q=="sum"}else{q=n}var w=p.getAttribute("repeatCount");if(w=="indefinite"){w=true}else{w=parseFloat(w)}if(!w&&z>0){var u=p.getAttribute("repeatDur");if(u=="indefinite"){w=true}else{w=SVGParser.SVGTagMapping.parseTime(u)/z}}return{after:isNaN(A)?0:A,duration:z,restart:p.getAttribute("restart"),calcMode:p.getAttribute("calcMode"),additive:q,accumulate:n,repeat:w,variable:t,fill:m}},parseTime:function(j){if(!j){return null}if(j.match(/[0-9]$/)){var k=j.split(":");var l=k[k.length-1]||0;var h=k[k.length-2]||0;var m=k[k.length-3]||0;return(parseFloat(m)*3600+parseFloat(h)*60+parseFloat(l))*1000}else{var g=60;if(j.match(/s$/i)){g=1}else{if(j.match(/h$/i)){g=3600}}return parseFloat(j)*g*1000}},animate:function(l,m){var n=this.parseUnit(l.getAttribute("from"),m,"x");var o=this.parseUnit(l.getAttribute("to"),m,"x");var q=this.parseUnit(l.getAttribute("by"),m,"x");var p=SVGParser.SVGTagMapping.parseAnimateTag(l,m);if(l.getAttribute("values")){var k=this;var j=l.getAttribute("values");j=j.split(";").map(function(b){var a=b.split(/[, ]+/);if(a.length>2){return a.map(function(d){return k.parseUnit(d,m,"x")})}else{if(a.length>1){return[k.parseUnit(a[0],m,"x"),k.parseUnit(a[1],m,"y")]}else{return k.parseUnit(b,m,"x")}}})}else{if(o==null){o=n+q}}m.after(p.after,function(){if(p.fill=="remove"){var g=Object.clone(this[p.variable]);this.after(p.duration,function(){this[p.variable]=g})}if(j){if(p.additive){var a=this[p.variable];j=j.map(function(u){return Object.sum(u,a)})}var t=0;var d=[];if(j[0] instanceof Array){for(var b=1;b<j.length;b++){var h=Object.sub(j[b]-j[b-1]);var s=Math.sqrt(h.reduce(function(u,w){return u+w*w},0));d.push(s);t+=s}}else{for(var b=1;b<j.length;b++){var s=Math.abs(j[b]-j[b-1]);d.push(s);t+=s}}var e=function(B){if(B==1){this[p.variable]=j[j.length-1]}else{if(p.calcMode=="paced"){var G=B*t;var J=0,H,F;for(var D=0;D<d.length;D++){if(J+d[D]>G){H=D;F=(G-J)/d[D];break}J+=d[D]}var I=H;var C=I+1}else{var H=B*(j.length-1);var I=Math.floor(H);var F=H-I;var C=I+1}this.tweenVariable(p.variable,j[I],j[C],F,p.calcMode)}};this.animate(e,n,o,p.duration,"linear",{repeat:p.repeat,additive:p.additive,accumulate:p.accumulate})}else{if(n==null){n=this[p.variable];if(q!=null){o=n+q}}if(p.additive){n=Object.sum(n,this[p.variable]);o=Object.sum(o,this[p.variable])}this.animate(p.variable,n,o,p.duration,p.calcMode,{repeat:p.repeat,additive:p.additive,accumulate:p.accumulate})}})},set:function(j,k){var g=j.getAttribute("to");var h=SVGParser.SVGTagMapping.parseAnimateTag(j,k);k.after(h.after,function(){if(h.fill=="remove"){var a=Object.clone(this[h.variable]);this.after(h.duration,function(){this[h.variable]=a})}this[h.variable]=g})},animateMotion:function(q,o){var l;if(q.getAttribute("path")){l=new Path(q.getAttribute("path"))}else{if(q.getAttribute("values")){var p=q.getAttribute("values");l=new Path("M"+p.split(";").join("L"))}else{if(q.getAttribute("from")||q.getAttribute("to")||q.getAttribute("by")){var n=q.getAttribute("from");var m=q.getAttribute("to");var s=q.getAttribute("by");if(!n){n="0,0"}if(!m){m="l"+s}else{m="L"+m}l=new Path("M"+n+m)}}}var w=new CanvasNode();w.__motionPath=l;var t=q.getAttribute("rotate");var u=SVGParser.SVGTagMapping.parseAnimateTag(q,o);o.after(u.after,function(){if(u.fill=="remove"){var a=this.x,b=this.y;this.after(u.duration,function(){this.x=a;this.y=b})}var d=function(e){var g=w.__motionPath.pointAngleAt(e,{discrete:u.calcMode=="discrete",linear:u.calcMode=="linear"});this.x=g.point[0];this.y=g.point[1];if(t=="auto"){this.rotation=g.angle}else{if(t=="auto-reverse"){this.rotation=g.angle+Math.PI}}};this.animate(d,0,1,u.duration,"linear",{repeat:u.repeat,additive:u.additive,accumulate:u.accumulate})});return w},mpath:function(j,k,h){var g=j.getAttribute("xlink:href");g=g.replace(/^#/,"");this.getDef(h,g,function(a){k.__motionPath=a})},animateColor:function(k,l,j){var m=k.getAttribute("from");var n=k.getAttribute("to");m=SVGParser.SVGMapping.__parseStyle(m,null,j);n=SVGParser.SVGMapping.__parseStyle(n,null,j);var h=SVGParser.SVGTagMapping.parseAnimateTag(k,l);l.after(h.after,function(){if(h.fill=="remove"){var a=Object.clone(this[h.variable]);this.after(h.duration,function(){this[h.variable]=a})}this.animate(h.variable,m,n,h.duration,"linear",{repeat:h.repeat,additive:h.additive,accumulate:h.accumulate})})},animateTransform:function(k,l){var m=k.getAttribute("from");var n=k.getAttribute("to");var j=k.getAttribute("by");var h=SVGParser.SVGTagMapping.parseAnimateTag(k,l);if(m){m=m.split(/[ ,]+/).map(parseFloat)}if(n){n=n.split(/[ ,]+/).map(parseFloat)}if(j){j=j.split(/[ ,]+/).map(parseFloat)}h.variable=k.getAttribute("type");if(h.variable=="rotate"){h.variable="rotation";if(m){m=m.map(function(a){return a*Math.PI/180})}if(n){n=n.map(function(a){return a*Math.PI/180})}if(j){j=j.map(function(a){return a*Math.PI/180})}}else{if(h.variable.match(/^skew/)){if(m){m=m.map(function(a){return a*Math.PI/180})}if(n){n=n.map(function(a){return a*Math.PI/180})}if(j){j=j.map(function(a){return a*Math.PI/180})}}}if(n==null){n=Object.sum(m,j)}l.after(h.after,function(){if(h.variable=="translate"){if(m==null){m=[this.x,this.y];if(j!=null){n=Object.sum(m,j)}}if(h.fill=="remove"){var b=this.x;var d=this.y;this.after(h.duration,function(){this.x=b;this.y=d})}this.animate("x",m[0],n[0],h.duration,"linear",{repeat:h.repeat,additive:h.additive,accumulate:h.accumulate});if(m[1]!=null){this.animate("y",m[1],n[1],h.duration,"linear",{repeat:h.repeat,additive:h.additive,accumulate:h.accumulate})}}else{if(m){if(m.length==1){m=m[0]}}if(n){if(n.length==1){n=n[0]}}if(j){if(j.length==1){j=j[0]}}if(m==null){m=this[h.variable];if(j!=null){n=Object.sum(m,j)}}if(h.variable=="scale"&&h.additive){h.additive=false}if(h.fill=="remove"){var a=Object.clone(this[h.variable]);this.after(h.duration,function(){this[h.variable]=a})}this.animate(h.variable,m,n,h.duration,"linear",{repeat:h.repeat,additive:h.additive,accumulate:h.accumulate})}})},a:function(j,k){var h=j.getAttribute("xlink:href")||j.getAttribute("href");var l=j.getAttribute("target");var g=new LinkNode(h,l);return g},use:function(k,l,j,h){var m=k.getAttribute("xlink:href")||k.getAttribute("href");var n=new CanvasNode();if(m){m=m.replace(/^#/,"");this.getDef(j,m,function(a){var d=a.clone();var b=n.parent;if(b){if(n.stroke){d.stroke=n.stroke}if(n.fill){d.fill=n.fill}n.append(d)}else{n=d}})}return n},image:function(k,l,j,h){var m=k.getAttribute("xlink:href")||k.getAttribute("href");if(m&&m.search(/^[a-z]+:/i)!=0){m=l.root.filename.split("/").slice(0,-1).join("/")+"/"+m}var n=new ImageNode(m?Object.loadImage(m):null);n.fill="none";n.dX=this.parseUnit(k.getAttribute("x"),l,"x")||0;n.dY=this.parseUnit(k.getAttribute("y"),l,"y")||0;n.srcWidth=this.parseUnit(k.getAttribute("width"),l,"x");n.srcHeight=this.parseUnit(k.getAttribute("height"),l,"y");return n},path:function(b){return new Path(b.getAttribute("d"))},polygon:function(b){return new Polygon(b.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat))},polyline:function(b){return new Polygon(b.getAttribute("points").toString().strip().split(/[\s,]+/).map(parseFloat),{closePath:false})},rect:function(h,e){var g=new Rectangle(this.parseUnit(h.getAttribute("width"),e,"x"),this.parseUnit(h.getAttribute("height"),e,"y"));g.cx=this.parseUnit(h.getAttribute("x"),e,"x")||0;g.cy=this.parseUnit(h.getAttribute("y"),e,"y")||0;g.rx=this.parseUnit(h.getAttribute("rx"),e,"x")||0;g.ry=this.parseUnit(h.getAttribute("ry"),e,"y")||0;return g},line:function(l,m){var j=this.parseUnit(l.getAttribute("x1"),m,"x")||0;var o=this.parseUnit(l.getAttribute("y1"),m,"y")||0;var k=this.parseUnit(l.getAttribute("x2"),m,"x")||0;var p=this.parseUnit(l.getAttribute("y2"),m,"y")||0;var n=new Line(j,o,k,p);return n},circle:function(h,e){var g=new Circle(this.parseUnit(h.getAttribute("r"),e)||0);g.cx=this.parseUnit(h.getAttribute("cx"),e,"x")||0;g.cy=this.parseUnit(h.getAttribute("cy"),e,"y")||0;return g},ellipse:function(h,e){var g=new Ellipse(this.parseUnit(h.getAttribute("rx"),e,"x")||0,this.parseUnit(h.getAttribute("ry"),e,"y")||0);g.cx=this.parseUnit(h.getAttribute("cx"),e,"x")||0;g.cy=this.parseUnit(h.getAttribute("cy"),e,"y")||0;return g},text:function(h,j){if(false){var e=new TextNode(h.textContent.strip());e.setAsPath(true);e.cx=this.parseUnit(h.getAttribute("x"),j,"x")||0;e.cy=this.parseUnit(h.getAttribute("y"),j,"y")||0;return e}else{var g=E("div",h.textContent.strip());g.style.marginTop="-1em";g.style.whiteSpace="nowrap";var e=new ElementNode(g);e.xOffset=this.parseUnit(h.getAttribute("x"),j,"x")||0;e.yOffset=this.parseUnit(h.getAttribute("y"),j,"y")||0;return e}},style:function(j,k,h,g){this.parseStyle(j,g)},defs:function(j,k,h,g){return new CanvasNode({visible:false})},linearGradient:function(o,m,q,w){var p=new Gradient({type:"linear"});p.color=m.color;if(o.getAttribute("color")){SVGParser.SVGMapping.color(p,o.getAttribute("color"),q,w)}p.svgNode=o;var t=o.getAttribute("x1");var g=o.getAttribute("y1");var u=o.getAttribute("x2");var n=o.getAttribute("y2");var s=o.getAttribute("gradientTransform");p.units=o.getAttribute("gradientUnits")||"objectBoundingBox";if(t){p.startX=parseFloat(t)*(t.charAt(t.length-1)=="%"?0.01:1)}if(g){p.startY=parseFloat(g)*(g.charAt(g.length-1)=="%"?0.01:1)}if(u){p.endX=parseFloat(u)*(u.charAt(u.length-1)=="%"?0.01:1)}if(n){p.endY=parseFloat(n)*(n.charAt(n.length-1)=="%"?0.01:1)}if(s){this.applySVGTransform(p,s,q,w)}this.parseStops(p,o,q,w);return p},radialGradient:function(n,g,p,z){var o=new Gradient({type:"radial"});o.color=g.color;if(n.getAttribute("color")){SVGParser.SVGMapping.color(o,n.getAttribute("color"),p,z)}o.svgNode=n;var A=n.getAttribute("r");var s=n.getAttribute("fx");var u=n.getAttribute("fy");var q=n.getAttribute("cx");var t=n.getAttribute("cy");var w=n.getAttribute("gradientTransform");o.units=n.getAttribute("gradientUnits")||"objectBoundingBox";if(A){o.endRadius=parseFloat(A)*(A.charAt(A.length-1)=="%"?0.01:1)}if(s){o.startX=parseFloat(s)*(s.charAt(s.length-1)=="%"?0.01:1)}if(u){o.startY=parseFloat(u)*(u.charAt(u.length-1)=="%"?0.01:1)}if(q){o.endX=parseFloat(q)*(q.charAt(q.length-1)=="%"?0.01:1)}if(t){o.endY=parseFloat(t)*(t.charAt(t.length-1)=="%"?0.01:1)}if(w){this.applySVGTransform(o,w,p,z)}this.parseStops(o,n,p,z);return o}},parseChildren:function(w,z,t,B){var j=[];var o=z;for(var s=0;s<w.childNodes.length;s++){var p=w.childNodes[s];var A=false;if(p.childNodes){if(p.tagName){if(this.SVGTagMapping[p.tagName]){A=this.SVGTagMapping[p.tagName].call(this,p,z,t,B)}else{A=new CanvasNode()}if(A){A.root=z.root;A.fontSize=o.fontSize;A.strokeWidth=o.strokeWidth;if(p.attributes){for(var u=0;u<p.attributes.length;u++){var q=p.attributes[u];if(this.SVGMapping[q.nodeName]){this.SVGMapping[q.nodeName](A,q.nodeValue,t,B)}}}if(A.id){this.setDef(t,A.id,A)}A.tagName=p.tagName;this.applySVGTransform(A,p.getAttribute("transform"),t,B);this.applySVGStyle(A,p.getAttribute("style"),t,B);if(A.tagName&&B.tags[A.tagName]){this.applySVGStyle(A,B.tags[A.tagName],t,B)}if(A.className&&B.classes[A.className]){this.applySVGStyle(A,B.classes[A.className],t,B)}if(A.id&&B.ids[A.id]){this.applySVGStyle(A,B.ids[A.id],t,B)}if(!A.marker){A.marker=o.marker}if(!A.markerStart){A.markerStart=o.markerStart}if(!A.markerEnd){A.markerEnd=o.markerEnd}if(!A.markerMid){A.markerMid=o.markerMid}}}if(A&&A.setRoot){A.zIndex=s;z.append(A);this.parseChildren(p,A,t,B)}}}},parseStyle:function(q,t){var k=q.textContent;var s=k.split(/\}/m);for(var o=0;o<s.length;o++){var p=s[o];var n=p.split(/\{/m);if(n.length<2){continue}var l=n[0].strip();var m=n[1].strip();switch(l.charAt(0)){case".":t.classes[l.slice(1)]=m;break;case"#":t.ids[l.slice(1)]=m;break;default:t.tags[l]=m;break}}},parseStops:function(u,C,z,G){var F=C.getAttribute("xlink:href");u.colorStops=[];if(F){F=F.replace(/^#/,"");this.getDef(z,F,function(a){if(u.colorStops.length==0){u.colorStops=a.colorStops}})}var g=[];for(var w=0;w<C.childNodes.length;w++){var s=C.childNodes[w];if(s.tagName=="stop"){var A=parseFloat(s.getAttribute("offset"));if(s.getAttribute("offset").search(/%/)!=-1){A*=0.01}var j=[A];j.color=u.color;for(var B=0;B<s.attributes.length;B++){var t=s.attributes[B];if(this.SVGMapping[t.nodeName]){this.SVGMapping[t.nodeName](j,t.nodeValue,z,G)}}this.applySVGStyle(j,s.getAttribute("style"),z,G);var D=s.getAttribute("id");if(D){this.setDef(z,D,j)}g.push(j)}}if(g.length>0){u.colorStops=g}},applySVGTransform:function(p,q,n,t){if(!q){return}p.transformList=[];var s=q.match(/[a-z]+\s*\([^)]*\)/ig);for(var m=0;m<s.length;m++){var l=s[m].split("(");var o=l[0].strip();if(this.SVGMapping[o]){var k=l[1].strip().slice(0,-1);this.SVGMapping[o](p,k,n,t)}}this.breakDownTransformList(p)},breakDownTransformList:function(d){var e=d.transformList;if(d.transformList.length==1){var g=e[0];if(g[0]=="translate"){d.x=g[1][0];d.y=g[1][1]}else{if(g[0]=="scale"){d.scale=g[1]}else{if(g[0]=="rotate"){d.rotation=g[1]}else{if(g[0]=="matrix"){d.matrix=g[1]}else{if(g[0]=="skewX"){d.skewX=g[1][0]}else{if(g[0]=="skewY"){d.skewY=g[1][0]}else{return}}}}}}d.transformList=null}},applySVGStyle:function(q,t,o,k){if(!t){return}var s=t.split(";");for(var n=0;n<s.length;n++){var m=s[n].split(":");var p=m[0].strip();if(this.SVGMapping[p]){var l=m[1].strip();this.SVGMapping[p](q,l,o,k)}}},getDef:function(e,g,d){if(e[g]&&e[g] instanceof Array){e[g].push(d)}else{if(e[g]){d(e[g])}else{e[g]=[d]}}},setDef:function(g,h,j){if(g[h]&&g[h] instanceof Array){for(var e=0;e<g[h].length;e++){g[h][e](j)}}g[h]=j},parseUnit:function(e,g,d){if(e==null){return null}else{return this.parseUnitMultiplier(e,g,d)*parseFloat(e.strip())}},parseUnitMultiplier:function(h,j,e){var g=this.getCmInPixels();if(h.search(/cm$/i)!=-1){return g}else{if(h.search(/mm$/i)!=-1){return 0.1*g}else{if(h.search(/pt$/i)!=-1){return 0.0352777778*g}else{if(h.search(/pc$/i)!=-1){return 0.4233333333*g}else{if(h.search(/in$/i)!=-1){return 2.54*g}else{if(h.search(/em$/i)!=-1){return j.fontSize}else{if(h.search(/ex$/i)!=-1){return j.fontSize/2}else{if(h.search(/%$/i)!=-1){if(e=="x"){return j.root.innerWidth*0.01}else{if(e=="y"){return j.root.innerHeight*0.01}else{return j.root.innerSize*0.01}}}else{return 1}}}}}}}}},getCmInPixels:function(){if(!this.cmInPixels){var d=E("div",{style:{margin:"0px",padding:"0px",width:"1cm",height:"1cm",position:"absolute",visibility:"hidden"}});document.body.appendChild(d);var e=d.offsetWidth;document.body.removeChild(d);this.cmInPixels=e||38}return this.cmInPixels},getEmInPixels:function(){if(!this.emInPixels){var d=E("div",{style:{margin:"0px",padding:"0px",width:"1em",height:"1em",position:"absolute",visibility:"hidden"}});document.body.appendChild(d);var e=d.offsetWidth;document.body.removeChild(d);this.emInPixels=e||12}return this.emInPixels},getExInPixels:function(){if(!this.exInPixels){var d=E("div",{style:{margin:"0px",padding:"0px",width:"1ex",height:"1ex",position:"absolute",visibility:"hidden"}});document.body.appendChild(d);var e=d.offsetWidth;document.body.removeChild(d);this.exInPixels=e||6}return this.exInPixels},SVGMapping:{DEG_TO_RAD_FACTOR:Math.PI/180,RAD_TO_DEG_FACTOR:180/Math.PI,parseUnit:function(e,g,d){return SVGParser.parseUnit(e,g,d)},"class":function(d,e){d.className=e},marker:function(g,d,e){SVGParser.getDef(e,d.replace(/^url\(#|\)$/g,""),function(a){g.marker=a})},"marker-start":function(g,d,e){SVGParser.getDef(e,d.replace(/^url\(#|\)$/g,""),function(a){g.markerStart=a})},"marker-end":function(g,d,e){SVGParser.getDef(e,d.replace(/^url\(#|\)$/g,""),function(a){g.markerEnd=a})},"marker-mid":function(g,d,e){SVGParser.getDef(e,d.replace(/^url\(#|\)$/g,""),function(a){g.markerMid=a})},"clip-path":function(g,d,e){SVGParser.getDef(e,d.replace(/^url\(#|\)$/g,""),function(a){g.clipPath=a})},id:function(d,e){d.id=e},translate:function(d,e){var g=e.split(/[\s,]+/).map(parseFloat);d.transformList.push(["translate",[g[0],g[1]||0]])},rotate:function(j,e){if(e=="auto"||e=="auto-reverse"){return}var g=e.split(/[\s,]+/).map(parseFloat);var h=g[0]*this.DEG_TO_RAD_FACTOR;if(g.length>1){j.transformList.push(["rotate",[h,g[1],g[2]||0]])}else{j.transformList.push(["rotate",[h]])}},scale:function(j,g){var h=g.split(/[\s,]+/).map(parseFloat);var e=["scale"];if(h.length>1){e[1]=[h[0],h[1]]}else{e[1]=[h[0],h[0]]}j.transformList.push(e)},matrix:function(g,e){var d=e.split(/[\s,]+/).map(parseFloat);g.transformList.push(["matrix",d])},skewX:function(d,e){var g=parseFloat(e)*this.DEG_TO_RAD_FACTOR;d.transformList.push(["skewX",[g]])},skewY:function(d,e){var g=parseFloat(e)*this.DEG_TO_RAD_FACTOR;d.transformList.push(["skewY",[g]])},opacity:function(d,e){d.opacity=parseFloat(e)},display:function(d,e){d.display=e},visibility:function(d,e){d.visibility=e},"stroke-miterlimit":function(d,e){d.miterLimit=parseFloat(e)},"stroke-linecap":function(d,e){d.lineCap=e},"stroke-linejoin":function(d,e){d.lineJoin=e},"stroke-width":function(d,e){d.strokeWidth=this.parseUnit(e,d)},fill:function(h,e,g,j){h.fill=this.__parseStyle(e,h.fill,g,h.color)},stroke:function(h,e,g,j){h.stroke=this.__parseStyle(e,h.stroke,g,h.color)},color:function(h,e,g,j){if(e=="inherit"){return}h.color=this.__parseStyle(e,false,g,h.color)},"stop-color":function(h,e,g,j){if(e=="none"){h[1]=[0,0,0,0]}else{h[1]=this.__parseStyle(e,h[1],g,h.color)}},"fill-opacity":function(d,e){d.fillOpacity=Math.min(1,Math.max(0,parseFloat(e)))},"stroke-opacity":function(d,e){d.strokeOpacity=Math.min(1,Math.max(0,parseFloat(e)))},"stop-opacity":function(d,e){d[1]=d[1]||[0,0,0];d[1][3]=Math.min(1,Math.max(0,parseFloat(e)))},"text-anchor":function(d,e){d.textAnchor=e;if(d.setAlign){if(e=="middle"){d.setAlign("center")}else{d.setAlign(e)}}},"font-family":function(d,e){d.fontFamily=e},"font-size":function(d,e){d.fontSize=this.parseUnit(e,d)},__parseStyle:function(p,o,s,a){if(p.charAt(0)=="#"){if(p.length==4){p=p.replace(/([^#])/g,"$1$1")}var q=p.slice(1).match(/../g).map(function(b){return parseInt(b,16)});return q}else{if(p.search(/^rgb\(/)!=-1){var q=p.slice(4,-1).split(",");for(var n=0;n<q.length;n++){var l=q[n].strip();if(l.charAt(l.length-1)=="%"){q[n]=Math.round(parseFloat(l.slice(0,-1))*2.55)}else{q[n]=parseInt(l)}}return q}else{if(p.search(/^rgba\(/)!=-1){var q=p.slice(5,-1).split(",");for(var n=0;n<3;n++){var l=q[n].strip();if(l.charAt(l.length-1)=="%"){q[n]=Math.round(parseFloat(l.slice(0,-1))*2.55)}else{q[n]=parseInt(l)}}var l=q[3].strip();if(l.charAt(l.length-1)=="%"){q[3]=Math.round(parseFloat(l.slice(0,-1))*0.01)}else{q[3]=Math.max(0,Math.min(1,parseFloat(l)))}return q}else{if(p.search(/^url\(/)!=-1){var m=p.match(/\([^)]+\)/)[0].slice(1,-1).replace(/^#/,"");if(s[m]){return s[m]}else{return"rgba(255,0,255,1)"}}else{if(p=="currentColor"){return a}else{if(p=="none"){return"none"}else{if(p=="freeze"){return null}else{if(p=="remove"){return null}else{return p}}}}}}}}}}};var cacophony=(function(I){var W={},A,O,t,j,n,e,H,Y=false,a=854,g=480,M=Math.floor(a/128),J=32,F=false,P=0,X=120,l=false,m=1,N=500,R=125,K=0,U=false,k=false,L=false,p=[],s="c",Q,V,C,S=false,q=false,d=0,b="rgba(227, 234, 234, 1)",z=navigator.userAgent.match(/iPad/i),u=navigator.userAgent.match(/iPhone|iPod/i),o=[],D=[],h=[],B=[],G={mp4:"video/mp4; codecs='avc1.42E01E, mp4a.40.2'",webm:"video/webm",ogv:"video/ogg"};W.canvas;W.wrapper;W.id;W.width=854;W.height=480;W.w=Math.floor(a/128);W.scale=32;W.bg;W.bg2;W.beat=0;W.eq;W.playing=false;W.input=false;W.mousex=427;W.mousey=240;W.preloaded_images={context:null,ribbon:null};W.enable_ipad=false;W.callback={browser_check:false,loading:false,ready:false,play:false,pause:false,timeupdate:false,ended:false};W.effects=[];W.story=[];W.eq_data=[];W.datafeed={};W.ended=false;W.duration=false;W.setVideo=function(){h=arguments};W.codec=function(w){if(w.match(/\.(mp4|m4v)$/i)){return G.mp4}else{if(w.match(/\.webm$/i)){return G.webm}else{if(w.match(/\.(ogv|ogg|ogm)$/i)){return G.ogv}}}return""};W.visible=function(w){if(I.isArray(w)){if(!w[0]){I("#cacophony-video").hide()}else{I("#cacophony-video").show()}if(!w[1]){I("#cacophony-canvas1").hide()}else{I("#cacophony-canvas1").show()}if(!w[2]){I("#cacophony-canvas2").hide()}else{I("#cacophony-canvas2").show()}if(!w[3]){I("#cacophony-canvas3").hide()}else{I("#cacophony-canvas3").show()}if(!w[4]){I("#cacophony-canvas4").hide()}else{I("#cacophony-canvas4").show()}}else{if(w==0){I("#cacophony-video").show()}else{if(w==1){I("#cacophony-canvas1").show()}else{if(w==2){I("#cacophony-canvas2").show()}else{if(w==3){I("#cacophony-canvas3").show()}else{if(w==4){I("#cacophony-canvas4").show()}}}}}}};W.hide=function(w){if(w==0){I("#cacophony-video").hide()}else{if(w==1){I("#cacophony-canvas1").hide()}else{if(w==2){I("#cacophony-canvas2").hide()}else{if(w==3){I("#cacophony-canvas3").hide()}else{if(w==4){I("#cacophony-canvas4").hide()}}}}}};W.pause=function(){button=I("#cacophony-play").blur();t.pause();W.clearIntervals();F=false;W.playing=false;button.html('<span title="Play" style="font-size: 20px">&#x2023;</span>');if(W.callback.pause){return W.callback.pause()}return false};W.play=function(w){if(!q){return false}if(W.ended){W.ended=false;K=0;t.currentTime=0}button=I("#cacophony-play").blur();Y=true;t.play();W.setIntervals();F=true;W.playing=true;button.html('<span title="Pause">||</span>');if(W.callback.play){return W.callback.play()}return false};W.playPause=function(){if(F){return W.pause()}else{return W.play()}};W.loading=function(){if(z){d+=Math.round(Math.random()*5+1);if(d>=100){q=true;W.duration=t.duration;if(W.callback.ready){return W.callback.ready()}}else{if(W.callback.loading){W.callback.loading(d)}setTimeout(W.loading,Math.round(Math.random()*6+2)*100)}return}if(t.readyState==4||(I.browser.mozilla&&t.readyState>=2)||(I.browser.msie&&t.readyState>=3)){q=true;W.duration=t.duration;if(W.callback.ready){return W.callback.ready()}}else{try{d=parseInt((t.buffered.end(t.buffered.length-1)/t.duration)*100);if(W.callback.loading){W.callback.loading(d)}}catch(w){}setTimeout(W.loading,250)}};W.init=function(){id="cacophony";A=I("#cacophony");O=id;W.wrapper=A;W.id=O;sources="";for(var Z=0;Z<h.length;Z++){sources+='<source src="'+h[Z]+'" type="'+W.codec(h[Z])+'" />'}A.html('<div id="cacophony-duration"><div id="cacophony-play" onclick="return cacophony.playPause (this)"><span title="Pause">||</span></div><span id="cacophony-time">0:00</span></div><div id="cacophony-video-wrapper"><video id="cacophony-video" width="'+a+'" height="'+g+'" style="z-index: 2; margin: 0px; padding: 0px">'+sources+'</video></div><div id="cacophony-canvas1" style="width:'+a+"px; height:"+g+"px; z-index: 3; margin: 0px; padding: 0px; margin-top: -"+(g+2)+'px; border: 1px solid transparent"></div><div id="cacophony-canvas2" style="display: none; width:'+a+"px; height:"+g+"px; z-index: 4; margin: 0px; padding: 0px; margin-top: -"+(g+2)+'px; border: 1px solid transparent"></div><div id="cacophony-canvas3" style="display: none; width:'+a+"px; height:"+g+"px; z-index: 5; margin: 0px; padding: 0px; margin-top: -"+(g+2)+'px; border: 1px solid transparent"></div><div id="cacophony-canvas4" style="display: none; width:'+a+"px; height:"+g+"px; z-index: 6; margin: 0px; padding: 0px; margin-top: -"+(g+2)+'px; border: 1px solid transparent"></div>');var aa="This video is processor intensive. Please shut down other programs and close unnecessary browser tabs to ensure the best viewing experience. Thanks!",w=true;if(I.browser.msie&&I.browser.version<"9.0"){aa='This video requires the Google Chrome Frame browser plugin in order to work in Internet Explorer 6, 7, or 8. Please <a href="http://google.com/chromeframe" target="_blank">install the plugin here</a>, or use one of the following browsers to view this video:<ul><li><a href="http://www.google.com/chrome">Chrome</a></li><li><a href="http://www.apple.com/safari/">Safari</a></li><li><a href="http://www.mozilla.com/firefox/">Firefox</a></li></ul>';w=false}else{if(I.browser.mozilla&&I.browser.version<"1.9.2"){aa='This video requires a newer version of the Firefox browser in order to work. Please <a href="http://www.mozilla.com/firefox/" target="_blank">install the latest version here</a>.';w=false}else{if(!W.enable_ipad&&(u||z)){aa='This video requires more processing power than is currently available on the iPad, iPhone, or iPod touch. Please use a computer with one of the following browsers to view this video:<ul><li><a href="http://www.google.com/chrome">Chrome</a></li><li><a href="http://www.apple.com/safari/">Safari</a></li><li><a href="http://www.mozilla.com/firefox/">Firefox</a></li></ul>';w=false}}}if(W.callback.browser_check){W.callback.browser_check(aa,w)}if(!w){return}t=I("#cacophony-video").get(0);t.load();e=new Canvas(I("#cacophony-canvas1").get(0),a,g);n=e.canvas.getAttribute("id");W.canvas=e;V=new Rectangle(a,g);V.x=0;V.y=0;V.fill=b;e.append(V);W.bg=V;C=new Rectangle(a,g);C.x=0;C.y=0;C.fill="rgba(27, 1, 1, 0)";e.append(C);W.bg2=C;setTimeout(W.loading,250);I("#cacophony-video").bind("timeupdate",function(){W.displayTime();if(W.callback.timeupdate){return W.callback.timeupdate(t.currentTime)}});I("#cacophony-video").bind("ended",function(){W.pause();W.ended=true;if(W.callback.ended){return W.callback.ended()}});setInterval(function(){W.downBeat(t.currentTime*1000)},(N*1000)/20);I(document).keydown(function(ab){if(!W.input&&ab.keyCode==32){W.playPause()}});I("#cacophony").mousemove(function(ac){cacophony.mousex=ac.pageX-this.offsetLeft;cacophony.mousey=ac.pageY-this.offsetTop;if(cacophony.playing){for(var ab=0;ab<B.length;ab++){B[ab]()}}})};W.mousemove=function(w){B.push(w)};W.displayTime=function(){var ab=t.currentTime,Z=Math.floor(ab/60),aa=Math.ceil(ab-(Z*60)),w;if(aa==60){Z++;aa=0}w=Z+":"+(aa<10?"0"+aa:aa);if(w!=P){P=w;I("#cacophony-time").html(P)}};W.downBeat=function(Z){if(!Y||!F){return false}if(p[K]&&Z<p[K]){return false}L=true;W.beat=K;if(W.eq_data[K]){bn=W.eq_data[K];Q=bn.e;W.eq=Q}else{Q=[];W.eq=[]}if(W.story[K]){for(var w=0;w<W.story[K].length;w++){if(W.story[K][w].d){W.effects[W.story[K][w].a](W.story[K][w].d)}else{W.effects[W.story[K][w].a]()}}}if(U!==false){t.currentTime=t.currentTime+((U-K)*N);K=Math.ceil(U);U=false;k=false;W.downBeat(t.currentTime);return}K++;L=false};W.timeToBeat=function(w){return Math.floor(w/N)};W.jumpTo=function(w){if(!F){t.currentTime=t.currentTime+((w-K)*N);K=Math.ceil(w);W.play();return}U=w;k=false};W.jumpToTime=function(w,Z){if(!F&&Z){W.play()}k=w;U=W.timeToBeat(w);if(L){return}t.currentTime=k;K=U;U=false;k=false;W.downBeat(t.currentTime)};W.html=function(aa,ac,ab){if(!aa){cacophony.canvas.remove(H);H=false}else{var w,Z;if(H){cacophony.canvas.remove(H);H=false}w=(ac!=null)?ac:(W.height-(W.height*0.35))/2-20;Z=(ab!=null)?ab:Z=(W.width-(W.width*0.6))/2-20;H=new ElementNode(E("div",aa),{x:Z,y:w,noScaling:true});H.element.setAttribute("id","cacophony-html");W.canvas.append(H);return H}};W.setKey=function(w){s=w};W.setSize=function(Z,w){a=Z;g=w;M=Math.floor(a/128);W.width=a;W.height=g;W.w=M};W.setVolume=function(w){if(w<0){w=0}else{if(w>1){w=1}}if(w==0){t.muted=true}else{t.volume=w;if(t.muted){t.muted=false}}};W.getVolume=function(){return t.volume};W.setBPM=function(Z){Z=Z;N=60/Z;R=N/4;var aa=N*(Z*60*8);p=[];for(var w=0;w<=aa;w+=N){p.push(w*1000)}};W.beatLength=function(){return N*1000};W.preloadData=function(){for(var w=0;w<arguments.length;w++){I.ajax({url:arguments[w],success:function(ac){W.datafeed[I(this)[0].url]=ac;try{var Z=ac.getElementsByTagName("content");for(var aa=0;aa<Z.length;aa++){if(Z[aa].getAttribute("type").match(/^image\//)){W.preloadImages(Z[aa].getAttribute("url"))}}Z=ac.getElementsByTagName("img");for(var aa=0;aa<Z.length;aa++){W.preloadImages(Z[aa].getAttribute("src"))}}catch(ab){}},error:function(ab,Z,aa){}})}};W.preloadImages=function(){for(var w=0;w<arguments.length;w++){if(!W.preloaded_images[arguments[w]]){W.preloaded_images[arguments[w]]=document.createElement("img");W.preloaded_images[arguments[w]].src=arguments[w]}}};W.addInterval=function(w,Z){o.push({f:w,t:false,m:Z});if(F){o[o.length-1].t=setInterval(w,Z)}return o.length-1};W.removeInterval=function(w){o=o.slice(w,1)};W.setIntervals=function(){for(var w=0;w<o.length;w++){o[w].t=setInterval(o[w].f,o[w].m)}};W.clearIntervals=function(){for(var w=0;w<o.length;w++){clearInterval(o[w].t)}};W.dist=function(ab,ad,aa,ac){var Z=ab-aa,w=ad-ac;return Math.sqrt(Z*Z+w*w)};return W}(jQuery));_c=cacophony;_s=cacophony.story;_e=cacophony.effects;_i=cacophony.preloaded_images;function min(g){var d={value:g[0],index:0};for(var e in g){if(g[e]<d.value){d.value=g[e];d.index=e}}return d}Object.forceExtend=function(h,j){for(var g in j){try{h[g]=j[g]}catch(e){}}return h};if(!Object.extend){Object.extend=Object.forceExtend}function getKeyValue(h,g,k){if(typeof(h)=="string"){h=[h]}for(var j=0;j<=h.length-1;j++){var l=h[j];if(typeof(k[l])!="undefined"){return k[l]}}return g}if(!Array.indexOf){Array.prototype.indexOf=function(d){for(var e=0;e<this.length;e++){if(this[e]==d){return e}}return -1}}function hsl2rgb(g,h,l,n){if(g==360){g=0}while(g<0){g+=360}while(g>360){g-=360}var a,b,o;if(g<120){a=(120-g)/60;b=g/60;o=0}else{if(g<240){a=0;b=(240-g)/60;o=(g-120)/60}else{a=(g-240)/60;b=0;o=(360-g)/60}}a=Math.min(a,1);b=Math.min(b,1);o=Math.min(o,1);a=2*h*a+(1-h);b=2*h*b+(1-h);o=2*h*o+(1-h);if(l<0.5){a=l*a;b=l*b;o=l*o}else{a=(1-l)*a+2*l-1;b=(1-l)*b+2*l-1;o=(1-l)*o+2*l-1}a=Math.ceil(a*255);b=Math.ceil(b*255);o=Math.ceil(o*255);return"rgba("+a+", "+b+", "+o+", "+n+")"}function Tokenizer(){this._input=null;this._gStopChars=[" ","{","}","\n","\r","\t"];this._tokenizeNext=function(p){var o=[];var n=this;for(var q=0;q<this._gStopChars.length;q++){var m=this._gStopChars[q];var l=n._input.indexOf(m,p);if(l!=-1){o.push(l+1)}}var t=min(o);var m=this._gStopChars[t.index];var k=t.value;if(typeof(t.value)=="undefined"){return null}var s=this._input.substr(p,k-p);s=s.replace(/[ \n\r\t]/,"");return{token:s,lastPos:k}};this._tokenize=function(){this._input=this._input.replace(/([{}])/g," $1");var d=[];var e={lastPos:0};while(1==1){e=this._tokenizeNext(e.lastPos);if(e==null){break}if(e.token){d.push(e.token)}}return d};this._load=function(e){var d=document.getElementById(e);this._input=d.value};this.tokenize=function(b){this._load(b);return this._tokenize()}}function Compiler(){this._keywords=["startshape","rule","background"];this._compiled={};this._state=null;var b=this;this._generalState=function(){this.eat=function(a){if(b._keywords.indexOf(a)!=-1){b._state=new b["_"+a+"State"]()}else{console.log(a," is not a general state token!")}}};this._startshapeState=function(){this.eat=function(a){b._compiled.startshape=a;b._state=new b._generalState()}};this._backgroundState=function(){this._realState=new b._abstractArgumentState();this._realState.onDone=function(a){b._compiled.background=a;b._state=new b._generalState()};Object.extend(this,this._realState)};this._abstractArgumentState=function(){this._curKey=null;this._curValues=[];this._obj={};this._flushKey=function(){if(this._curKey){if(this._curValues.length==1){this._obj[this._curKey]=this._curValues[0]}else{this._obj[this._curKey]=this._curValues}}};this.eat=function(a){switch(a){case"}":this._flushKey();this.onDone(this._obj);case"{":return}if(a.match(/[a-z_]+/i)){this._flushKey();this._curKey=a;this._curValues=[]}else{this._curValue=this._curValues.push(parseFloat(a))}};this.onDone=function(a){}};this._ruleState=function(){this.eat=function(a){var d=a;if(!b._compiled[d]){b._compiled[d]=[]}b._state=new b._ruleWeightState(d)}};this._ruleWeightState=function(a){this._weight=1;this.eat=function(d){if(d!="{"){this._weight=parseFloat(d)}else{b._compiled[a].push({weight:this._weight,draw:[]});b._state=new b._ruleDrawState(a)}}};this._ruleDrawState=function(a){this.eat=function(e){if(e=="}"){b._state=new b._generalState();return}var g=e;b._state=new (function(){this._state=new b._abstractArgumentState();this._state.onDone=function(d){var l={shape:g};for(var k in d){l[k]=d[k]}var j=b._compiled[a].length-1;b._compiled[a][j].draw.push(l);b._state=new b._ruleDrawState(a)};Object.extend(this,this._state)})()}};this.compile=function(a){b._state=new b._generalState();a.reverse();while(a.length>0){this._state.eat(a.pop())}return b._compiled}}function colorToRgba(b){return hsl2rgb(b.h,b.s,b.b,b.a)}function adjustColor(g,j){var l={h:g.h,s:g.s,b:g.b,a:g.a};l.h+=getKeyValue(["h","hue"],0,j);l.h%=360;var h={};h.s=getKeyValue(["sat","saturation"],0,j);h.b=getKeyValue(["b","brightness"],0,j);h.a=getKeyValue(["a","alpha"],0,j);for(var k in h){if(h[k]>0){l[k]+=h[k]*(1-g[k])}else{l[k]+=h[k]*g[k]}}return l}function IdentityTransformation(){return[[1,0,0],[0,1,0],[0,0,1]]}function toAffineTransformation(l,m,a,d,n,b){return[[l,m,n],[a,d,b],[0,0,1]]}function compose(n,o){var h=IdentityTransformation();for(var j=0;j<3;j++){for(var k=0;k<3;k++){var m=0;for(var l=0;l<3;l++){m+=n[j][l]*o[l][k]}h[j][k]=m}}return h}Renderer={canvas:null,ctx:null,width:null,height:null,compiled:null,_maxThreads:30,queue:[],render:function(e,d){Renderer.compiled=e;Renderer.canvas=document.getElementById(d);Renderer.ctx=Renderer.canvas.getContext("2d");Renderer.width=Renderer.canvas.width;Renderer.height=Renderer.canvas.height;Renderer._globalScale=300;Renderer._rendering=false;Renderer.drawBackground();Renderer.setupEventHandlers();Renderer.draw();Renderer.tick()},tick:function(){if(Renderer.queue.length>0){Renderer._rendering=true;var h=new Date();var j=Math.min(Renderer.queue.length-1,Renderer._maxThreads);for(var e=0;e<=j;e++){Renderer.queue.shift().start()}var g=new Date();setTimeout(Renderer.tick,2*(g-h))}Renderer._rendering=false},setupEventHandlers:function(){var d=function(b,a){var j={h:0,s:0,b:0,a:1};var h=toAffineTransformation(1,0,0,1,(a.pageX-Renderer.width/2)/Renderer._globalScale,(a.pageY-Renderer.height/2)/Renderer._globalScale);Renderer.drawRule(b,h,j,1);if(!Renderer._rendering){Renderer.tick()}};var g=getKeyValue("MOUSECLICK",null,Renderer.compiled);if(g){$(Renderer.canvas).click(function(a){d("MOUSECLICK",a)})}var e=getKeyValue("MOUSEMOVE",null,Renderer.compiled);if(e){$(Renderer.canvas).mousemove(function(a){d("MOUSEMOVE",a)})}},drawBackground:function(){if(Renderer.compiled.background){var e=Renderer.compiled.background;var g={h:0,s:0,b:1,a:1};var h=adjustColor(g,e);Renderer.ctx.fillStyle=colorToRgba(h);Renderer.ctx.fillRect(0,0,Renderer.width,Renderer.width)}},draw:function(){var d=Renderer.compiled.startshape;var e={h:0,s:0,b:0,a:1};Renderer.drawRule(d,IdentityTransformation(),e)},drawRule:function(l,s,q,m){if(Math.abs(s[0][1])*Renderer._globalScale<0.5&&Math.abs(s[1][1])*Renderer._globalScale<0.5){return}var k=Renderer.compiled[l];var o=0;for(var p=0;p<k.length;p++){o+=k[p].weight}var t=Math.random()*o;o=0;for(var p=0;p<=k.length-1;p++){o+=k[p].weight;if(t<=o){var n=k[p];break}}Renderer.drawShape(n,s,q,m)},_draw:function(h,l){if(Renderer.ctx.setTransform){Renderer.setTransform(h);l(Renderer.ctx);return}var j=toAffineTransformation(Renderer._globalScale,0,0,Renderer._globalScale,Renderer.width/2,Renderer.height/2);var g=compose(j,h);Renderer.ctx.save();if(Renderer.ctx.transform){Renderer.ctx.transform(g[0][0],g[1][0],g[0][1],g[1][1],g[0][2],g[1][2]);l(Renderer.ctx)}else{var k=svdTransform(g);Renderer.ctx.translate(k.dx,k.dy);Renderer.ctx.rotate(k.angle2);Renderer.ctx.scale(k.sx,k.sy);Renderer.ctx.rotate(k.angle1)}l(Renderer.ctx);Renderer.ctx.restore()},drawShape:function(o,s,q,m){for(i=0;i<o.draw.length;i++){var k=o.draw[i];var l=Renderer.adjustTransform(k,s);var p=adjustColor(q,k);switch(k.shape){case"CIRCLE":Renderer._draw(l,function(a){a.beginPath();a.fillStyle=colorToRgba(p);a.arc(0,0,0.5,0,2*Math.PI,true);a.fill();a.closePath()});break;case"SQUARE":Renderer._draw(l,function(a){a.beginPath();a.fillStyle=colorToRgba(p);a.fillRect(-0.5,-0.5,1,1);a.closePath()});break;case"TRIANGLE":Renderer._draw(l,function(d){d.beginPath();var a=0.57735;d.moveTo(0,-a);for(var b=1;b<=3;b++){d.lineTo(a*Math.sin(b*2*Math.PI/3),-a*Math.cos(b*2*Math.PI/3))}d.fillStyle=colorToRgba(p);d.fill();d.closePath()});break;default:var t=function(b,a,d){this.start=function(){Renderer.drawRule(b,a,d)}};var n=new t(k.shape,l,p);if(m==1){Renderer.queue.unshift(n)}else{Renderer.queue.push(n)}break}}},setTransform:function(b){Renderer.ctx.setTransform(Renderer._globalScale,0,0,Renderer._globalScale,Renderer.width/2,Renderer.height/2);Renderer.ctx.transform(b[0][0],b[1][0],b[0][1],b[1][1],b[0][2],b[1][2])},adjustTransform:function(u,D){var q=getKeyValue("x",0,u);var s=-getKeyValue("y",0,u);if(q!=0||s!=0){var C=toAffineTransformation(1,0,0,1,q,s);D=compose(D,C)}var G=getKeyValue(["r","rotate"],null,u);if(G!=null){var t=Math.cos(-2*Math.PI*G/360);var F=Math.sin(-2*Math.PI*G/360);var A=toAffineTransformation(t,-F,F,t,0,0);D=compose(D,A)}var p=getKeyValue(["s","size"],1,u);if(typeof(p)=="number"){p=[p,p]}if(p!=1){var B=toAffineTransformation(p[0],0,0,p[1],0,0);D=compose(D,B)}var w=getKeyValue(["f","flip"],null,u);if(w!=null){vX=Math.cos(-2*Math.PI*w/360);vY=Math.sin(-2*Math.PI*w/360);norm=1/(vX*vX+vY*vY);var z=toAffineTransformation((vX*vX-vY*vY)/norm,2*vX*vY/norm,2*vX*vY/norm,(vY*vY-vX*vX)/norm,0,0);D=compose(D,z)}return D}};function contextFree(l,n){var k=new Tokenizer();var o=k.tokenize(l);var m=new Compiler();var p=m.compile(o);var j=Renderer;Renderer.queue=[];j.render(p,n)}svdTransform=(function(){var j={};j.Matrix2D=function(d){if(d){if(typeof d=="number"){this.xx=this.yy=d}else{if(d instanceof Array){if(d.length>0){var a=j.normalize(d[0]);for(var g=1;g<d.length;++g){var b=a,e=j.normalize(d[g]);a=new j.Matrix2D();a.xx=b.xx*e.xx+b.xy*e.yx;a.xy=b.xx*e.xy+b.xy*e.yy;a.yx=b.yx*e.xx+b.yy*e.yx;a.yy=b.yx*e.xy+b.yy*e.yy;a.dx=b.xx*e.dx+b.xy*e.dy+b.dx;a.dy=b.yx*e.dx+b.yy*e.dy+b.dy}Object.extend(this,a)}}else{Object.extend(this,d)}}}};j.normalize=function(a){return(a instanceof j.Matrix2D)?a:new j.Matrix2D(a)};j.multiply=function(b){var e=j.normalize(b);for(var a=1;a<arguments.length;++a){var d=e,g=j.normalize(arguments[a]);e=new j.Matrix2D();e.xx=d.xx*g.xx+d.xy*g.yx;e.xy=d.xx*g.xy+d.xy*g.yy;e.yx=d.yx*g.xx+d.yy*g.yx;e.yy=d.yx*g.xy+d.yy*g.yy;e.dx=d.xx*g.dx+d.xy*g.dy+d.dx;e.dy=d.yx*g.dx+d.yy*g.dy+d.dy}return e};j.invert=function(d){var a=j.normalize(d),b=a.xx*a.yy-a.xy*a.yx,a=new j.Matrix2D({xx:a.yy/b,xy:-a.xy/b,yx:-a.yx/b,yy:a.xx/b,dx:(a.xy*a.dy-a.yy*a.dx)/b,dy:(a.yx*a.dx-a.xx*a.dy)/b});return a};Object.extend(j.Matrix2D,{xx:1,xy:0,yx:0,yy:1,dx:0,dy:0});var k=function(a,b){return Math.abs(a-b)<=0.000001*(Math.abs(a)+Math.abs(b))};var l=function(a,b){if(!isFinite(a)){return b}else{if(!isFinite(b)){return a}}return(a+b)/2};var q=function(b){var a=new j.Matrix2D(b);return Object.extend(a,{dx:0,dy:0,xy:a.yx,yx:a.xy})};var n=function(a){return(a.xx*a.yy<0||a.xy*a.yx>0)?-1:1};var o=function(B){var d=j.normalize(B),D=-d.xx-d.yy,a=d.xx*d.yy-d.xy*d.yx,b=Math.sqrt(D*D-4*a),h=-(D+(D<0?-b:b))/2,w=a/h,C=d.xy/(h-d.xx),e=1,F=d.xy/(w-d.xx),g=1;if(k(h,w)){C=1,e=0,F=0,g=1}if(!isFinite(C)){C=1,e=(h-d.xx)/d.xy;if(!isFinite(e)){C=(h-d.yy)/d.yx,e=1;if(!isFinite(C)){C=1,e=d.yx/(h-d.yy)}}}if(!isFinite(F)){F=1,g=(w-d.xx)/d.xy;if(!isFinite(g)){F=(w-d.yy)/d.yx,g=1;if(!isFinite(F)){F=1,g=d.yx/(w-d.yy)}}}var z=Math.sqrt(C*C+e*e),A=Math.sqrt(F*F+g*g);if(isNaN(C/=z)){C=0}if(isNaN(e/=z)){e=0}if(isNaN(F/=A)){F=0}if(isNaN(g/=A)){g=0}return{value1:h,value2:w,vector1:{x:C,y:e},vector2:{x:F,y:g}}};var m=function(g,e){var b=n(g),d=e.angle1=(Math.atan2(g.yx,g.yy)+Math.atan2(-b*g.xy,b*g.xx))/2,h=Math.cos(d),a=Math.sin(d);e.sx=l(g.xx/h,-g.xy/a);e.sy=l(g.yy/h,g.yx/a);return e};var p=function(g,e){var b=n(g),d=e.angle2=(Math.atan2(b*g.yx,b*g.xx)+Math.atan2(-g.xy,g.yy))/2,h=Math.cos(d),a=Math.sin(d);e.sx=l(g.xx/h,g.yx/a);e.sy=l(g.yy/h,-g.xy/a);return e};return function(w){var d={xx:w[0][0],xy:w[0][1],yx:w[1][0],yy:w[1][1],dx:w[0][2],dy:w[1][2]};var e=j.normalize(d),z={dx:e.dx,dy:e.dy,sx:1,sy:1,angle1:0,angle2:0};if(k(e.xy,0)&&k(e.yx,0)){return Object.extend(z,{sx:e.xx,sy:e.yy})}if(k(e.xx*e.yx,-e.xy*e.yy)){return m(e,z)}if(k(e.xx*e.xy,-e.yx*e.yy)){return p(e,z)}var g=q(e),a=o([e,g]),b=o([g,e]),u=new j.Matrix2D({xx:a.vector1.x,xy:a.vector2.x,yx:a.vector1.y,yy:a.vector2.y}),h=new j.Matrix2D({xx:b.vector1.x,xy:b.vector1.y,yx:b.vector2.x,yy:b.vector2.y}),t=new j.Matrix2D([j.invert(u),e,j.invert(h)]);m(h,z);t.xx*=z.sx;t.yy*=z.sy;p(u,z);t.xx*=z.sx;t.yy*=z.sy;return Object.extend(z,{sx:t.xx,sy:t.yy})}})();function ribbon(a){this.init(a)}ribbon.prototype={context:null,mouseX:null,mouseY:null,painters:null,interval:null,init:function(b){var d=this;this.context=b;this.context.globalCompositeOperation="source-over";this.mouseX=SCREEN_WIDTH/2;this.mouseY=SCREEN_HEIGHT/2;this.painters=new Array();for(var a=0;a<50;a++){this.painters.push({dx:SCREEN_WIDTH/2,dy:SCREEN_HEIGHT/2,ax:0,ay:0,div:0.1,ease:Math.random()*0.2+0.6})}this.interval=setInterval(e,1000/60);function e(){var g;this.context.lineWidth=BRUSH_SIZE;this.context.strokeStyle="rgba("+COLOR[0]+", "+COLOR[1]+", "+COLOR[2]+", "+0.05*BRUSH_PRESSURE+")";for(g=0;g<d.painters.length;g++){d.context.beginPath();d.context.moveTo(d.painters[g].dx,d.painters[g].dy);d.painters[g].dx-=d.painters[g].ax=(d.painters[g].ax+(d.painters[g].dx-d.mouseX)*d.painters[g].div)*d.painters[g].ease;d.painters[g].dy-=d.painters[g].ay=(d.painters[g].ay+(d.painters[g].dy-d.mouseY)*d.painters[g].div)*d.painters[g].ease;d.context.lineTo(d.painters[g].dx,d.painters[g].dy);d.context.stroke()}}},destroy:function(){clearInterval(this.interval)},strokeStart:function(d,a){this.mouseX=d;this.mouseY=a;for(var b=0;b<this.painters.length;b++){this.painters[b].dx=d;this.painters[b].dy=a}this.shouldDraw=true},stroke:function(b,a){this.mouseX=b;this.mouseY=a},strokeEnd:function(){}};var REV=6,BRUSHES=["ribbon"],USER_AGENT=navigator.userAgent.toLowerCase();var SCREEN_WIDTH=cacophony.width,SCREEN_HEIGHT=cacophony.height,BRUSH_SIZE=1,BRUSH_PRESSURE=1,COLOR=[0,0,0],BACKGROUND_COLOR=[250,250,250],STORAGE=false,brush,saveTimeOut,wacom,i,mouseX=0,mouseY=0,container,foregroundColorSelector,backgroundColorSelector,menu,about,canvas,flattenCanvas,context,isFgColorSelectorVisible=false,isBgColorSelectorVisible=false,isAboutVisible=false,isMenuMouseOver=false,shiftKeyIsDown=false,altKeyIsDown=false;function harmony_init(){var hash,palette,embed,localStorageImage;if(USER_AGENT.search("android")>-1||USER_AGENT.search("iphone")>-1){BRUSH_SIZE=2}if(USER_AGENT.search("safari")>-1&&USER_AGENT.search("chrome")==-1){STORAGE=false}container=$("#cacophony-canvas3").get(0);canvas=document.createElement("canvas");canvas.width=SCREEN_WIDTH;canvas.height=SCREEN_HEIGHT;canvas.style.cursor="crosshair";container.appendChild(canvas);context=canvas.getContext("2d");flattenCanvas=document.createElement("canvas");flattenCanvas.width=SCREEN_WIDTH;flattenCanvas.height=SCREEN_HEIGHT;if(STORAGE){if(localStorage.canvas){localStorageImage=new Image();localStorageImage.addEventListener("load",function(event){localStorageImage.removeEventListener(event.type,arguments.callee,false);context.drawImage(localStorageImage,0,0)},false);localStorageImage.src=localStorage.canvas}if(localStorage.brush_color_red){COLOR[0]=localStorage.brush_color_red;COLOR[1]=localStorage.brush_color_green;COLOR[2]=localStorage.brush_color_blue}if(localStorage.background_color_red){BACKGROUND_COLOR[0]=localStorage.background_color_red;BACKGROUND_COLOR[1]=localStorage.background_color_green;BACKGROUND_COLOR[2]=localStorage.background_color_blue}}if(!brush){brush=eval("new "+BRUSHES[0]+"(context)")}window.addEventListener("mousemove",onWindowMouseMove,false);document.addEventListener("mousedown",onDocumentMouseDown,false);document.addEventListener("mouseout",onDocumentMouseOut,false);document.addEventListener("dragenter",onDocumentDragEnter,false);document.addEventListener("dragover",onDocumentDragOver,false);document.addEventListener("drop",onDocumentDrop,false);canvas.addEventListener("mousedown",onCanvasMouseDown,false);canvas.addEventListener("touchstart",onCanvasTouchStart,false)}function onWindowMouseMove(a){mouseX=a.clientX-$("#cacophony-canvas3").get(0).offsetLeft;mouseY=a.clientY-$("#cacophony-canvas3").get(0).offsetTop}function onWindowResize(){SCREEN_WIDTH=window.innerWidth;SCREEN_HEIGHT=window.innerHeight;menu.container.style.left=((SCREEN_WIDTH-menu.container.offsetWidth)/2)+"px";about.container.style.left=((SCREEN_WIDTH-about.container.offsetWidth)/2)+"px";about.container.style.top=((SCREEN_HEIGHT-about.container.offsetHeight)/2)+"px"}function onWindowKeyDown(a){if(shiftKeyIsDown){return}switch(a.keyCode){case 16:shiftKeyIsDown=true;foregroundColorSelector.container.style.left=mouseX-125+"px";foregroundColorSelector.container.style.top=mouseY-125+"px";foregroundColorSelector.container.style.visibility="visible";break;case 18:altKeyIsDown=true;break;case 68:if(BRUSH_SIZE>1){BRUSH_SIZE--}break;case 70:BRUSH_SIZE++;break}}function onWindowKeyUp(event){switch(event.keyCode){case 16:shiftKeyIsDown=false;foregroundColorSelector.container.style.visibility="hidden";break;case 18:altKeyIsDown=false;break;case 82:brush.destroy();brush=eval("new "+BRUSHES[menu.selector.selectedIndex]+"(context)");break;case 66:document.body.style.backgroundImage=null;break}context.lineCap=BRUSH_SIZE==1?"butt":"round"}function onWindowBlur(a){shiftKeyIsDown=false;altKeyIsDown=false}function onDocumentMouseDown(a){if(!isMenuMouseOver){a.preventDefault()}}function onDocumentMouseOut(a){onCanvasMouseUp()}function onDocumentDragEnter(a){a.stopPropagation();a.preventDefault()}function onDocumentDragOver(a){a.stopPropagation();a.preventDefault()}function onDocumentDrop(d){d.stopPropagation();d.preventDefault();var b=d.dataTransfer.files[0];if(b.type.match(/image.*/)){var a=d.dataTransfer.getData("text").split("\n");document.body.style.backgroundImage="url("+a[0]+")"}}function onForegroundColorSelectorChange(a){COLOR=foregroundColorSelector.getColor();menu.setForegroundColor(COLOR);if(STORAGE){localStorage.brush_color_red=COLOR[0];localStorage.brush_color_green=COLOR[1];localStorage.brush_color_blue=COLOR[2]}}function onBackgroundColorSelectorChange(a){BACKGROUND_COLOR=backgroundColorSelector.getColor();menu.setBackgroundColor(BACKGROUND_COLOR);document.body.style.backgroundColor="rgb("+BACKGROUND_COLOR[0]+", "+BACKGROUND_COLOR[1]+", "+BACKGROUND_COLOR[2]+")";if(STORAGE){localStorage.background_color_red=BACKGROUND_COLOR[0];localStorage.background_color_green=BACKGROUND_COLOR[1];localStorage.background_color_blue=BACKGROUND_COLOR[2]}}function onMenuForegroundColor(){cleanPopUps();foregroundColorSelector.show();foregroundColorSelector.container.style.left=((SCREEN_WIDTH-foregroundColorSelector.container.offsetWidth)/2)+"px";foregroundColorSelector.container.style.top=((SCREEN_HEIGHT-foregroundColorSelector.container.offsetHeight)/2)+"px";isFgColorSelectorVisible=true}function onMenuBackgroundColor(){cleanPopUps();backgroundColorSelector.show();backgroundColorSelector.container.style.left=((SCREEN_WIDTH-backgroundColorSelector.container.offsetWidth)/2)+"px";backgroundColorSelector.container.style.top=((SCREEN_HEIGHT-backgroundColorSelector.container.offsetHeight)/2)+"px";isBgColorSelectorVisible=true}function onMenuSelectorChange(){if(BRUSHES[menu.selector.selectedIndex]==""){return}brush.destroy();brush=eval("new "+BRUSHES[menu.selector.selectedIndex]+"(context)");window.location.hash=BRUSHES[menu.selector.selectedIndex]}function onMenuMouseOver(){isMenuMouseOver=true}function onMenuMouseOut(){isMenuMouseOver=false}function onMenuSave(){flatten();window.open(flattenCanvas.toDataURL("image/png"),"mywindow")}function onMenuClear(){if(!confirm("Are you sure?")){return}context.clearRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);saveToLocalStorage();brush.destroy();brush=eval("new "+BRUSHES[menu.selector.selectedIndex]+"(context)")}function onMenuAbout(){cleanPopUps();isAboutVisible=true;about.show()}function onCanvasMouseDown(b){var d,a;clearTimeout(saveTimeOut);cleanPopUps();if(altKeyIsDown){flatten();d=flattenCanvas.getContext("2d").getImageData(0,0,flattenCanvas.width,flattenCanvas.height).data;a=(b.clientX+(b.clientY*canvas.width))*4;foregroundColorSelector.setColor([d[a],d[a+1],d[a+2]]);return}BRUSH_PRESSURE=wacom&&wacom.isWacom?wacom.pressure:1;brush.strokeStart(b.clientX-$("#cacophony-canvas3").get(0).offsetLeft,b.clientY-$("#cacophony-canvas3").get(0).offsetTop);window.addEventListener("mousemove",onCanvasMouseMove,false);window.addEventListener("mouseup",onCanvasMouseUp,false)}function onCanvasMouseMove(a){BRUSH_PRESSURE=wacom&&wacom.isWacom?wacom.pressure:1;brush.stroke(a.clientX-$("#cacophony-canvas3").get(0).offsetLeft,a.clientY-$("#cacophony-canvas3").get(0).offsetTop)}function onCanvasMouseUp(){brush.strokeEnd();window.removeEventListener("mousemove",onCanvasMouseMove,false);window.removeEventListener("mouseup",onCanvasMouseUp,false);if(STORAGE){clearTimeout(saveTimeOut);saveTimeOut=setTimeout(saveToLocalStorage,2000,true)}}function onCanvasTouchStart(a){cleanPopUps();if(a.touches.length==1){a.preventDefault();brush.strokeStart(a.touches[0].pageX,a.touches[0].pageY);window.addEventListener("touchmove",onCanvasTouchMove,false);window.addEventListener("touchend",onCanvasTouchEnd,false)}}function onCanvasTouchMove(a){if(a.touches.length==1){a.preventDefault();brush.stroke(a.touches[0].pageX,a.touches[0].pageY)}}function onCanvasTouchEnd(a){if(a.touches.length==0){a.preventDefault();brush.strokeEnd();window.removeEventListener("touchmove",onCanvasTouchMove,false);window.removeEventListener("touchend",onCanvasTouchEnd,false)}}function saveToLocalStorage(){localStorage.canvas=canvas.toDataURL("image/png")}function flatten(){var a=flattenCanvas.getContext("2d");a.fillStyle="rgb("+BACKGROUND_COLOR[0]+", "+BACKGROUND_COLOR[1]+", "+BACKGROUND_COLOR[2]+")";a.fillRect(0,0,canvas.width,canvas.height);a.drawImage(canvas,0,0)}function cleanPopUps(){if(isFgColorSelectorVisible){foregroundColorSelector.hide();isFgColorSelectorVisible=false}if(isBgColorSelectorVisible){backgroundColorSelector.hide();isBgColorSelectorVisible=false}if(isAboutVisible){about.hide();isAboutVisible=false}}var THREE=THREE||{};THREE.Color=function(b){this.autoUpdate=true;this.setHex(b)};THREE.Color.prototype={setRGBA:function(a,b,h,g){this.r=a;this.g=b;this.b=h;this.a=g;if(this.autoUpdate){this.updateHex();this.updateStyleString()}},setHex:function(b){this.hex=b;if(this.autoUpdate){this.updateRGBA();this.updateStyleString()}},copyRGB:function(b){this.r=b.r;this.g=b.g;this.b=b.b},copyRGBA:function(b){this.r=b.r;this.g=b.g;this.b=b.b;this.a=b.a},multiplySelfRGB:function(b){this.r*=b.r;this.g*=b.g;this.b*=b.b},updateHex:function(){this.hex=Math.floor(this.a*255)<<24|Math.floor(this.r*255)<<16|Math.floor(this.g*255)<<8|Math.floor(this.b*255)},updateRGBA:function(){this.a=(this.hex>>24&255)/255;this.r=(this.hex>>16&255)/255;this.g=(this.hex>>8&255)/255;this.b=(this.hex&255)/255},updateStyleString:function(){this.__styleString="rgba("+Math.floor(this.r*255)+","+Math.floor(this.g*255)+","+Math.floor(this.b*255)+","+this.a+")"},toString:function(){return"THREE.Color ( r: "+this.r+", g: "+this.g+", b: "+this.b+", a: "+this.a+", hex: "+this.hex+" )"}};THREE.Vector2=function(e,d){this.x=e||0;this.y=d||0};THREE.Vector2.prototype={set:function(e,d){this.x=e;this.y=d;return this},copy:function(b){this.x=b.x;this.y=b.y;return this},addSelf:function(b){this.x+=b.x;this.y+=b.y;return this},add:function(d,e){this.x=d.x+e.x;this.y=d.y+e.y;return this},subSelf:function(b){this.x-=b.x;this.y-=b.y;return this},sub:function(d,e){this.x=d.x-e.x;this.y=d.y-e.y;return this},multiplyScalar:function(b){this.x*=b;this.y*=b;return this},unit:function(){this.multiplyScalar(1/this.length());return this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},negate:function(){this.x=-this.x;this.y=-this.y;return this},clone:function(){return new THREE.Vector2(this.x,this.y)},toString:function(){return"THREE.Vector2 ("+this.x+", "+this.y+")"}};THREE.Vector3=function(e,g,d){this.x=e||0;this.y=g||0;this.z=d||0};THREE.Vector3.prototype={set:function(e,g,d){this.x=e;this.y=g;this.z=d;return this},copy:function(b){this.x=b.x;this.y=b.y;this.z=b.z;return this},add:function(d,e){this.x=d.x+e.x;this.y=d.y+e.y;this.z=d.z+e.z;return this},addSelf:function(b){this.x+=b.x;this.y+=b.y;this.z+=b.z;return this},addScalar:function(b){this.x+=b;this.y+=b;this.z+=b;return this},sub:function(d,e){this.x=d.x-e.x;this.y=d.y-e.y;this.z=d.z-e.z;return this},subSelf:function(b){this.x-=b.x;this.y-=b.y;this.z-=b.z;return this},cross:function(d,e){this.x=d.y*e.z-d.z*e.y;this.y=d.z*e.x-d.x*e.z;this.z=d.x*e.y-d.y*e.x;return this},crossSelf:function(j){var e=this.x,g=this.y,h=this.z;this.x=g*j.z-h*j.y;this.y=h*j.x-e*j.z;this.z=e*j.y-g*j.x;return this},multiplySelf:function(b){this.x*=b.x;this.y*=b.y;this.z*=b.z;return this},multiplyScalar:function(b){this.x*=b;this.y*=b;this.z*=b;return this},divideScalar:function(b){this.x/=b;this.y/=b;this.z/=b;return this},dot:function(b){return this.x*b.x+this.y*b.y+this.z*b.z},distanceTo:function(b){return Math.sqrt(this.distanceToSquared(b))},distanceToSquared:function(h){var j=this.x-h.x,e=this.y-h.y,g=this.z-h.z;return j*j+e*e+g*g},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},negate:function(){this.x=-this.x;this.y=-this.y;this.z=-this.z;return this},normalize:function(){if(this.length()>0){this.multiplyScalar(1/this.length())}else{this.multiplyScalar(0)}return this},setLength:function(b){return this.normalize().multiplyScalar(b)},isZero:function(){var b=0.0001;return(Math.abs(this.x)<b)&&(Math.abs(this.y)<b)&&(Math.abs(this.z)<b)},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)},toString:function(){return"THREE.Vector3 ( "+this.x+", "+this.y+", "+this.z+" )"}};THREE.Vector4=function(g,h,j,e){this.x=g||0;this.y=h||0;this.z=j||0;this.w=e||1};THREE.Vector4.prototype={set:function(g,h,j,e){this.x=g;this.y=h;this.z=j;this.w=e;return this},copy:function(b){this.x=b.x;this.y=b.y;this.z=b.z;this.w=b.w;return this},add:function(d,e){this.x=d.x+e.x;this.y=d.y+e.y;this.z=d.z+e.z;this.w=d.w+e.w;return this},addSelf:function(b){this.x+=b.x;this.y+=b.y;this.z+=b.z;this.w+=b.w;return this},sub:function(d,e){this.x=d.x-e.x;this.y=d.y-e.y;this.z=d.z-e.z;this.w=d.w-e.w;return this},subSelf:function(b){this.x-=b.x;this.y-=b.y;this.z-=b.z;this.w-=b.w;return this},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)},toString:function(){return"THREE.Vector4 ("+this.x+", "+this.y+", "+this.z+", "+this.w+")"}};THREE.Rectangle=function(){var n,l,p,m,k,q,o=true;function j(){k=p-n;q=m-l}this.getX=function(){return n};this.getY=function(){return l};this.getWidth=function(){return k};this.getHeight=function(){return q};this.getX1=function(){return n};this.getY1=function(){return l};this.getX2=function(){return p};this.getY2=function(){return m};this.set=function(d,a,e,b){o=false;n=d;l=a;p=e;m=b;j()};this.addPoint=function(b,a){if(o){o=false;n=b;l=a;p=b;m=a}else{n=Math.min(n,b);l=Math.min(l,a);p=Math.max(p,b);m=Math.max(m,a)}j()};this.addRectangle=function(a){if(o){o=false;n=a.getX1();l=a.getY1();p=a.getX2();m=a.getY2()}else{n=Math.min(n,a.getX1());l=Math.min(l,a.getY1());p=Math.max(p,a.getX2());m=Math.max(m,a.getY2())}j()};this.inflate=function(a){n-=a;l-=a;p+=a;m+=a;j()};this.minSelf=function(a){n=Math.max(n,a.getX1());l=Math.max(l,a.getY1());p=Math.min(p,a.getX2());m=Math.min(m,a.getY2());j()};this.instersects=function(a){return Math.min(p,a.getX2())-Math.max(n,a.getX1())>=0&&Math.min(m,a.getY2())-Math.max(l,a.getY1())>=0};this.empty=function(){o=true;n=0;l=0;p=0;m=0;j()};this.isEmpty=function(){return o};this.toString=function(){return"THREE.Rectangle (x1: "+n+", y1: "+m+", x2: "+p+", y1: "+l+", width: "+k+", height: "+q+")"}};THREE.Matrix4=function(){this._x=new THREE.Vector3();this._y=new THREE.Vector3();this._z=new THREE.Vector3()};THREE.Matrix4.prototype={n11:1,n12:0,n13:0,n14:0,n21:0,n22:1,n23:0,n24:0,n31:0,n32:0,n33:1,n34:0,n41:0,n42:0,n43:0,n44:1,identity:function(){this.n11=1;this.n12=0;this.n13=0;this.n14=0;this.n21=0;this.n22=1;this.n23=0;this.n24=0;this.n31=0;this.n32=0;this.n33=1;this.n34=0;this.n41=0;this.n42=0;this.n43=0;this.n44=1},copy:function(b){this.n11=b.n11;this.n12=b.n12;this.n13=b.n13;this.n14=b.n14;this.n21=b.n21;this.n22=b.n22;this.n23=b.n23;this.n24=b.n24;this.n31=b.n31;this.n32=b.n32;this.n33=b.n33;this.n34=b.n34;this.n41=b.n41;this.n42=b.n42;this.n43=b.n43;this.n44=b.n44},lookAt:function(l,m,g){var h=this._x,j=this._y,k=this._z;k.sub(l,m);k.normalize();h.cross(g,k);h.normalize();j.cross(k,h);j.normalize();this.n11=h.x;this.n12=h.y;this.n13=h.z;this.n14=-h.dot(l);this.n21=j.x;this.n22=j.y;this.n23=j.z;this.n24=-j.dot(l);this.n31=k.x;this.n32=k.y;this.n33=k.z;this.n34=-k.dot(l);this.n41=0;this.n42=0;this.n43=0;this.n44=1},transform:function(h){var k=h.x,l=h.y,g=h.z,j=h.w?h.w:1;h.x=this.n11*k+this.n12*l+this.n13*g+this.n14*j;h.y=this.n21*k+this.n22*l+this.n23*g+this.n24*j;h.z=this.n31*k+this.n32*l+this.n33*g+this.n34*j;j=this.n41*k+this.n42*l+this.n43*g+this.n44*j;if(h.w){h.w=j}else{h.x=h.x/j;h.y=h.y/j;h.z=h.z/j}return h},crossVector:function(a){var d=new THREE.Vector4();d.x=this.n11*a.x+this.n12*a.y+this.n13*a.z+this.n14*a.w;d.y=this.n21*a.x+this.n22*a.y+this.n23*a.z+this.n24*a.w;d.z=this.n31*a.x+this.n32*a.y+this.n33*a.z+this.n34*a.w;d.w=(a.w)?this.n41*a.x+this.n42*a.y+this.n43*a.z+this.n44*a.w:1;return d},multiply:function(a,b){this.n11=a.n11*b.n11+a.n12*b.n21+a.n13*b.n31+a.n14*b.n41;this.n12=a.n11*b.n12+a.n12*b.n22+a.n13*b.n32+a.n14*b.n42;this.n13=a.n11*b.n13+a.n12*b.n23+a.n13*b.n33+a.n14*b.n43;this.n14=a.n11*b.n14+a.n12*b.n24+a.n13*b.n34+a.n14*b.n44;this.n21=a.n21*b.n11+a.n22*b.n21+a.n23*b.n31+a.n24*b.n41;this.n22=a.n21*b.n12+a.n22*b.n22+a.n23*b.n32+a.n24*b.n42;this.n23=a.n21*b.n13+a.n22*b.n23+a.n23*b.n33+a.n24*b.n43;this.n24=a.n21*b.n14+a.n22*b.n24+a.n23*b.n34+a.n24*b.n44;this.n31=a.n31*b.n11+a.n32*b.n21+a.n33*b.n31+a.n34*b.n41;this.n32=a.n31*b.n12+a.n32*b.n22+a.n33*b.n32+a.n34*b.n42;this.n33=a.n31*b.n13+a.n32*b.n23+a.n33*b.n33+a.n34*b.n43;this.n34=a.n31*b.n14+a.n32*b.n24+a.n33*b.n34+a.n34*b.n44;this.n41=a.n41*b.n11+a.n42*b.n21+a.n43*b.n31+a.n44*b.n41;this.n42=a.n41*b.n12+a.n42*b.n22+a.n43*b.n32+a.n44*b.n42;this.n43=a.n41*b.n13+a.n42*b.n23+a.n43*b.n33+a.n44*b.n43;this.n44=a.n41*b.n14+a.n42*b.n24+a.n43*b.n34+a.n44*b.n44},multiplySelf:function(J){var u=this.n11,w=this.n12,A=this.n13,C=this.n14,G=this.n21,H=this.n22,I=this.n23,K=this.n24,L=this.n31,m=this.n32,s=this.n33,t=this.n34,z=this.n41,B=this.n42,D=this.n43,F=this.n44;this.n11=u*J.n11+w*J.n21+A*J.n31+C*J.n41;this.n12=u*J.n12+w*J.n22+A*J.n32+C*J.n42;this.n13=u*J.n13+w*J.n23+A*J.n33+C*J.n43;this.n14=u*J.n14+w*J.n24+A*J.n34+C*J.n44;this.n21=G*J.n11+H*J.n21+I*J.n31+K*J.n41;this.n22=G*J.n12+H*J.n22+I*J.n32+K*J.n42;this.n23=G*J.n13+H*J.n23+I*J.n33+K*J.n43;this.n24=G*J.n14+H*J.n24+I*J.n34+K*J.n44;this.n31=L*J.n11+m*J.n21+s*J.n31+t*J.n41;this.n32=L*J.n12+m*J.n22+s*J.n32+t*J.n42;this.n33=L*J.n13+m*J.n23+s*J.n33+t*J.n43;this.n34=L*J.n14+m*J.n24+s*J.n34+t*J.n44;this.n41=z*J.n11+B*J.n21+D*J.n31+F*J.n41;this.n42=z*J.n12+B*J.n22+D*J.n32+F*J.n42;this.n43=z*J.n13+B*J.n23+D*J.n33+F*J.n43;this.n44=z*J.n14+B*J.n24+D*J.n34+F*J.n44},multiplyScalar:function(b){this.n11*=b;this.n12*=b;this.n13*=b;this.n14*=b;this.n21*=b;this.n22*=b;this.n23*=b;this.n24*=b;this.n31*=b;this.n32*=b;this.n33*=b;this.n34*=b;this.n41*=b;this.n42*=b;this.n43*=b;this.n44*=b},determinant:function(){return(this.n14*this.n23*this.n32*this.n41-this.n13*this.n24*this.n32*this.n41-this.n14*this.n22*this.n33*this.n41+this.n12*this.n24*this.n33*this.n41+this.n13*this.n22*this.n34*this.n41-this.n12*this.n23*this.n34*this.n41-this.n14*this.n23*this.n31*this.n42+this.n13*this.n24*this.n31*this.n42+this.n14*this.n21*this.n33*this.n42-this.n11*this.n24*this.n33*this.n42-this.n13*this.n21*this.n34*this.n42+this.n11*this.n23*this.n34*this.n42+this.n14*this.n22*this.n31*this.n43-this.n12*this.n24*this.n31*this.n43-this.n14*this.n21*this.n32*this.n43+this.n11*this.n24*this.n32*this.n43+this.n12*this.n21*this.n34*this.n43-this.n11*this.n22*this.n34*this.n43-this.n13*this.n22*this.n31*this.n44+this.n12*this.n23*this.n31*this.n44+this.n13*this.n21*this.n32*this.n44-this.n11*this.n23*this.n32*this.n44-this.n12*this.n21*this.n33*this.n44+this.n11*this.n22*this.n33*this.n44)},transpose:function(){function b(h,g,j){var a=h[g];h[g]=h[j];h[j]=a}b(this,"n21","n12");b(this,"n31","n13");b(this,"n32","n23");b(this,"n41","n14");b(this,"n42","n24");b(this,"n43","n34");return this},clone:function(){var b=new THREE.Matrix4();b.n11=this.n11;b.n12=this.n12;b.n13=this.n13;b.n14=this.n14;b.n21=this.n21;b.n22=this.n22;b.n23=this.n23;b.n24=this.n24;b.n31=this.n31;b.n32=this.n32;b.n33=this.n33;b.n34=this.n34;b.n41=this.n41;b.n42=this.n42;b.n43=this.n43;b.n44=this.n44;return b},flatten:function(){return[this.n11,this.n21,this.n31,this.n41,this.n12,this.n22,this.n32,this.n42,this.n13,this.n23,this.n33,this.n43,this.n14,this.n24,this.n34,this.n44]},toString:function(){return"| "+this.n11+" "+this.n12+" "+this.n13+" "+this.n14+" |\n| "+this.n21+" "+this.n22+" "+this.n23+" "+this.n24+" |\n| "+this.n31+" "+this.n32+" "+this.n33+" "+this.n34+" |\n| "+this.n41+" "+this.n42+" "+this.n43+" "+this.n44+" |"}};THREE.Matrix4.translationMatrix=function(e,h,j){var g=new THREE.Matrix4();g.n14=e;g.n24=h;g.n34=j;return g};THREE.Matrix4.scaleMatrix=function(e,h,j){var g=new THREE.Matrix4();g.n11=e;g.n22=h;g.n33=j;return g};THREE.Matrix4.rotationXMatrix=function(d){var e=new THREE.Matrix4();e.n22=e.n33=Math.cos(d);e.n32=Math.sin(d);e.n23=-e.n32;return e};THREE.Matrix4.rotationYMatrix=function(d){var e=new THREE.Matrix4();e.n11=e.n33=Math.cos(d);e.n13=Math.sin(d);e.n31=-e.n13;return e};THREE.Matrix4.rotationZMatrix=function(d){var e=new THREE.Matrix4();e.n11=e.n22=Math.cos(d);e.n21=Math.sin(d);e.n12=-e.n21;return e};THREE.Matrix4.rotationAxisAngleMatrix=function(s,q){var t=new THREE.Matrix4(),o=Math.cos(q),k=Math.sin(q),l=1-o,m=s.x,n=s.y,p=s.z;t.n11=l*m*m+o;t.n12=l*m*n-k*p;t.n13=l*m*p+k*n;t.n21=l*m*n+k*p;t.n22=l*n*n+o;t.n23=l*n*p-k*m;t.n31=l*m*p-k*n;t.n32=l*n*p+k*m;t.n33=l*p*p+o;return t};THREE.Matrix4.makeInvert=function(d){var e=new THREE.Matrix4();e.n11=d.n23*d.n34*d.n42-d.n24*d.n33*d.n42+d.n24*d.n32*d.n43-d.n22*d.n34*d.n43-d.n23*d.n32*d.n44+d.n22*d.n33*d.n44;e.n12=d.n14*d.n33*d.n42-d.n13*d.n34*d.n42-d.n14*d.n32*d.n43+d.n12*d.n34*d.n43+d.n13*d.n32*d.n44-d.n12*d.n33*d.n44;e.n13=d.n13*d.n24*d.n42-d.n14*d.n23*d.n42+d.n14*d.n22*d.n43-d.n12*d.n24*d.n43-d.n13*d.n22*d.n44+d.n12*d.n23*d.n44;e.n14=d.n14*d.n23*d.n32-d.n13*d.n24*d.n32-d.n14*d.n22*d.n33+d.n12*d.n24*d.n33+d.n13*d.n22*d.n34-d.n12*d.n23*d.n34;e.n21=d.n24*d.n33*d.n41-d.n23*d.n34*d.n41-d.n24*d.n31*d.n43+d.n21*d.n34*d.n43+d.n23*d.n31*d.n44-d.n21*d.n33*d.n44;e.n22=d.n13*d.n34*d.n41-d.n14*d.n33*d.n41+d.n14*d.n31*d.n43-d.n11*d.n34*d.n43-d.n13*d.n31*d.n44+d.n11*d.n33*d.n44;e.n23=d.n14*d.n23*d.n41-d.n13*d.n24*d.n41-d.n14*d.n21*d.n43+d.n11*d.n24*d.n43+d.n13*d.n21*d.n44-d.n11*d.n23*d.n44;e.n24=d.n13*d.n24*d.n31-d.n14*d.n23*d.n31+d.n14*d.n21*d.n33-d.n11*d.n24*d.n33-d.n13*d.n21*d.n34+d.n11*d.n23*d.n34;e.n31=d.n22*d.n34*d.n41-d.n24*d.n32*d.n41+d.n24*d.n31*d.n42-d.n21*d.n34*d.n42-d.n22*d.n31*d.n44+d.n21*d.n32*d.n44;e.n32=d.n14*d.n32*d.n41-d.n12*d.n34*d.n41-d.n14*d.n31*d.n42+d.n11*d.n34*d.n42+d.n12*d.n31*d.n44-d.n11*d.n32*d.n44;e.n33=d.n13*d.n24*d.n41-d.n14*d.n22*d.n41+d.n14*d.n21*d.n42-d.n11*d.n24*d.n42-d.n12*d.n21*d.n44+d.n11*d.n22*d.n44;e.n34=d.n14*d.n22*d.n31-d.n12*d.n24*d.n31-d.n14*d.n21*d.n32+d.n11*d.n24*d.n32+d.n12*d.n21*d.n34-d.n11*d.n22*d.n34;e.n41=d.n23*d.n32*d.n41-d.n22*d.n33*d.n41-d.n23*d.n31*d.n42+d.n21*d.n33*d.n42+d.n22*d.n31*d.n43-d.n21*d.n32*d.n43;e.n42=d.n12*d.n33*d.n41-d.n13*d.n32*d.n41+d.n13*d.n31*d.n42-d.n11*d.n33*d.n42-d.n12*d.n31*d.n43+d.n11*d.n32*d.n43;e.n43=d.n13*d.n22*d.n41-d.n12*d.n23*d.n41-d.n13*d.n21*d.n42+d.n11*d.n23*d.n42+d.n12*d.n21*d.n43-d.n11*d.n22*d.n43;e.n44=d.n12*d.n23*d.n31-d.n13*d.n22*d.n31+d.n13*d.n21*d.n32-d.n11*d.n23*d.n32-d.n12*d.n21*d.n33+d.n11*d.n22*d.n33;e.multiplyScalar(1/d.determinant());return e};THREE.Matrix4.makeFrustum=function(C,a,D,m,z,A){var B,b,s,d,t,u,w;B=new THREE.Matrix4();b=2*z/(a-C);s=2*z/(m-D);d=(a+C)/(a-C);t=(m+D)/(m-D);u=-(A+z)/(A-z);w=-2*A*z/(A-z);B.n11=b;B.n12=0;B.n13=d;B.n14=0;B.n21=0;B.n22=s;B.n23=t;B.n24=0;B.n31=0;B.n32=0;B.n33=u;B.n34=w;B.n41=0;B.n42=0;B.n43=-1;B.n44=0;return B};THREE.Matrix4.makePerspective=function(o,q,m,j){var k,n,l,p;k=m*Math.tan(o*Math.PI/360);n=-k;l=n*q;p=k*q;return THREE.Matrix4.makeFrustum(l,p,n,k,m,j)};THREE.Matrix4.makeOrtho=function(B,h,q,D,u,w){var A,p,s,t,m,z,C;A=new THREE.Matrix4();m=h-B;z=D-q;C=w-u;p=(h+B)/m;s=(D+q)/z;t=(w+u)/C;A.n11=2/m;A.n12=0;A.n13=0;A.n14=-p;A.n21=0;A.n22=2/z;A.n23=0;A.n24=-s;A.n31=0;A.n32=0;A.n33=-2/C;A.n34=-t;A.n41=0;A.n42=0;A.n43=0;A.n44=1;return A};THREE.Vertex=function(e,d){this.position=e||new THREE.Vector3();this.positionWorld=new THREE.Vector3();this.positionScreen=new THREE.Vector3();this.normal=d||new THREE.Vector3();this.normalWorld=new THREE.Vector3();this.normalScreen=new THREE.Vector3();this.__visible=true};THREE.Vertex.prototype={toString:function(){return"THREE.Vertex ( position: "+this.position+", normal: "+this.normal+" )"}};THREE.Face3=function(k,l,a,b,j){this.a=k;this.b=l;this.c=a;this.centroid=new THREE.Vector3();this.normal=b||new THREE.Vector3();this.color=j||new THREE.Color(4278190080)};THREE.Face3.prototype={getCenter:function(){return this.a.clone().addSelf(this.b).addSelf(this.c).divideScalar(3)},toString:function(){return"THREE.Face3 ( "+this.a+", "+this.b+", "+this.c+" )"}};THREE.Face4=function(l,m,a,b,d,k){this.a=l;this.b=m;this.c=a;this.d=b;this.centroid=new THREE.Vector3();this.normal=d||new THREE.Vector3();this.color=k||new THREE.Color(4278190080)};THREE.Face4.prototype={getCenter:function(){return this.a.clone().addSelf(this.b).addSelf(this.c).addSelf(this.d).divideScalar(4)},toString:function(){return"THREE.Face4 ( "+this.a+", "+this.b+", "+this.c+" "+this.d+" )"}};THREE.UV=function(d,e){this.u=d||0;this.v=e||0};THREE.UV.prototype={copy:function(b){this.u=b.u;this.v=b.v},toString:function(){return"THREE.UV ("+this.u+", "+this.v+")"}};THREE.Geometry=function(){this.vertices=[];this.faces=[];this.uvs=[]};THREE.Geometry.prototype={computeCentroids:function(){var g,d,e;for(g=0,d=this.faces.length;g<d;g++){e=this.faces[g];e.centroid.set(0,0,0);if(e instanceof THREE.Face3){e.centroid.addSelf(this.vertices[e.a].position);e.centroid.addSelf(this.vertices[e.b].position);e.centroid.addSelf(this.vertices[e.c].position);e.centroid.divideScalar(3)}else{if(e instanceof THREE.Face4){e.centroid.addSelf(this.vertices[e.a].position);e.centroid.addSelf(this.vertices[e.b].position);e.centroid.addSelf(this.vertices[e.c].position);e.centroid.addSelf(this.vertices[e.d].position);e.centroid.divideScalar(4)}}}},computeNormals:function(){var n,u,s,q,o,p,w,z,A,t=new THREE.Vector3(),m=new THREE.Vector3();for(n=0,u=this.vertices.length;n<u;n++){s=this.vertices[n];s.normal.set(0,0,0)}for(q=0,o=this.faces.length;q<o;q++){p=this.faces[q];w=this.vertices[p.a];z=this.vertices[p.b];A=this.vertices[p.c];t.sub(A.position,z.position);m.sub(w.position,z.position);t.crossSelf(m);if(!t.isZero()){t.normalize()}p.normal.copy(t)}},toString:function(){return"THREE.Geometry ( vertices: "+this.vertices+", faces: "+this.faces+" )"}};THREE.Camera=function(j,e,h,g){this.fov=j;this.aspect=e;this.position=new THREE.Vector3(0,0,0);this.target={position:new THREE.Vector3(0,0,0)};this.projectionMatrix=THREE.Matrix4.makePerspective(j,e,h,g);this.up=new THREE.Vector3(0,1,0);this.matrix=new THREE.Matrix4();this.autoUpdateMatrix=true;this.updateMatrix=function(){this.matrix.lookAt(this.position,this.target.position,this.up)};this.toString=function(){return"THREE.Camera ( "+this.position+", "+this.target.position+" )"}};THREE.Light=function(b){this.color=new THREE.Color(255<<24|b)};THREE.AmbientLight=function(b){THREE.Light.call(this,b)};THREE.AmbientLight.prototype=new THREE.Light();THREE.AmbientLight.prototype.constructor=THREE.AmbientLight;THREE.DirectionalLight=function(d,e){THREE.Light.call(this,d);this.position=new THREE.Vector3(0,1,0);this.intensity=e||1};THREE.DirectionalLight.prototype=new THREE.Light();THREE.DirectionalLight.prototype.constructor=THREE.DirectionalLight;THREE.PointLight=function(d,e){THREE.Light.call(this,d);this.position=new THREE.Vector3(0,0,0);this.intensity=e||1};THREE.DirectionalLight.prototype=new THREE.Light();THREE.DirectionalLight.prototype.constructor=THREE.PointLight;THREE.Object3D=function(b){this.position=new THREE.Vector3();this.rotation=new THREE.Vector3();this.scale=new THREE.Vector3(1,1,1);this.matrix=new THREE.Matrix4();this.matrixTranslation=new THREE.Matrix4();this.matrixRotation=new THREE.Matrix4();this.matrixScale=new THREE.Matrix4();this.screen=new THREE.Vector3();this.autoUpdateMatrix=true;this.updateMatrix=function(){this.matrixPosition=THREE.Matrix4.translationMatrix(this.position.x,this.position.y,this.position.z);this.matrixRotation=THREE.Matrix4.rotationXMatrix(this.rotation.x);this.matrixRotation.multiplySelf(THREE.Matrix4.rotationYMatrix(this.rotation.y));this.matrixRotation.multiplySelf(THREE.Matrix4.rotationZMatrix(this.rotation.z));this.matrixScale=THREE.Matrix4.scaleMatrix(this.scale.x,this.scale.y,this.scale.z);this.matrix.copy(this.matrixPosition);this.matrix.multiplySelf(this.matrixRotation);this.matrix.multiplySelf(this.matrixScale)}};THREE.Particle=function(b){THREE.Object3D.call(this);this.material=b instanceof Array?b:[b];this.autoUpdateMatrix=false};THREE.Particle.prototype=new THREE.Object3D();THREE.Particle.prototype.constructor=THREE.Particle;THREE.Line=function(d,e){THREE.Object3D.call(this);this.geometry=d;this.material=e instanceof Array?e:[e]};THREE.Line.prototype=new THREE.Object3D();THREE.Line.prototype.constructor=THREE.Line;THREE.Mesh=function(d,e){THREE.Object3D.call(this);this.geometry=d;this.material=e instanceof Array?e:[e];this.flipSided=false;this.doubleSided=false;this.overdraw=false};THREE.Mesh.prototype=new THREE.Object3D();THREE.Mesh.prototype.constructor=THREE.Mesh;THREE.LineColorMaterial=function(g,d,e){this.lineWidth=e||1;this.color=new THREE.Color((d>=0?(d*255)<<24:4278190080)|g)};THREE.LineColorMaterial.prototype={toString:function(){return"THREE.LineColorMaterial ( color: "+this.color+", lineWidth: "+this.lineWidth+" )"}};THREE.MeshBitmapUVMappingMaterial=function(b){this.bitmap=b;this.toString=function(){return"THREE.MeshBitmapUVMappingMaterial ( bitmap: "+this.bitmap+" )"}};THREE.MeshColorFillMaterial=function(d,e){this.color=new THREE.Color((e>=0?(e*255)<<24:4278190080)|d);this.toString=function(){return"THREE.MeshColorFillMaterial ( color: "+this.color+" )"}};THREE.MeshColorStrokeMaterial=function(g,d,e){this.lineWidth=e||1;this.color=new THREE.Color((d>=0?(d*255)<<24:4278190080)|g);this.toString=function(){return"THREE.MeshColorStrokeMaterial ( lineWidth: "+this.lineWidth+", color: "+this.color+" )"}};THREE.MeshFaceColorFillMaterial=function(){this.toString=function(){return"THREE.MeshFaceColorFillMaterial ( )"}};THREE.MeshFaceColorStrokeMaterial=function(b){this.lineWidth=b||1;this.toString=function(){return"THREE.MeshFaceColorStrokeMaterial ( lineWidth: "+this.lineWidth+" )"}};THREE.ParticleBitmapMaterial=function(b){this.bitmap=b;this.offset=new THREE.Vector2();this.toString=function(){return"THREE.ParticleBitmapMaterial ( bitmap: "+this.bitmap+" )"}};THREE.ParticleCircleMaterial=function(d,e){this.color=new THREE.Color((e>=0?(e*255)<<24:4278190080)|d);this.toString=function(){return"THREE.ParticleCircleMaterial ( color: "+this.color+" )"}};THREE.ParticleDOMMaterial=function(b){this.domElement=b;this.toString=function(){return"THREE.ParticleDOMMaterial ( domElement: "+this.domElement+" )"}};THREE.Scene=function(){this.objects=[];this.lights=[];this.addObject=function(b){this.objects.push(b)};this.removeObject=function(d){for(var g=0,e=this.objects.length;g<e;g++){if(d==this.objects[g]){this.objects.splice(g,1);return}}};this.addLight=function(b){this.lights.push(b)};this.removeLight=function(d){for(var g=0,e=this.lights.length;g<e;g++){if(d==this.lights[g]){this.lights.splice(g,1);return}}};this.add=function(b){this.addObject(b)};this.toString=function(){return"THREE.Scene ( "+this.objects+" )"}};THREE.Projector=function(){var I=null,K,s,u=[],L,H,A=[],B,z,D=[],C,F,M=[],G=new THREE.Vector4(),J=new THREE.Matrix4(),t=new THREE.Matrix4();this.projectScene=function(e,l){var n,p,N,b,h,Q,O,a,R,U,j,m,P,k,S,d,g,o,q;I=[];s=0,H=0,z=0,F=0;if(l.autoUpdateMatrix){l.updateMatrix()}J.multiply(l.projectionMatrix,l.matrix);O=e.objects;for(n=0,p=O.length;n<p;n++){a=O[n];R=a.matrix;if(a.autoUpdateMatrix){a.updateMatrix()}if(a instanceof THREE.Mesh){t.multiply(J,R);U=a.geometry.vertices;for(N=0,b=U.length;N<b;N++){j=U[N];m=j.positionScreen;m.copy(j.position);t.transform(m);j.__visible=m.z>0&&m.z<1}k=a.geometry.faces;for(h=0,Q=k.length;h<Q;h++){S=k[h];if(S instanceof THREE.Face3){d=U[S.a];g=U[S.b];o=U[S.c];if(d.__visible&&g.__visible&&o.__visible){if((a.doubleSided||(a.flipSided!=(o.positionScreen.x-d.positionScreen.x)*(g.positionScreen.y-d.positionScreen.y)-(o.positionScreen.y-d.positionScreen.y)*(g.positionScreen.x-d.positionScreen.x)<0))){K=u[s]=u[s]||new THREE.RenderableFace3();K.v1.copy(d.positionScreen);K.v2.copy(g.positionScreen);K.v3.copy(o.positionScreen);K.centroidWorld.copy(S.centroid);a.matrix.transform(K.centroidWorld);K.normalWorld.copy(S.normal);a.matrixRotation.transform(K.normalWorld);K.z=Math.max(d.positionScreen.z,Math.max(g.positionScreen.z,o.positionScreen.z));K.material=a.material;K.overdraw=a.overdraw;K.uvs=a.geometry.uvs[h];K.color=S.color;I.push(K);s++}}}else{if(S instanceof THREE.Face4){d=U[S.a];g=U[S.b];o=U[S.c];q=U[S.d];if(d.__visible&&g.__visible&&o.__visible&&q.__visible){if((a.doubleSided||(a.flipSided!=((q.positionScreen.x-d.positionScreen.x)*(g.positionScreen.y-d.positionScreen.y)-(q.positionScreen.y-d.positionScreen.y)*(g.positionScreen.x-d.positionScreen.x)<0||(g.positionScreen.x-o.positionScreen.x)*(q.positionScreen.y-o.positionScreen.y)-(g.positionScreen.y-o.positionScreen.y)*(q.positionScreen.x-o.positionScreen.x)<0)))){L=A[H]=A[H]||new THREE.RenderableFace4();L.v1.copy(d.positionScreen);L.v2.copy(g.positionScreen);L.v3.copy(o.positionScreen);L.v4.copy(q.positionScreen);L.centroidWorld.copy(S.centroid);a.matrix.transform(L.centroidWorld);L.normalWorld.copy(S.normal);a.matrixRotation.transform(L.normalWorld);L.z=Math.max(d.positionScreen.z,Math.max(g.positionScreen.z,Math.max(o.positionScreen.z,q.positionScreen.z)));L.material=a.material;L.overdraw=a.overdraw;L.uvs=a.geometry.uvs[h];L.color=S.color;I.push(L);H++}}}}}}else{if(a instanceof THREE.Line){t.multiply(J,R);U=a.geometry.vertices;for(N=0,b=U.length;N<b;N++){j=U[N];m=j.positionScreen;m.copy(j.position);t.transform(m);j.__visible=m.z>0&&m.z<1;if(N>0){P=a.geometry.vertices[N-1];if(j.__visible&&P.__visible){B=D[z]=D[z]||new THREE.RenderableLine();B.v1.copy(j.positionScreen);B.v2.copy(P.positionScreen);B.z=Math.max(j.positionScreen.z,P.positionScreen.z);B.material=a.material;I.push(B);z++}}}}else{if(a instanceof THREE.Particle){G.set(a.position.x,a.position.y,a.position.z,1);l.matrix.transform(G);l.projectionMatrix.transform(G);a.screen.set(G.x/G.w,G.y/G.w,G.z/G.w);if(a.screen.z>0&&a.screen.z<1){C=M[F]=M[F]||new THREE.RenderableParticle();C.x=a.screen.x;C.y=a.screen.y;C.z=a.screen.z;C.rotation=a.rotation.z;C.scale.x=a.scale.x*Math.abs(G.x/G.w-(G.x+l.projectionMatrix.n11)/(G.w+l.projectionMatrix.n14));C.scale.y=a.scale.y*Math.abs(G.y/G.w-(G.y+l.projectionMatrix.n22)/(G.w+l.projectionMatrix.n24));C.material=a.material;C.color=a.color;I.push(C);F++}}}}}I.sort(w);return I};function w(a,b){return b.z-a.z}};THREE.DOMRenderer=function(){THREE.Renderer.call(this);var m=null,k=new THREE.Projector(),h=document.createElement("div"),j,o,l,n;this.domElement=h;this.setSize=function(a,b){j=a;o=b;l=j/2;n=o/2};this.render=function(d,a){var b,A,z,g,e,B,t,u,w;m=k.projectScene(d,a);for(b=0,A=m.length;b<A;b++){e=m[b];if(e instanceof THREE.RenderableParticle){u=e.x*l+l;w=e.y*n+n;for(z=0,g=e.material.length;z<g;z++){B=e.material[z];if(B instanceof THREE.ParticleDOMMaterial){t=B.domElement;t.style.left=u+"px";t.style.top=w+"px"}}}}}};THREE.CanvasRenderer=function(){var G=null,M=new THREE.Projector(),O=document.createElement("canvas"),N=O.getContext("2d"),U,A,Q,Z,B=new THREE.Rectangle(),R=new THREE.Rectangle(),I=new THREE.Rectangle(),S=new THREE.Color(4294967295),K=new THREE.Color(4294967295),X=new THREE.Color(4294967295),V=new THREE.Vector2(),W=new THREE.Vector3(),Y=new THREE.Vector2(),ab=new THREE.Vector2(),C=new THREE.UV(),D=new THREE.UV(),H=new THREE.UV(),J=new THREE.UV();this.domElement=O;this.autoClear=true;this.setSize=function(b,a){U=b;A=a;Q=U/2;Z=A/2;O.width=U;O.height=A;B.set(-Q,-Z,Q,Z)};this.clear=function(){if(!R.isEmpty()){R.inflate(1);R.minSelf(B);N.setTransform(1,0,0,-1,Q,Z);N.clearRect(R.getX(),R.getY(),R.getWidth(),R.getHeight());R.empty()}};this.render=function(ao,g){var a,ah,af,n,e,s,p=Math.PI*2,z,ae,j,l,ai,ak,u,w,h,k,ag,aj,o,q,am,an,b,d,al,t,m;if(this.autoClear){this.clear()}G=M.projectScene(ao,g);N.setTransform(1,0,0,-1,Q,Z);F(ao,X);for(a=0,ah=G.length;a<ah;a++){af=G[a];I.empty();if(af instanceof THREE.RenderableParticle){z=af.x*Q;ae=af.y*Z;for(n=0,e=af.material.length;n<e;n++){s=af.material[n];if(s instanceof THREE.ParticleCircleMaterial){K.copyRGB(X);S.copyRGBA(s.color);S.multiplySelfRGB(K);S.updateStyleString();o=af.scale.x*Q;q=af.scale.y*Z;I.set(z-o,ae-q,z+o,ae+q);if(!B.instersects(I)){continue}N.save();N.translate(z,ae);N.rotate(-af.rotation);N.scale(o,q);N.beginPath();N.arc(0,0,1,0,p,true);N.closePath();N.fillStyle=S.__styleString;N.fill();N.restore()}else{if(s instanceof THREE.ParticleBitmapMaterial){al=s.bitmap;t=al.width/2;m=al.height/2;am=af.scale.x*Q;an=af.scale.y*Z;o=am*t;q=an*m;b=s.offset.x*am;d=s.offset.y*an;I.set(z+b-o,ae+d-q,z+b+o,ae+d+q);if(!B.instersects(I)){continue}N.save();N.translate(z,ae);N.rotate(-af.rotation);N.scale(am,-an);N.translate(-t+s.offset.x,-m-s.offset.y);N.drawImage(al,0,0);N.restore()}}}}else{if(af instanceof THREE.RenderableLine){z=af.v1.x*Q;ae=af.v1.y*Z;j=af.v2.x*Q;l=af.v2.y*Z;I.addPoint(z,ae);I.addPoint(j,l);if(!B.instersects(I)){continue}N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.closePath();for(n=0,e=af.material.length;n<e;n++){s=af.material[n];if(s instanceof THREE.LineColorMaterial){K.copyRGB(X);S.copyRGBA(s.color);S.multiplySelfRGB(K);S.updateStyleString();N.lineWidth=s.lineWidth;N.lineJoin="round";N.lineCap="round";N.strokeStyle=S.__styleString;N.stroke();I.inflate(N.lineWidth)}}}else{if(af instanceof THREE.RenderableFace3){af.v1.x*=Q;af.v1.y*=Z;af.v2.x*=Q;af.v2.y*=Z;af.v3.x*=Q;af.v3.y*=Z;if(af.overdraw){aa(af.v1,af.v2);aa(af.v2,af.v3);aa(af.v3,af.v1)}z=af.v1.x;ae=af.v1.y;j=af.v2.x;l=af.v2.y;ai=af.v3.x;ak=af.v3.y;I.addPoint(z,ae);I.addPoint(j,l);I.addPoint(ai,ak);if(!B.instersects(I)){continue}for(n=0,e=af.material.length;n<e;n++){s=af.material[n];if(s instanceof THREE.MeshColorFillMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(s.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(z,ae);N.closePath();N.fillStyle=S.__styleString;N.fill()}else{if(s instanceof THREE.MeshColorStrokeMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(s.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(z,ae);N.closePath();N.lineWidth=s.lineWidth;N.lineJoin="round";N.lineCap="round";N.strokeStyle=S.__styleString;N.stroke();I.inflate(N.lineWidth)}else{if(s instanceof THREE.MeshFaceColorFillMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(af.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(z,ae);N.closePath();N.fillStyle=S.__styleString;N.fill()}else{if(s instanceof THREE.MeshFaceColorStrokeMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(af.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(z,ae);N.closePath();N.lineWidth=s.lineWidth;N.lineJoin="round";N.lineCap="round";N.strokeStyle=S.__styleString;N.stroke();I.inflate(N.lineWidth)}else{if(s instanceof THREE.MeshBitmapUVMappingMaterial){al=s.bitmap;t=al.width-1;m=al.height-1;C.copy(af.uvs[0]);D.copy(af.uvs[1]);H.copy(af.uvs[2]);C.u*=t;C.v*=m;D.u*=t;D.v*=m;H.u*=t;H.v*=m;L(al,z,ae,j,l,ai,ak,C.u,C.v,D.u,D.v,H.u,H.v)}}}}}}}else{if(af instanceof THREE.RenderableFace4){af.v1.x*=Q;af.v1.y*=Z;af.v2.x*=Q;af.v2.y*=Z;af.v3.x*=Q;af.v3.y*=Z;af.v4.x*=Q;af.v4.y*=Z;Y.copy(af.v2);ab.copy(af.v4);if(af.overdraw){aa(af.v1,af.v2);aa(af.v2,af.v4);aa(af.v4,af.v1)}z=af.v1.x;ae=af.v1.y;j=af.v2.x;l=af.v2.y;u=af.v4.x;w=af.v4.y;if(af.overdraw){aa(af.v3,Y);aa(af.v3,ab)}ai=af.v3.x;ak=af.v3.y;h=Y.x;k=Y.y;ag=ab.x;aj=ab.y;I.addPoint(z,ae);I.addPoint(j,l);I.addPoint(ai,ak);I.addPoint(u,w);if(!B.instersects(I)){continue}for(n=0,e=af.material.length;n<e;n++){s=af.material[n];if(s instanceof THREE.MeshColorFillMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(s.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(u,w);N.lineTo(z,ae);N.closePath();N.fillStyle=S.__styleString;N.fill()}else{if(s instanceof THREE.MeshColorStrokeMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(s.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(u,w);N.lineTo(z,ae);N.closePath();N.lineWidth=s.lineWidth;N.lineJoin="round";N.lineCap="round";N.strokeStyle=S.__styleString;N.stroke();I.inflate(N.lineWidth)}else{if(s instanceof THREE.MeshFaceColorFillMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(af.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(u,w);N.lineTo(z,ae);N.closePath();N.fillStyle=S.__styleString;N.fill()}else{if(s instanceof THREE.MeshFaceColorStrokeMaterial){K.copyRGB(X);P(ao,af,K);S.copyRGBA(af.color);S.multiplySelfRGB(K);S.updateStyleString();N.beginPath();N.moveTo(z,ae);N.lineTo(j,l);N.lineTo(ai,ak);N.lineTo(u,w);N.lineTo(z,ae);N.closePath();N.lineWidth=s.lineWidth;N.lineJoin="round";N.lineCap="round";N.strokeStyle=S.__styleString;N.stroke();I.inflate(N.lineWidth)}else{if(s instanceof THREE.MeshBitmapUVMappingMaterial){al=s.bitmap;t=al.width-1;m=al.height-1;C.copy(af.uvs[0]);D.copy(af.uvs[1]);H.copy(af.uvs[2]);J.copy(af.uvs[3]);C.u*=t;C.v*=m;D.u*=t;D.v*=m;H.u*=t;H.v*=m;J.u*=t;J.v*=m;L(al,z,ae,j,l,u,w,C.u,C.v,D.u,D.v,J.u,J.v);L(al,h,k,ai,ak,ag,aj,D.u,D.v,H.u,H.v,J.u,J.v)}}}}}}}}}}R.addRectangle(I)}N.setTransform(1,0,0,1,0,0)};function F(b,e){var g,d,a;e.setRGBA(1,1,1,1);for(g=0,d=b.lights.length;g<d;g++){a=b.lights[g];if(a instanceof THREE.AmbientLight){e.r*=a.color.r;e.g*=a.color.g;e.b*=a.color.b}}}function P(b,e,h){var j,d,a,g;for(j=0,d=b.lights.length;j<d;j++){a=b.lights[j];if(a instanceof THREE.DirectionalLight){g=e.normalWorld.dot(a.position)*a.intensity;if(g>0){h.r+=a.color.r*g;h.g+=a.color.g*g;h.b+=a.color.b*g}}else{if(a instanceof THREE.PointLight){W.sub(a.position,e.centroidWorld);W.normalize();g=e.normalWorld.dot(W)*a.intensity;if(g>0){h.r+=a.color.r*g;h.g+=a.color.g*g;h.b+=a.color.b*g}}}}}function L(a,o,p,h,j,w,ac,e,g,t,u,k,l){var z,b,d,q,s,m,n;N.beginPath();N.moveTo(o,p);N.lineTo(h,j);N.lineTo(w,ac);N.lineTo(o,p);N.closePath();N.save();N.clip();z=e*(l-u)-t*l+k*u+(t-k)*g;b=-(g*(w-h)-u*w+l*h+(u-l)*o)/z;d=(u*ac+g*(j-ac)-l*j+(l-u)*p)/z;q=(e*(w-h)-t*w+k*h+(t-k)*o)/z;s=-(t*ac+e*(j-ac)-k*j+(k-t)*p)/z;m=(e*(l*h-u*w)+g*(t*w-k*h)+(k*u-t*l)*o)/z;n=(e*(l*j-u*ac)+g*(t*ac-k*j)+(k*u-t*l)*p)/z;N.transform(b,d,q,s,m,n);N.drawImage(a,0,0);N.restore()}function aa(b,a){V.sub(a,b);V.unit();V.multiplyScalar(0.75);a.addSelf(V);b.subSelf(V)}};THREE.SVGRenderer=function(){var B=null,H=new THREE.Projector(),G=document.createElementNS("http://www.w3.org/2000/svg","svg"),N,u,J,R,z=new THREE.Rectangle(),C=new THREE.Rectangle(),M=new THREE.Color(4294967295),D=new THREE.Color(4294967295),Q=new THREE.Color(4294967295),O=new THREE.Vector3(),P=[],L=[],w=1;this.domElement=G;this.autoClear=true;this.setQuality=function(a){switch(a){case"high":w=1;break;case"low":w=0;break}};this.setSize=function(a,b){N=a;u=b;J=N/2;R=u/2;G.setAttribute("viewBox",(-J)+" "+(-R)+" "+N+" "+u);G.setAttribute("width",N);G.setAttribute("height",u);z.set(-J,-R,J,R)};this.clear=function(){while(G.childNodes.length>0){G.removeChild(G.childNodes[0])}};this.render=function(a,e){var b,n,m,d,l,S,o=0,j=0,t,V,g,h,k,p,s,U,W,q;if(this.autoClear){this.clear()}B=H.projectScene(a,e);A(a,Q);for(b=0,n=B.length;b<n;b++){l=B[b];for(m=0,d=l.material.length;m<d;m++){S=l.material[m];C.empty();if(l instanceof THREE.RenderableParticle){V=l.x*J;g=l.y*-R;q=l.size*J;C.set(V-q,g-q,V+q,g+q);if(!z.instersects(C)){continue}t=F(j++);t.setAttribute("cx",V);t.setAttribute("cy",g);t.setAttribute("r",q)}else{if(l instanceof THREE.RenderableFace3){V=l.v1.x*J;g=l.v1.y*-R;h=l.v2.x*J;k=l.v2.y*-R;p=l.v3.x*J;s=l.v3.y*-R;C.addPoint(V,g);C.addPoint(h,k);C.addPoint(p,s);if(!z.instersects(C)){continue}t=K(o++);t.setAttribute("d","M "+V+" "+g+" L "+h+" "+k+" L "+p+","+s+"z")}else{if(l instanceof THREE.RenderableFace4){V=l.v1.x*J;g=l.v1.y*-R;h=l.v2.x*J;k=l.v2.y*-R;p=l.v3.x*J;s=l.v3.y*-R;U=l.v4.x*J;W=l.v4.y*-R;C.addPoint(V,g);C.addPoint(h,k);C.addPoint(p,s);C.addPoint(U,W);if(!z.instersects(C)){continue}t=K(o++);t.setAttribute("d","M "+V+" "+g+" L "+h+" "+k+" L "+p+","+s+" L "+U+","+W+"z")}}}if(S instanceof THREE.MeshColorFillMaterial){D.copyRGB(Q);I(a,l,D);M.copyRGBA(S.color);M.multiplySelfRGB(D);M.updateStyleString();t.setAttribute("style","fill: "+M.__styleString)}else{if(S instanceof THREE.MeshFaceColorFillMaterial){D.copyRGB(Q);I(a,l,D);M.copyRGBA(l.color);M.multiplySelfRGB(D);M.updateStyleString();t.setAttribute("style","fill: "+M.__styleString)}else{if(S instanceof THREE.MeshColorStrokeMaterial){D.copyRGB(Q);I(a,l,D);M.copyRGBA(S.color);M.multiplySelfRGB(D);M.updateStyleString();t.setAttribute("style","fill: none; stroke: "+M.__styleString+"; stroke-width: "+S.lineWidth+"; stroke-linecap: round; stroke-linejoin: round")}else{if(S instanceof THREE.MeshFaceColorStrokeMaterial){D.copyRGB(Q);I(a,l,D);M.copyRGBA(l.color);M.multiplySelfRGB(D);M.updateStyleString();t.setAttribute("style","fill: none; stroke: "+M.__styleString+"; stroke-width: "+S.lineWidth+"; stroke-linecap: round; stroke-linejoin: round")}}}}G.appendChild(t)}}};function A(g,b){var d,a,e;b.setRGBA(1,1,1,1);for(d=0,a=g.lights.length;d<a;d++){e=g.lights[d];if(e instanceof THREE.AmbientLight){b.r*=e.color.r;b.g*=e.color.g;b.b*=e.color.b}}}function I(b,j,d){var e,h,g,a;for(e=0,h=b.lights.length;e<h;e++){g=b.lights[e];if(g instanceof THREE.DirectionalLight){a=j.normalWorld.dot(g.position)*g.intensity;if(a>0){d.r+=g.color.r*a;d.g+=g.color.g*a;d.b+=g.color.b*a}}else{if(g instanceof THREE.PointLight){O.sub(g.position,j.centroidWorld);O.normalize();a=j.normalWorld.dot(O)*g.intensity;if(a>0){d.r+=g.color.r*a;d.g+=g.color.g*a;d.b+=g.color.b*a}}}}}function K(a){if(P[a]==null){P[a]=document.createElementNS("http://www.w3.org/2000/svg","path");if(w==0){P[a].setAttribute("shape-rendering","crispEdges")}return P[a]}return P[a]}function F(a){if(L[a]==null){L[a]=document.createElementNS("http://www.w3.org/2000/svg","circle");if(w==0){L[a].setAttribute("shape-rendering","crispEdges")}return L[a]}return L[a]}};THREE.WebGLRenderer=function(){var o=document.createElement("canvas"),k,l,p=new THREE.Matrix4(),m;this.domElement=o;this.autoClear=true;n();q();this.setSize=function(a,b){o.width=a;o.height=b;k.viewport(0,0,o.width,o.height)};this.clear=function(){k.clear(k.COLOR_BUFFER_BIT|k.DEPTH_BUFFER_BIT)};this.render=function(e,V){var Z,d,a,g,b,ac,ab,af,O,ah,ad,h,S,ae,Q,P,X,aa,R,W,ag,ai,aj,ak,Y,U;if(this.autoClear){this.clear()}k.uniform1i(l.enableLighting,e.lights.length);for(Y=0,U=e.lights.length;Y<U;Y++){af=e.lights[Y];if(af instanceof THREE.AmbientLight){ac=af.color;k.uniform3f(l.ambientColor,ac.r,ac.g,ac.b)}else{if(af instanceof THREE.DirectionalLight){ac=af.color;ab=af.position;k.uniform3f(l.lightingDirection,ab.x,ab.y,ab.z);k.uniform3f(l.directionalColor,ac.r,ac.g,ac.b)}}}for(ae=0,Q=e.objects.length;ae<Q;ae++){a=e.objects[ae];if(a instanceof THREE.Mesh){if(!a.__webGLVertexBuffer){O=[];ah=[];ad=[];h=[];S=0;for(P=0,X=a.geometry.faces.length;P<X;P++){Z=a.geometry.faces[P];d=Z.color;b=Z.normal;if(Z instanceof THREE.Face3){ag=a.geometry.vertices[Z.a].position;ai=a.geometry.vertices[Z.b].position;aj=a.geometry.vertices[Z.c].position;O.push(ag.x,ag.y,ag.z);O.push(ai.x,ai.y,ai.z);O.push(aj.x,aj.y,aj.z);h.push(b.x,b.y,b.z);h.push(b.x,b.y,b.z);h.push(b.x,b.y,b.z);ad.push(d.r,d.g,d.b,d.a);ad.push(d.r,d.g,d.b,d.a);ad.push(d.r,d.g,d.b,d.a);ah.push(S,S+1,S+2);S+=3}else{if(Z instanceof THREE.Face4){ag=a.geometry.vertices[Z.a].position;ai=a.geometry.vertices[Z.b].position;aj=a.geometry.vertices[Z.c].position;ak=a.geometry.vertices[Z.d].position;O.push(ag.x,ag.y,ag.z);O.push(ai.x,ai.y,ai.z);O.push(aj.x,aj.y,aj.z);O.push(ak.x,ak.y,ak.z);h.push(b.x,b.y,b.z);h.push(b.x,b.y,b.z);h.push(b.x,b.y,b.z);h.push(b.x,b.y,b.z);ad.push(d.r,d.g,d.b,d.a);ad.push(d.r,d.g,d.b,d.a);ad.push(d.r,d.g,d.b,d.a);ad.push(d.r,d.g,d.b,d.a);ah.push(S,S+1,S+2);ah.push(S,S+2,S+3);S+=4}}}if(!O.length){continue}a.__webGLVertexBuffer=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,a.__webGLVertexBuffer);k.bufferData(k.ARRAY_BUFFER,new Float32Array(O),k.STATIC_DRAW);a.__webGLNormalBuffer=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,a.__webGLNormalBuffer);k.bufferData(k.ARRAY_BUFFER,new Float32Array(h),k.STATIC_DRAW);a.__webGLColorBuffer=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,a.__webGLColorBuffer);k.bufferData(k.ARRAY_BUFFER,new Float32Array(ad),k.STATIC_DRAW);a.__webGLFaceBuffer=k.createBuffer();k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.__webGLFaceBuffer);k.bufferData(k.ELEMENT_ARRAY_BUFFER,new Uint16Array(ah),k.STATIC_DRAW);a.__webGLFaceCount=ah.length}p.multiply(V.matrix,a.matrix);l.viewMatrixArray=new Float32Array(p.flatten());l.projectionMatrixArray=new Float32Array(V.projectionMatrix.flatten());m=THREE.Matrix4.makeInvert(p).transpose();l.normalMatrixArray=new Float32Array(m.flatten());k.uniformMatrix4fv(l.viewMatrix,false,l.viewMatrixArray);k.uniformMatrix4fv(l.projectionMatrix,false,l.projectionMatrixArray);k.uniformMatrix4fv(l.normalMatrix,false,l.normalMatrixArray);k.bindBuffer(k.ARRAY_BUFFER,a.__webGLVertexBuffer);k.vertexAttribPointer(l.position,3,k.FLOAT,false,0,0);k.bindBuffer(k.ARRAY_BUFFER,a.__webGLNormalBuffer);k.vertexAttribPointer(l.normal,3,k.FLOAT,false,0,0);for(aa=0,R=a.material.length;aa<R;aa++){g=a.material[aa];if(g instanceof THREE.MeshColorFillMaterial){if(!g.__webGLColorBuffer){ad=[];for(W=0;W<a.__webGLFaceCount;W++){ad.push(g.color.r,g.color.g,g.color.b,g.color.a)}g.__webGLColorBuffer=k.createBuffer();k.bindBuffer(k.ARRAY_BUFFER,g.__webGLColorBuffer);k.bufferData(k.ARRAY_BUFFER,new Float32Array(ad),k.STATIC_DRAW)}k.bindBuffer(k.ARRAY_BUFFER,g.__webGLColorBuffer);k.vertexAttribPointer(l.color,4,k.FLOAT,false,0,0)}else{if(g instanceof THREE.MeshFaceColorFillMaterial){k.bindBuffer(k.ARRAY_BUFFER,a.__webGLColorBuffer);k.enableVertexAttribArray(l.color);k.vertexAttribPointer(l.color,4,k.FLOAT,false,0,0)}}}k.bindBuffer(k.ELEMENT_ARRAY_BUFFER,a.__webGLFaceBuffer);k.drawElements(k.TRIANGLES,a.__webGLFaceCount,k.UNSIGNED_SHORT,0)}}};function n(){try{k=o.getContext("experimental-webgl")}catch(a){}if(!k){alert("WebGL not supported");throw"cannot create webgl context"}k.clearColor(0,0,0,1);k.clearDepth(1);k.enable(k.DEPTH_TEST);k.depthFunc(k.LEQUAL);k.enable(k.BLEND);k.blendFunc(k.SRC_ALPHA,k.ONE_MINUS_SRC_ALPHA);k.clearColor(0,0,0,0)}function q(){l=k.createProgram();k.attachShader(l,j("fragment",["#ifdef GL_ES","precision highp float;","#endif","varying vec4 vcolor;","varying vec3 lightWeighting;","void main(){","gl_FragColor = vec4(vcolor.rgb * lightWeighting, vcolor.a);","}"].join("\n")));k.attachShader(l,j("vertex",["attribute vec3 position;","attribute vec3 normal;","attribute vec4 color;","uniform bool enableLighting;","uniform vec3 ambientColor;","uniform vec3 directionalColor;","uniform vec3 lightingDirection;","uniform mat4 viewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 normalMatrix;","varying vec4 vcolor;","varying vec3 lightWeighting;","void main(void) {","if(!enableLighting) {","lightWeighting = vec3(1.0, 1.0, 1.0);","} else {","vec4 transformedNormal = normalMatrix * vec4(normal, 1.0);","float directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);","lightWeighting = ambientColor + directionalColor * directionalLightWeighting;","}","vcolor = color;","gl_Position = projectionMatrix * viewMatrix * vec4( position, 1.0 );","}"].join("\n")));k.linkProgram(l);if(!k.getProgramParameter(l,k.LINK_STATUS)){alert("Could not initialise shaders")}k.useProgram(l);l.viewMatrix=k.getUniformLocation(l,"viewMatrix");l.projectionMatrix=k.getUniformLocation(l,"projectionMatrix");l.normalMatrix=k.getUniformLocation(l,"normalMatrix");l.enableLighting=k.getUniformLocation(l,"enableLighting");l.ambientColor=k.getUniformLocation(l,"ambientColor");l.directionalColor=k.getUniformLocation(l,"directionalColor");l.lightingDirection=k.getUniformLocation(l,"lightingDirection");l.color=k.getAttribLocation(l,"color");k.enableVertexAttribArray(l.color);l.position=k.getAttribLocation(l,"position");k.enableVertexAttribArray(l.position);l.normal=k.getAttribLocation(l,"normal");k.enableVertexAttribArray(l.normal);l.viewMatrixArray=new Float32Array(16);l.projectionMatrixArray=new Float32Array(16)}function j(b,d){var a;if(b=="fragment"){a=k.createShader(k.FRAGMENT_SHADER)}else{if(b=="vertex"){a=k.createShader(k.VERTEX_SHADER)}}k.shaderSource(a,d);k.compileShader(a);if(!k.getShaderParameter(a,k.COMPILE_STATUS)){alert(k.getShaderInfoLog(a));return null}return a}};THREE.RenderableFace3=function(){this.v1=new THREE.Vector2();this.v2=new THREE.Vector2();this.v3=new THREE.Vector2();this.centroidWorld=new THREE.Vector3();this.normalWorld=new THREE.Vector3();this.z=null;this.color=null;this.material=null};THREE.RenderableFace4=function(){this.v1=new THREE.Vector2();this.v2=new THREE.Vector2();this.v3=new THREE.Vector2();this.v4=new THREE.Vector2();this.centroidWorld=new THREE.Vector3();this.normalWorld=new THREE.Vector3();this.z=null;this.color=null;this.material=null};THREE.RenderableParticle=function(){this.x=null;this.y=null;this.z=null;this.rotation=null;this.scale=new THREE.Vector2();this.color=null;this.material=null};THREE.RenderableLine=function(){this.v1=new THREE.Vector2();this.v2=new THREE.Vector2();this.z=null;this.color=null;this.material=null};var Plane=function(q,p,l,o){THREE.Geometry.call(this);var j,h,k=q/2,g=p/2,t=l||1,s=o||1,u=t+1,e=s+1,D=q/t,z=p/s;for(h=0;h<e;h++){for(j=0;j<u;j++){var n=j*D-k;var m=h*z-g;this.vertices.push(new THREE.Vertex(new THREE.Vector3(n,-m,0)))}}for(h=0;h<s;h++){for(j=0;j<t;j++){var C=j+u*h;var B=j+u*(h+1);var A=(j+1)+u*(h+1);var w=(j+1)+u*h;this.faces.push(new THREE.Face4(C,B,A,w));this.uvs.push([new THREE.UV(j/t,h/s),new THREE.UV(j/t,(h+1)/s),new THREE.UV((j+1)/t,(h+1)/s),new THREE.UV((j+1)/t,h/s)])}}this.computeCentroids();this.computeNormals()};Plane.prototype=new THREE.Geometry();Plane.prototype.constructor=Plane;var Cube=function(a,j,e){THREE.Geometry.call(this);var l=this,k=a/2,h=j/2,d=e/2;g(k,h,-d);g(k,-h,-d);g(-k,-h,-d);g(-k,h,-d);g(k,h,d);g(k,-h,d);g(-k,-h,d);g(-k,h,d);b(0,1,2,3);b(4,7,6,5);b(0,4,5,1);b(1,5,6,2);b(2,6,7,3);b(4,0,3,7);function g(m,o,n){l.vertices.push(new THREE.Vertex(new THREE.Vector3(m,o,n)))}function b(n,m,p,o){l.faces.push(new THREE.Face4(n,m,p,o))}this.computeCentroids();this.computeNormals()};Cube.prototype=new THREE.Geometry();Cube.prototype.constructor=Cube;var Sphere=function(l,n,t){THREE.Geometry.call(this);var G=n||8,B=t||6;var C,A;var M=Math.max(3,G);var h=Math.max(2,B);var q=[];for(A=0;A<(h+1);A++){var I=A/h;var J=l*Math.cos(I*Math.PI);var g=l*Math.sin(I*Math.PI);var b=[];var a=0;for(C=0;C<M;C++){var F=2*C/M;var P=g*Math.sin(F*Math.PI);var L=g*Math.cos(F*Math.PI);if(!((A==0||A==h)&&C>0)){a=this.vertices.push(new THREE.Vertex(new THREE.Vector3(L,J,P)))-1}b.push(a)}q.push(b)}var e=q.length;for(A=0;A<e;A++){var s=q[A].length;if(A>0){for(C=0;C<s;C++){var d=C==(s-1);var O=q[A][d?0:C+1];var K=q[A][(d?s-1:C)];var H=q[A-1][(d?s-1:C)];var D=q[A-1][d?0:C+1];var w=A/(e-1);var u=(A-1)/(e-1);var o=(C+1)/s;var m=C/s;var k=new THREE.UV(1-o,w);var z=new THREE.UV(1-m,w);var p=new THREE.UV(1-m,u);var N=new THREE.UV(1-o,u);if(A<(q.length-1)){this.faces.push(new THREE.Face3(O,K,H));this.uvs.push([k,z,p])}if(A>1){this.faces.push(new THREE.Face3(O,H,D));this.uvs.push([k,p,N])}}}}this.computeCentroids();this.computeNormals()};Sphere.prototype=new THREE.Geometry();Sphere.prototype.constructor=Sphere;function bg_colour(a){cacophony.bg.fill=a.colour;$("#wrapper").css("background-color",a.colour)}function bg_fade_to(a,b){if(!b){b=0.1}if(!cacophony.playing){setTimeout('bg_fade_to ({colour: "'+a.colour+'"}, '+b+")",cacophony.beatLength()/12);return}cacophony.bg2.fill=a.colour.replace("%d",b);if(b>=0.98){cacophony.bg.fill=a.colour.replace("%d",1);cacophony.bg2.fill="rgba(27, 1, 1, 0)";return}setTimeout('bg_fade_to ({colour: "'+a.colour+'"}, '+(b+0.1)+")",cacophony.beatLength()/12)}function bg_fade_in(a){if(!a){a=10}else{a-=1}if(!cacophony.playing){setTimeout("bg_fade_in ("+a+");",53);return}if(!f){f=new Rectangle(cacophony.width,cacophony.height);f.x=0;f.y=0}f.fill="rgba(27, 1, 1, "+(a/10)+")";cacophony.canvas.append(f);cacophony.bg.fill="rgba(27, 1, 1, 0)";if(a>0){setTimeout("bg_fade_in ("+a+");",53)}else{cacophony.canvas.remove(f);f=false}}function bg_fade_out(a){if(!a){a=0}if(!cacophony.playing){setTimeout("bg_fade_out ("+a+");",53);return}a+=0.8;if(!f){f=new Rectangle(cacophony.width,cacophony.height);f.x=0;f.y=0}f.fill="rgba(27, 1, 1, "+(a/10)+")";cacophony.canvas.append(f);if(a<10){setTimeout("bg_fade_out ("+a+");",53)}else{cacophony.canvas.remove(f);f=false;bg_colour({colour:"rgba(27, 1, 1, 1)"})}}function core_jump_to(a){cacophony.jumpTo(a)}function core_jump_to_time(a){cacophony.jumpToTime(a)}function core_pause(a){if(a){setTimeout(core_continue,cacophony.beatLength*a)}cacophony.pause()}function core_continue(){cacophony.play()}function core_html(a){if(a.top!=null){cacophony.html(a.html,a.top,a.left)}else{cacophony.html(a.html)}}function core_clear_html(){cacophony.html()}function core_clickable_areas(d){var b='<div style="width: '+cacophony.width+"px; height: "+cacophony.height+'px; position: relative; border: 0px">';for(var a=0;a<d.coords.length;a++){b+='<a href="#" onclick="'+d.coords[a].callback+'; return false"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABAQMAAAAl21bKAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAApJREFUCNdjYAAAAAIAAeIhvDMAAAAASUVORK5CYII=" style="position:absolute; border: 0px none; top: '+d.coords[a].y+"px; left: "+d.coords[a].x+"px; height: "+d.coords[a].h+"px; width: "+d.coords[a].w+'px" /></a>'}b+="</div>";cacophony.html(b,0,0)}_e.bg_colour=bg_colour;_e.bg_fade_to=bg_fade_to;_e.bg_fade_in=bg_fade_in;_e.bg_fade_out=bg_fade_out;_e.jump_to=core_jump_to;_e.jump_to_time=core_jump_to_time;_e.pause=core_pause;_e["continue"]=core_continue;_e.html=core_html;_e.clear_html=core_clear_html;_e.clickable_areas=core_clickable_areas;var context_tok=new Tokenizer(),context_comp=new Compiler(),context_saved_context,context_img,context_tokenz=document.createElement("input");context_tokenz.setAttribute("type","hidden");context_tokenz.setAttribute("id","context-tokens");$(document).ready(function(){document.getElementsByTagName("body")[0].appendChild(context_tokenz)});function context_on(e){var b,d,a,g;cacophony.visible([0,0,1,0,0,0]);b=$("#cacophony-canvas2");b.find("#contextCanvas").remove();d=document.createElement("canvas");d.width=b.width();d.height=b.height();d.id="contextCanvas";b.append(d);context_tokenz.value=e;a=context_tok.tokenize("context-tokens");g=context_comp.compile(a);Renderer.queue=[];Renderer.render(g,"contextCanvas")}function context_off(){context_img=$("#contextCanvas").get(0).toDataURL("image/png");_i.context=document.createElement("img");_i.context.src=context_img;cacophony.visible([1,1,0,0,0,0])}_e.context_on=context_on;_e.context_off=context_off;var rib,con,SCREEN_WIDTH=854,SCREEN_HEIGHT=480,BRUSH_SIZE=1,BRUSH_PRESSURE=1,COLOR=[0,0,0],ribbon_img,ribbon_save_to;function ribbon_on(a){cacophony.visible([0,0,0,1,0,1]);if(a){if(a.msg){cacophony.html(a.msg)}ribbon_save_to=(a.save_to)?a.save_to:false}harmony_init()}function ribbon_off(){ribbon_img=canvas.toDataURL("image/png");_i.ribbon=document.createElement("img");_i.ribbon.src=ribbon_img;cacophony.visible([1,1,0,0,0,0]);if(ribbon_save_to){$.post(ribbon_save_to,{image:ribbon_img})}}_e.ribbon_on=ribbon_on;_e.ribbon_off=ribbon_off;$(document).ready(function(){cacophony.addInterval(text_display,(cacophony.beatLength()/4));cacophony.addInterval(erase_text,65);cacophony.addInterval(erase_text_queue,(cacophony.beatLength()*0.7))});var text_queue=[],text_rendered=[],erase_pre_queue=[],erase_queue=[],cur_letter=0,erased_letters=0,cur_x=30,cur_colour;function lyrics(a){a.txt=a.txt.replace("{input}",input_value);text_queue.push(a)}function text_display(){if(text_queue.length==0){return}if(cur_letter==0){cur_x=text_queue[0].x;cur_colour=(text_queue[0].colour)?text_queue[0].colour:"rgba(102, 102, 102, 1.0)"}var a=new ElementNode(E("span",text_queue[0].txt[cur_letter]),{x:cur_x,y:text_queue[0].y,fontSize:"20",fontFamily:"courier new",noScaling:true,color:cur_colour});text_rendered.push({t:a,l:text_queue[0].txt[cur_letter],o:1});cacophony.canvas.append(a);cur_x+=16;cur_letter++;if(cur_letter==text_queue[0].txt.length){erase_pre_queue.push(text_queue.shift());cur_letter=0}}function erase_text_queue(){if(erase_pre_queue.length>0){erase_queue.push(erase_pre_queue.shift())}}function erase_text(){if(erase_queue.length==0){return}if(erased_letters>=erase_queue[0].txt.length){for(var a=0;a<erase_queue[0].txt.length;a++){cacophony.canvas.remove(text_rendered[0].t);text_rendered.shift()}erase_queue.shift();erased_letters=0;return}for(var b=0;b<erase_queue[0].txt.length/2;b++){r=-1;while(text_rendered.length>0&&!text_rendered[r]){r=Math.floor(Math.random()*erase_queue[0].txt.length)}text_rendered[r].o-=0.1;op=Math.round((text_rendered[r].o)*10)/10;if(op>=0){text_rendered[r].t.content.style.opacity=op}if(op==0){erased_letters++}}}_e.lyrics=lyrics;var input_thanks,input_save_to,input_jump_to,input_options=[],input_value="Default",input_choice=false,input_autocomplete;function input_text(a){cacophony.input=true;input_thanks=a.thanks;input_save_to=a.save_to;input_jump_to=a.jump_to;if(!a.value){a.value=""}if(a.autocomplete){input_autocomplete=a.autocomplete;autocomplete='onfocus="$(this).autocomplete ({source: input_autocomplete})"'}else{autocomplete=""}cacophony.html('<div style="width: '+Math.round(cacophony.width*0.6)+"px; height: "+Math.round(cacophony.height*0.35)+'px; background-color: rgba(255, 255, 255, .7); padding: 20px; text-align: left; border-radius: 10px"><form onsubmit="return input_save (this)" style="display: inline"><p>'+a.msg+'</p><p><input type="text" id="input-field" name="input-field" value="'+a.value+'" '+autocomplete+' style="border: 1px solid #666; width: 70%; height: 20px" />&nbsp;<input type="submit" value="Submit" />&nbsp;<a href="#" onclick="return input_cancel ()">Cancel</a></p></form></div>')}function input_textarea(a){cacophony.input=true;input_thanks=a.thanks;input_save_to=a.save_to;input_jump_to=a.jump_to;if(!a.value){a.value=""}cacophony.html('<div style="width: '+Math.round(cacophony.width*0.6)+"px; height: "+Math.round(cacophony.height*0.35)+'px; background-color: rgba(255, 255, 255, .7); padding: 20px; text-align: left; border-radius: 10px"><form onsubmit="return input_save (this)" style="display: inline"><p>'+a.msg+'</p><p><textarea id="input-field" name="input-field" style="border: 1px solid #666; width: 100%; height: 60px">'+a.value+'</textarea></p><p><input type="submit" value="Submit" />&nbsp;<a href="#" onclick="return input_cancel ()">Cancel</a></p></form></div>')}function input_branching(d){input_options=d.options;input_save_to=d.save_to;cacophony.html(d.msg);var b="";for(var a=0;a<input_options.length;a++){b+='<p><a href="#" onclick="return input_choose ('+a+')">'+input_options[a].choice+"</a></p>"}cacophony.html('<div style="width: '+Math.round(cacophony.width*0.6)+"px; height: "+Math.round(cacophony.height*0.35)+'px; background-color: rgba(255, 255, 255, .7); padding: 20px; text-align: left; border-radius: 10px"><p>'+d.msg+"</p>"+b+"</div>")}function input_save(){cacophony.input=false;input_value=$("#input-field").get(0).value;$.post(input_save_to,{input:input_value});cacophony.html('<div style="width: '+Math.round(cacophony.width*0.6)+"px; height: "+Math.round(cacophony.height*0.35)+'px; background-color: rgba(255, 255, 255, .7); padding: 20px; text-align: left; border-radius: 10px"><p style="width: 100%">'+input_thanks+"</p></div>");setTimeout("cacophony.html ();",3000);if(input_jump_to){cacophony.jumpTo(input_jump_to);input_jump_to=false}return false}function input_cancel(){cacophony.input=false;input_value=false;cacophony.html();if(input_jump_to){cacophony.jumpTo(input_jump_to);input_jump_to=false}return false}function input_choose(a){input_choice=a+1;if(input_save_to){$.post(input_save_to,{choice:input_choice})}cacophony.html();cacophony.jumpTo(input_options[a].jump_to)}_e.input_text=input_text;_e.input_textarea=input_textarea;_e.input_branching=input_branching;var slideshow_duration=4,slideshow_limit=false,slideshow_cur=0,slideshow_n=0,slideshow_images=[],slideshow_front_img,slideshow_back_img,slideshow_front_burns,slideshow_back_burns;function slideshow_burns(b){b=(isNaN(b))?1.5:b;var a={_x0:0,_x1:0,_y0:0,_y1:0,_w0:0,_w1:0,_h0:0,_h1:0,apply:function(d,e){e*=0.02;d.x=(this._x0-this._x1)*e-this._x0;d.y=(this._y0-this._y1)*e-this._y0;d.dWidth=(this._w1-this._w0)*e+this._w0;d.dHeight=(this._h1-this._h0)*e+this._h0}};if(b<cacophony.width/cacophony.height){a._w0=cacophony.width*(1+(0.25*Math.random()));a._w1=cacophony.width*(1+(0.25*Math.random()));a._h0=a._w0/b;a._h1=a._w1/b}else{a._h0=cacophony.height*(1+(0.25*Math.random()));a._h1=cacophony.height*(1+(0.25*Math.random()));a._w0=a._h0*b;a._w1=a._h1*b}a._x0=(a._w0-cacophony.width)*Math.random();a._x1=(a._w1-cacophony.width)*Math.random();a._y0=(a._h0-cacophony.height)*Math.random();a._y1=(a._h1-cacophony.height)*Math.random();return a}function slideshow_step(){if(!cacophony.playing){setTimeout(slideshow_step,(cacophony.beatLength()*slideshow_duration)/25);return}slideshow_n++;if(slideshow_n==20){slideshow_cur++;if(slideshow_images[slideshow_cur]){slideshow_front_img=new ImageNode(slideshow_images[slideshow_cur]);slideshow_front_burns=slideshow_burns(slideshow_front_img.width/slideshow_front_img.height);slideshow_front_img.opacity=0;slideshow_front_burns.apply(slideshow_front_img,-5);cacophony.canvas.append(slideshow_front_img)}}else{if(slideshow_n==25){cacophony.canvas.remove(slideshow_back_img);slideshow_back_img=slideshow_front_img;slideshow_back_burns=slideshow_front_burns;if(slideshow_back_img){slideshow_back_img.opacity=1}slideshow_front_img=null;slideshow_front_burns=null;slideshow_n=0}else{if(slideshow_n>20){if(slideshow_front_img){slideshow_front_img.opacity+=0.2;slideshow_front_burns.apply(slideshow_front_img,slideshow_n-25)}slideshow_back_img.opacity-=0.2}}}if(slideshow_back_img){slideshow_back_burns.apply(slideshow_back_img,slideshow_n);setTimeout(slideshow_step,(cacophony.beatLength()*slideshow_duration)/25)}}function slideshow(b){if(b){slideshow_cur=0;slideshow_limit=(b.limit)?b.limit:false;slideshow_duration=(b.duration)?b.duration:4;slideshow_images=[];for(var a=0;a<b.images.length;a++){if(slideshow_limit&&a==slideshow_limit){break}slideshow_images[a]=_i[b.images[a]]}}slideshow_n=0;slideshow_back_img=new ImageNode(slideshow_images[0]);slideshow_back_burns=slideshow_burns(slideshow_back_img.width/slideshow_back_img.height);slideshow_back_img.opacity=1;slideshow_back_burns.apply(slideshow_back_img,slideshow_n);cacophony.canvas.append(slideshow_back_img);slideshow_step()}_e.slideshow=slideshow;var datafeed_map_colours=["#7E2D95","#E65008","#5b6c03","#9d3e62","#278699","#cc0101","#ffd800"],datafeed_headlines_items=[],datafeed_headlines_cur=0,datafeed_headlines_duration=4,datafeed_headlines_limit=false,datafeed_headlines_last_y=false;function datafeed_slideshow(e){var d=cacophony.datafeed[e.url];var a=d.childNodes[0].getElementsByTagName("content");e.images=[];for(var b=0;b<a.length;b++){if(e.limit&&b==e.limit){break}e.images[b]=a[b].getAttribute("url")}slideshow(e)}function datafeed_headlines(d){if(d){var b=cacophony.datafeed[d.url];datafeed_headlines_items=b.childNodes[0].getElementsByTagName("item");datafeed_headlines_cur=0;datafeed_headlines_duration=(d.duration)?d.duration:4;datafeed_headlines_limit=(d.limit)?d.limit:false;datafeed_headlines_last_y=false;datafeed_headlines_colour=(d.colour)?d.colour:"rgba(102, 102, 102, 1.0)"}if(!cacophony.playing){setTimeout(datafeed_headlines,cacophony.beatLength()*datafeed_headlines_duration);return}if(datafeed_headlines_limit&&datafeed_headlines_limit<=datafeed_headlines_cur){return}if(datafeed_headlines_items[datafeed_headlines_cur]){var a=$(datafeed_headlines_items[datafeed_headlines_cur]).find("title")[0].textContent;if(!datafeed_headlines_last_y||datafeed_headlines_last_y>(cacophony.height/2)){datafeed_headlines_last_y=5+Math.round(Math.random()*((cacophony.height/2)-5))}else{datafeed_headlines_last_y=(cacophony.height/2)+Math.round(Math.random()*(cacophony.height/2))}lyrics({txt:a,x:Math.random()*(cacophony.width/4),y:datafeed_headlines_last_y,colour:datafeed_headlines_colour});datafeed_headlines_cur++;setTimeout(datafeed_headlines,cacophony.beatLength()*datafeed_headlines_duration)}}function datafeed_map_on(j){var o,k,p,m,n,g,q,e,l,a,b;o=cacophony.datafeed[j.url];k=document.createElement("div");k.setAttribute("style","width: "+(cacophony.width-40)+"px; height: "+(cacophony.height-100)+"px");p=(j.zoom)?j.zoom:2;m=(j.lat)?j.lat:1;n=(j.lng)?j.lng:0;g=new google.maps.LatLng(m,n);q={zoom:p,center:g,mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:false,backgroundColor:"transparent",draggable:false,scrollwheel:false,scaleControl:false,navigationControl:false,streetViewControl:false};e=new google.maps.Map(k,q);for(var h=0;h<o.length;h++){l=datafeed_map_colour();a={center:new google.maps.LatLng(o[h].lat,o[h].lng),fillColor:l,fillOpacity:1,clickable:false,map:e,radius:o[h].count*10000,strokeColor:l,strokeOpacity:1,strokeWeight:1,zIndex:100};b=new google.maps.Circle(a);b.setMap(e)}cacophony.html(k,30,20)}function datafeed_map_off(){cacophony.html()}function datafeed_map_colour(){return datafeed_map_colours[Math.floor(Math.random()*datafeed_map_colours.length)]}_e.datafeed_slideshow=datafeed_slideshow;_e.datafeed_headlines=datafeed_headlines;_e.datafeed_map_on=datafeed_map_on;_e.datafeed_map_off=datafeed_map_off;var flicker_img,panel1,panel2,panel3,panel4,panel_timeout=false,panel_dur=100,seq=[],seq_img=false,seq_dur=100,f=false,flicker_layers=false,flicker_auto=false,flicker_auto_direction="right";function flicker(b){var a=(b.duration)?cacophony.beatLength()*b.duration:cacophony.beatLength()*0.375;if(!cacophony.playing){setTimeout(flicker,a);return}if(flicker_img){cacophony.canvas.remove(flicker_img);flicker_img=false;return}if(!b){return}flicker_img=new ImageNode(_i[b.img]);flicker_img.x=0;flicker_img.y=0;flicker_img.dWidth=cacophony.width;flicker_img.dHeight=cacophony.height;cacophony.canvas.append(flicker_img);setTimeout(flicker,a)}function flicker_parallax(g){if(flicker_layers){for(var d=flicker_layers.length;d>0;d--){cacophony.canvas.remove(flicker_layers[d-1])}flicker_layers=false;return}var b,a,e;b=cacophony.width/2;a=cacophony.height/2;flicker_layers=[];for(var d=0;d<g.layers.length;d++){flicker_layers[d]=new ImageNode(_i[g.layers[d]]);flicker_layers[d].x=b-(flicker_layers[d].image.width/2);flicker_layers[d].y=a-(flicker_layers[d].image.height/2);flicker_layers[d].origx=flicker_layers[d].x;flicker_layers[d].origy=flicker_layers[d].y;flicker_layers[d].maxx=flicker_layers[d].origx-flicker_layers[d].origx;flicker_layers[d].maxy=cacophony.height/10-((g.layers.length-d)*4);flicker_layers[d].minx=flicker_layers[d].origx+flicker_layers[d].origx;flicker_layers[d].miny=0;flicker_layers[d].y=flicker_layers[d].maxy;cacophony.canvas.append(flicker_layers[d])}e=(g.duration)?cacophony.beatLength()*g.duration:cacophony.beatLength();setTimeout(flicker_parallax,e);if(g.auto){flicker_auto=true;if(g.direction){flicker_auto_direction=g.direction}else{flicker_auto_direction="right"}setTimeout(flicker_parallax_update,65)}else{flicker_auto=false}}function flicker_parallax_update(a){if(a!==true){if(!cacophony.playing){setTimeout(flicker_parallax_update,65);return}if(flicker_layers.length>0){for(var e=0;e<flicker_layers.length;e++){if(flicker_auto_direction=="right"){var h=flicker_layers[e].x+(((e+1)*2)/2);if(h<flicker_layers[e].maxx){flicker_layers[e].x=h}}else{var h=flicker_layers[e].x-(((e+1)*2)/2);if(h>flicker_layers[e].minx){flicker_layers[e].x=h}}}setTimeout(flicker_parallax_update,65)}return}var d,b;d=cacophony.width/2;b=cacophony.height/2;for(var e=0;e<flicker_layers.length;e++){var h,g;h=(flicker_layers[e].origx-cacophony.mousex)/(flicker_layers.length-e)/2;g=flicker_layers[e].maxy-(((cacophony.mousey/cacophony.height)*e)*10);if(h>=flicker_layers[e].minx&&h<=flicker_layers[e].maxx){flicker_layers[e].x=h}if(g>=flicker_layers[e].miny&&g<=flicker_layers[e].maxy){flicker_layers[e].y=g}}}cacophony.mousemove(function(){if(!flicker_layers||flicker_auto){return}flicker_parallax_update(true)});function flicker_panels(a){if(panel_timeout){clearTimeout(panel_timeout)}if(panel1){cacophony.canvas.remove(panel1);cacophony.canvas.remove(panel2);cacophony.canvas.remove(panel3);cacophony.canvas.remove(panel4)}panel1=new ImageNode(_i[a.images[0]]);panel1.x=0;panel1.y=0;panel1.dWidth=cacophony.width/2;panel1.dHeight=cacophony.height/2;cacophony.canvas.append(panel1);panel2=new ImageNode(_i[a.images[1]]);panel2.x=cacophony.width/2;panel2.y=0;panel2.dWidth=cacophony.width/2;panel2.dHeight=cacophony.height/2;cacophony.canvas.append(panel2);panel3=new ImageNode(_i[a.images[2]]);panel3.x=0;panel3.y=cacophony.height/2;panel3.dWidth=cacophony.width/2;panel3.dHeight=cacophony.height/2;cacophony.canvas.append(panel3);panel4=new ImageNode(_i[a.images[3]]);panel4.x=cacophony.width/2;panel4.y=cacophony.height/2;panel4.dWidth=cacophony.width/2;panel4.dHeight=cacophony.height/2;cacophony.canvas.append(panel4);panel_dur=(a.duration)?cacophony.beatLength()*a.duration:cacophony.beatLength()*0.375;panel_timeout=setTimeout(four_panel_clear,panel_dur)}function four_panel_clear(){if(!cacophony.playing){panel_timeout=setTimeout(four_panel_clear,panel_dur);return}if(panel1){cacophony.canvas.remove(panel1);cacophony.canvas.remove(panel2);cacophony.canvas.remove(panel3);cacophony.canvas.remove(panel4);panel1=false;panel2=false;panel3=false;panel4=false}}function flicker_sequence(a){if(a){seq_dur=(a.duration)?cacophony.beatLength()*a.duration:cacophony.beatLength()*0.375;seq=a.images}if(!cacophony.playing){setTimeout("flicker_sequence ();",seq_dur);return}if(seq_img){cacophony.canvas.remove(seq_img);seq_img=false}if(seq.length>0){img=seq.shift();seq_img=new ImageNode(_i[img]);seq_img.x=0;seq_img.y=0;seq_img.dWidth=cacophony.width;seq_img.dHeight=cacophony.height;cacophony.canvas.append(seq_img);setTimeout("flicker_sequence ();",seq_dur)}}_e.flicker=flicker;_e.flicker_panels=flicker_panels;_e.flicker_sequence=flicker_sequence;_e.flicker_parallax=flicker_parallax;var volume_fade_to=0.1,volume_fade_amt=0.1,volume_fade_dur=0.1;function set_volume(a){cacophony.setVolume(a)}function volume_fade(a){if(a){volume_fade_dur=(a.duration)?cacophony.beatLength()*a.duration:cacophony.beatLength();volume_fade_to=a.to;volume_fade_amt=(cacophony.getVolume()-a.to)/10}if(!cacophony.playing){setTimeout(volume_fade,volume_fade_dur/10);return}cacophony.setVolume(cacophony.getVolume()-volume_fade_amt);if(Math.round(cacophony.getVolume()*100)!=(volume_fade_to*100)){setTimeout(volume_fade,volume_fade_dur/10)}}_e.set_volume=set_volume;_e.volume_fade=volume_fade;cacophony.addInterval(skyline,25);var colours=["#eee","#ddd","#ddd","#ccc","#ccc","#bbb","#bbb","#bbb","#aaa","#aaa","#aaa","#aaa","#999","#999","#999","#999","#999"],bottom=[],bottom2=[],skyline1=[],skyline2=[],skyline3=[],windows=[],skyline_state=false,skyline_initialized=false;function skyline_init(){var b;for(var a=0;a<256;a+=2){b=new Rectangle(cacophony.w*2,180);b.x=cacophony.w*a;b.y=cacophony.height;b.fill="rgba(51, 51, 51, 0.1)";skyline3[a]=b;cacophony.canvas.append(skyline3[a]);b=new Rectangle(cacophony.w*2,180);b.x=cacophony.w*a;b.y=cacophony.height;b.fill="rgba(51, 51, 51, 0.3)";skyline2[a]=b;cacophony.canvas.append(skyline2[a]);b=new Rectangle(cacophony.w*2,180);b.x=cacophony.w*a;b.y=cacophony.height;b.fill="rgba(51, 51, 51, 1.0)";skyline1[a]=b;cacophony.canvas.append(skyline1[a])}skyline_initialized=true}function skyline_on(){skyline_state=true;if(!skyline_initialized){skyline_init()}}function skyline_off(){skyline_state=false;for(var a=0;a<windows.length;a++){cacophony.canvas.remove(windows[a])}windows=[];for(var a=0;a<256;a+=2){skyline1[a].y=cacophony.height;skyline2[a].y=cacophony.height;skyline3[a].y=cacophony.height}}function skyline(){if(!skyline_state){return false}var a,g,e;for(var b=0;b<windows.length;b++){cacophony.canvas.remove(windows[b])}windows=[];for(var b=0;b<256;b+=2){var a=Math.abs(((32-(cacophony.scale+Math.ceil(cacophony.eq[b]*cacophony.scale)))*4));if(a>180){a=180}skyline3[b].y=cacophony.height-bottom2[b];bottom2[b]=0;skyline2[b].y=cacophony.height-bottom[b];bottom2[b]=bottom[b];skyline1[b].y=cacophony.height-a;bottom[b]=a;for(var d=cacophony.height-a+2;d<cacophony.height;d+=5){g=window_colour();if(g!="#999"){e=new Rectangle(3,3);e.x=(cacophony.w*b)+2;e.y=d;e.fill=g;windows.push(e);cacophony.canvas.append(e)}g=window_colour();if(g!="#999"){e=new Rectangle(3,3);e.x=(cacophony.w*b)+7;e.y=d;e.fill=g;windows.push(e);cacophony.canvas.append(e)}}}}function window_colour(){return colours[Math.floor(Math.random()*colours.length)]}_e.skyline_on=skyline_on;_e.skyline_off=skyline_off;var circles_state=false,circle=[],circle_fill="#eee",circle_max_dist=cacophony.dist(0,0,400,400);function circles_on(a){circles_state=true;if(a&&a.fill){circle_fill=a.fill}else{circle_fill="#eee"}}function circles_off(){circles_state=false;for(var a=0;a<circle.length;a++){circle[a].radius=0}circle=[]}function circles(){x=0;for(var b=177;b<=677;b+=20){for(var a=40;a<=440;a+=20){size=cacophony.dist(cacophony.mousex,cacophony.mousey,b,a);size=size/circle_max_dist*66;if(circle[x]){circle[x].radius=size}else{c=new Circle(size);c.x=b;c.y=a;c.fill=circle_fill;circle[x]=c;cacophony.canvas.append(circle[x])}x++}}}cacophony.mousemove(function(){if(!circles_state){return}circles()});_e.circles_on=circles_on;_e.circles_off=circles_off;var sparkles=[],sparkles_interval=false;function sparkles_on(d){var b=(d&&d.num)?d.num:50;for(var a=0;a<b;a++){sparkles[a]=sparkles_create();cacophony.canvas.append(sparkles[a])}sparkles_interval=cacophony.addInterval(sparkles_update,25)}function sparkles_off(b){cacophony.removeInterval(sparkles_interval);sparkles_interval=false;for(var a=0;a<sparkles.length;a++){cacophony.canvas.remove(sparkles[a])}sparkles=[]}function sparkles_rand(d,a,b){var e=d+(Math.random()*(a-d));return(b)?Math.round(e):e}function sparkles_create(){var a=new Circle(sparkles_rand(1,5));a.x=cacophony.width/2+sparkles_rand(-50,50);a.y=cacophony.height/2+sparkles_rand(-50,50);a._opacity=Math.random();a.fill="rgba(255,255,255,"+a._opacity+")";a._dir=[sparkles_rand(-2.5,2.5),sparkles_rand(-2.5,2.5)];a._dir[0]=(a._dir[0])?a._dir[0]:-1;a._dir[1]=(a._dir[1])?a._dir[1]:1;return a}function sparkles_update(){var a=0,d=0;for(var b=0;b<sparkles.length;b++){a=sparkles_rand(-0.1,0.1);if(sparkles[b].radius+a>0&&sparkles[b].radius+a<=5){sparkles[b].radius+=a}d=sparkles_rand(-0.1,0.1);if(sparkles[b]._opacity+d>0.2&&sparkles[b]._opacity+d<=1){sparkles[b]._opacity+=d}sparkles[b].fill="rgba(255,255,255,"+sparkles[b]._opacity+")";if(sparkles[b]._dir[0]<0){if(sparkles[b].x<1){sparkles[b]._dir[0]=Math.abs(sparkles[b]._dir[0])+1}else{if(sparkles[b]._dir[0]<-1){sparkles[b]._dir[0]+=0.05}}}else{if(sparkles[b]._dir[0]>0){if(sparkles[b].x>cacophony.width){sparkles[b]._dir[0]=(sparkles[b]._dir[0]*-1)-1}else{if(sparkles[b]._dir>1){sparkles[b]._dir[0]-=0.05}}}}if(sparkles[b]._dir[1]<0){if(sparkles[b].y<1){sparkles[b]._dir[1]=Math.abs(sparkles[b]._dir[1])+1}else{if(sparkles[b]._dir[1]<-1){sparkles[b]._dir[1]+=0.05}}}else{if(sparkles[b]._dir[1]>0){if(sparkles[b].y>cacophony.height){sparkles[b]._dir[1]=(sparkles[b]._dir[1]*-1)-1}else{if(sparkles[b]._dir>1){sparkles[b]._dir[1]-=0.05}}}}sparkles[b].x+=sparkles[b]._dir[0];sparkles[b].y+=sparkles[b]._dir[1]}}function sparkles_react(a){if(cacophony.mousex>sparkles[a].x&&sparkles[a]._dir[0]>0){sparkles[a]._dir[0]=(sparkles[a]._dir[0]*-1)-1}else{if(cacophony.mousex<sparkles[a].x&&sparkles[a]._dir[0]<0){sparkles[a]._dir[0]=Math.abs(sparkles[a]._dir[0])+1}}if(cacophony.mousey>sparkles[a].y&&sparkles[a]._dir[1]>0){sparkles[a]._dir[1]=(sparkles[a]._dir[1]*-1)-1}else{if(cacophony.mousey<sparkles[a].y&&sparkles[a]._dir[1]<0){sparkles[a]._dir[1]=Math.abs(sparkles[a]._dir[1])+1}}}function sparkles_mousemove(){for(var a=0;a<sparkles.length;a++){if(cacophony.dist(sparkles[a].x,sparkles[a].y,cacophony.mousex,cacophony.mousey)<=25){sparkles_react(a)}}}cacophony.mousemove(function(){if(sparkles_interval===false){return}sparkles_mousemove()});_e.sparkles_on=sparkles_on;_e.sparkles_off=sparkles_off;var three_camera,three_scene,three_renderer,three_func,three_args,three_int,three_is_on;function three_on(a){func=a.func;three_args=a;three_is_on=true;three_func=func;cacophony.visible([0,0,0,0,1,0]);if(!three_camera){three_camera=new THREE.Camera(75,cacophony.width/cacophony.height,1,10000);three_camera.position.z=1000;three_scene=new THREE.Scene();three_renderer=new THREE.CanvasRenderer();three_renderer.setSize(cacophony.width,cacophony.height);$("#cacophony-canvas4").append(three_renderer.domElement)}three_int=setInterval(three_loop,1000/60)}function three_demo(b){for(var a=0;a<1000;a++){var d=new THREE.Particle(new THREE.ParticleCircleMaterial(Math.random()*8421384+8421504,1));d.position.x=Math.random()*2000-1000;d.position.y=Math.random()*2000-1000;d.position.z=Math.random()*2000-1000;d.scale.x=d.scale.y=Math.random()*10+5;three_scene.addObject(d)}}function three_loop(){if(!cacophony.playing){return}three_func(three_args);three_renderer.render(three_scene,three_camera)}function three_off(){three_is_on=false;clearInterval(three_int);cacophony.visible([1,1,0,0,0,0])}_e.three_on=three_on;_e.three_off=three_off;var three_c,three_last_y,three_last_dir=1.5;function three_cube(b){if(!three_c){var d,e;d=(b.colour)?b.colour:[0.2,0.2,0.25,1];e=new Cube(800,600,800);for(var a=0;a<e.faces.length;a++){e.faces[a].color.setRGBA(d[0],d[1],d[2],d[3])}three_c=new THREE.Mesh(e,new THREE.MeshFaceColorFillMaterial());three_scene.addObject(three_c);three_last_y=three_c.rotation.y}else{if(three_c.rotation.y==three_last_y){three_c.rotation.y+=0.01*three_last_dir;three_last_y=three_c.rotation.y}}}cacophony.mousemove(function(){if(!three_is_on||!three_c){return}var a;if(cacophony.mousex<cacophony.width/2){a=cacophony.width/2-cacophony.mousex;three_c.rotation.y-=a*0.0003;three_last_dir=-1.5}else{a=cacophony.mousex-cacophony.width/2;three_c.rotation.y+=a*0.0003;three_last_dir=1.5}three_last_y=three_c.rotation.y});